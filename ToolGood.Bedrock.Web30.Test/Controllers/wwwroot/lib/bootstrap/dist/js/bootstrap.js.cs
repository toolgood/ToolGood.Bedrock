using Microsoft.AspNetCore.Mvc;
using System;
namespace ToolGood.WwwRoot.Test
{
    public partial class WwwRootController : Controller
    {
        [HttpGet("lib/bootstrap/dist/js/bootstrap.js")]
        public IActionResult lib_bootstrap_dist_js_bootstrap_js()
        {
            if (Request.Headers["If-None-Match"]  == "F2BE2EA37CD06B1A4F0CF1DC42890FA3") {
                Response.Headers["Expires"] = DateTime.Now.AddYears(100).ToString("r");
                return StatusCode(304);
            }
            Response.Headers["Cache-Control"] = "max-age=315360000";
            Response.Headers["Etag"] = "F2BE2EA37CD06B1A4F0CF1DC42890FA3";
            Response.Headers["Date"] = DateTime.Now.ToString("r");
            Response.Headers["Expires"] = DateTime.Now.AddYears(100).ToString("r");
            const string s = "LyohDQogICogQm9vdHN0cmFwIHY0LjEuMyAoaHR0cHM6Ly9nZXRib290c3RyYXAuY29tLykNCiAgKiBDb3B5cmlnaHQgMjAxMS0yMDE4IFRoZSBCb290c3RyYXAgQXV0aG9ycyAoaHR0cHM6Ly9naXRodWIuY29tL3R3YnMvYm9vdHN0cmFwL2dyYXBocy9jb250cmlidXRvcnMpDQogICogTGljZW5zZWQgdW5kZXIgTUlUIChodHRwczovL2dpdGh1Yi5jb20vdHdicy9ib290c3RyYXAvYmxvYi9tYXN0ZXIvTElDRU5TRSkNCiAgKi8NCihmdW5jdGlvbiAoZ2xvYmFsLCBmYWN0b3J5KSB7DQogIHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyA/IGZhY3RvcnkoZXhwb3J0cywgcmVxdWlyZSgnanF1ZXJ5JyksIHJlcXVpcmUoJ3BvcHBlci5qcycpKSA6DQogIHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCA/IGRlZmluZShbJ2V4cG9ydHMnLCAnanF1ZXJ5JywgJ3BvcHBlci5qcyddLCBmYWN0b3J5KSA6DQogIChmYWN0b3J5KChnbG9iYWwuYm9vdHN0cmFwID0ge30pLGdsb2JhbC5qUXVlcnksZ2xvYmFsLlBvcHBlcikpOw0KfSh0aGlzLCAoZnVuY3Rpb24gKGV4cG9ydHMsJCxQb3BwZXIpIHsgJ3VzZSBzdHJpY3QnOw0KDQogICQgPSAkICYmICQuaGFzT3duUHJvcGVydHkoJ2RlZmF1bHQnKSA/ICRbJ2RlZmF1bHQnXSA6ICQ7DQogIFBvcHBlciA9IFBvcHBlciAmJiBQb3BwZXIuaGFzT3duUHJvcGVydHkoJ2RlZmF1bHQnKSA/IFBvcHBlclsnZGVmYXVsdCddIDogUG9wcGVyOw0KDQogIGZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsNCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7DQogICAgICB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOw0KICAgICAgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOw0KICAgICAgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOw0KICAgICAgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7DQogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7DQogICAgfQ0KICB9DQoNCiAgZnVuY3Rpb24gX2NyZWF0ZUNsYXNzKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgew0KICAgIGlmIChwcm90b1Byb3BzKSBfZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOw0KICAgIGlmIChzdGF0aWNQcm9wcykgX2RlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsNCiAgICByZXR1cm4gQ29uc3RydWN0b3I7DQogIH0NCg0KICBmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHZhbHVlKSB7DQogICAgaWYgKGtleSBpbiBvYmopIHsNCiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgew0KICAgICAgICB2YWx1ZTogdmFsdWUsDQogICAgICAgIGVudW1lcmFibGU6IHRydWUsDQogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwNCiAgICAgICAgd3JpdGFibGU6IHRydWUNCiAgICAgIH0pOw0KICAgIH0gZWxzZSB7DQogICAgICBvYmpba2V5XSA9IHZhbHVlOw0KICAgIH0NCg0KICAgIHJldHVybiBvYmo7DQogIH0NCg0KICBmdW5jdGlvbiBfb2JqZWN0U3ByZWFkKHRhcmdldCkgew0KICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7DQogICAgICB2YXIgc291cmNlID0gYXJndW1lbnRzW2ldICE9IG51bGwgPyBhcmd1bWVudHNbaV0gOiB7fTsNCiAgICAgIHZhciBvd25LZXlzID0gT2JqZWN0LmtleXMoc291cmNlKTsNCg0KICAgICAgaWYgKHR5cGVvZiBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzID09PSAnZnVuY3Rpb24nKSB7DQogICAgICAgIG93bktleXMgPSBvd25LZXlzLmNvbmNhdChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKHNvdXJjZSkuZmlsdGVyKGZ1bmN0aW9uIChzeW0pIHsNCiAgICAgICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihzb3VyY2UsIHN5bSkuZW51bWVyYWJsZTsNCiAgICAgICAgfSkpOw0KICAgICAgfQ0KDQogICAgICBvd25LZXlzLmZvckVhY2goZnVuY3Rpb24gKGtleSkgew0KICAgICAgICBfZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHNvdXJjZVtrZXldKTsNCiAgICAgIH0pOw0KICAgIH0NCg0KICAgIHJldHVybiB0YXJnZXQ7DQogIH0NCg0KICBmdW5jdGlvbiBfaW5oZXJpdHNMb29zZShzdWJDbGFzcywgc3VwZXJDbGFzcykgew0KICAgIHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcy5wcm90b3R5cGUpOw0KICAgIHN1YkNsYXNzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IHN1YkNsYXNzOw0KICAgIHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7DQogIH0NCg0KICAvKioNCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICogQm9vdHN0cmFwICh2NC4xLjMpOiB1dGlsLmpzDQogICAqIExpY2Vuc2VkIHVuZGVyIE1JVCAoaHR0cHM6Ly9naXRodWIuY29tL3R3YnMvYm9vdHN0cmFwL2Jsb2IvbWFzdGVyL0xJQ0VOU0UpDQogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAqLw0KDQogIHZhciBVdGlsID0gZnVuY3Rpb24gKCQkJDEpIHsNCiAgICAvKioNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKiBQcml2YXRlIFRyYW5zaXRpb25FbmQgSGVscGVycw0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqLw0KICAgIHZhciBUUkFOU0lUSU9OX0VORCA9ICd0cmFuc2l0aW9uZW5kJzsNCiAgICB2YXIgTUFYX1VJRCA9IDEwMDAwMDA7DQogICAgdmFyIE1JTExJU0VDT05EU19NVUxUSVBMSUVSID0gMTAwMDsgLy8gU2hvdXRvdXQgQW5ndXNDcm9sbCAoaHR0cHM6Ly9nb28uZ2wvcHh3UUdwKQ0KDQogICAgZnVuY3Rpb24gdG9UeXBlKG9iaikgew0KICAgICAgcmV0dXJuIHt9LnRvU3RyaW5nLmNhbGwob2JqKS5tYXRjaCgvXHMoW2Etel0rKS9pKVsxXS50b0xvd2VyQ2FzZSgpOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGdldFNwZWNpYWxUcmFuc2l0aW9uRW5kRXZlbnQoKSB7DQogICAgICByZXR1cm4gew0KICAgICAgICBiaW5kVHlwZTogVFJBTlNJVElPTl9FTkQsDQogICAgICAgIGRlbGVnYXRlVHlwZTogVFJBTlNJVElPTl9FTkQsDQogICAgICAgIGhhbmRsZTogZnVuY3Rpb24gaGFuZGxlKGV2ZW50KSB7DQogICAgICAgICAgaWYgKCQkJDEoZXZlbnQudGFyZ2V0KS5pcyh0aGlzKSkgew0KICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmhhbmRsZU9iai5oYW5kbGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJlZmVyLXJlc3QtcGFyYW1zDQogICAgICAgICAgfQ0KDQogICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11bmRlZmluZWQNCiAgICAgICAgfQ0KICAgICAgfTsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiB0cmFuc2l0aW9uRW5kRW11bGF0b3IoZHVyYXRpb24pIHsNCiAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQoNCiAgICAgIHZhciBjYWxsZWQgPSBmYWxzZTsNCiAgICAgICQkJDEodGhpcykub25lKFV0aWwuVFJBTlNJVElPTl9FTkQsIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgY2FsbGVkID0gdHJ1ZTsNCiAgICAgIH0pOw0KICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICghY2FsbGVkKSB7DQogICAgICAgICAgVXRpbC50cmlnZ2VyVHJhbnNpdGlvbkVuZChfdGhpcyk7DQogICAgICAgIH0NCiAgICAgIH0sIGR1cmF0aW9uKTsNCiAgICAgIHJldHVybiB0aGlzOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIHNldFRyYW5zaXRpb25FbmRTdXBwb3J0KCkgew0KICAgICAgJCQkMS5mbi5lbXVsYXRlVHJhbnNpdGlvbkVuZCA9IHRyYW5zaXRpb25FbmRFbXVsYXRvcjsNCiAgICAgICQkJDEuZXZlbnQuc3BlY2lhbFtVdGlsLlRSQU5TSVRJT05fRU5EXSA9IGdldFNwZWNpYWxUcmFuc2l0aW9uRW5kRXZlbnQoKTsNCiAgICB9DQogICAgLyoqDQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKiBQdWJsaWMgVXRpbCBBcGkNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqLw0KDQoNCiAgICB2YXIgVXRpbCA9IHsNCiAgICAgIFRSQU5TSVRJT05fRU5EOiAnYnNUcmFuc2l0aW9uRW5kJywNCiAgICAgIGdldFVJRDogZnVuY3Rpb24gZ2V0VUlEKHByZWZpeCkgew0KICAgICAgICBkbyB7DQogICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWJpdHdpc2UNCiAgICAgICAgICBwcmVmaXggKz0gfn4oTWF0aC5yYW5kb20oKSAqIE1BWF9VSUQpOyAvLyAifn4iIGFjdHMgbGlrZSBhIGZhc3RlciBNYXRoLmZsb29yKCkgaGVyZQ0KICAgICAgICB9IHdoaWxlIChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChwcmVmaXgpKTsNCg0KICAgICAgICByZXR1cm4gcHJlZml4Ow0KICAgICAgfSwNCiAgICAgIGdldFNlbGVjdG9yRnJvbUVsZW1lbnQ6IGZ1bmN0aW9uIGdldFNlbGVjdG9yRnJvbUVsZW1lbnQoZWxlbWVudCkgew0KICAgICAgICB2YXIgc2VsZWN0b3IgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS10YXJnZXQnKTsNCg0KICAgICAgICBpZiAoIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSAnIycpIHsNCiAgICAgICAgICBzZWxlY3RvciA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdocmVmJykgfHwgJyc7DQogICAgICAgIH0NCg0KICAgICAgICB0cnkgew0KICAgICAgICAgIHJldHVybiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKSA/IHNlbGVjdG9yIDogbnVsbDsNCiAgICAgICAgfSBjYXRjaCAoZXJyKSB7DQogICAgICAgICAgcmV0dXJuIG51bGw7DQogICAgICAgIH0NCiAgICAgIH0sDQogICAgICBnZXRUcmFuc2l0aW9uRHVyYXRpb25Gcm9tRWxlbWVudDogZnVuY3Rpb24gZ2V0VHJhbnNpdGlvbkR1cmF0aW9uRnJvbUVsZW1lbnQoZWxlbWVudCkgew0KICAgICAgICBpZiAoIWVsZW1lbnQpIHsNCiAgICAgICAgICByZXR1cm4gMDsNCiAgICAgICAgfSAvLyBHZXQgdHJhbnNpdGlvbi1kdXJhdGlvbiBvZiB0aGUgZWxlbWVudA0KDQoNCiAgICAgICAgdmFyIHRyYW5zaXRpb25EdXJhdGlvbiA9ICQkJDEoZWxlbWVudCkuY3NzKCd0cmFuc2l0aW9uLWR1cmF0aW9uJyk7DQogICAgICAgIHZhciBmbG9hdFRyYW5zaXRpb25EdXJhdGlvbiA9IHBhcnNlRmxvYXQodHJhbnNpdGlvbkR1cmF0aW9uKTsgLy8gUmV0dXJuIDAgaWYgZWxlbWVudCBvciB0cmFuc2l0aW9uIGR1cmF0aW9uIGlzIG5vdCBmb3VuZA0KDQogICAgICAgIGlmICghZmxvYXRUcmFuc2l0aW9uRHVyYXRpb24pIHsNCiAgICAgICAgICByZXR1cm4gMDsNCiAgICAgICAgfSAvLyBJZiBtdWx0aXBsZSBkdXJhdGlvbnMgYXJlIGRlZmluZWQsIHRha2UgdGhlIGZpcnN0DQoNCg0KICAgICAgICB0cmFuc2l0aW9uRHVyYXRpb24gPSB0cmFuc2l0aW9uRHVyYXRpb24uc3BsaXQoJywnKVswXTsNCiAgICAgICAgcmV0dXJuIHBhcnNlRmxvYXQodHJhbnNpdGlvbkR1cmF0aW9uKSAqIE1JTExJU0VDT05EU19NVUxUSVBMSUVSOw0KICAgICAgfSwNCiAgICAgIHJlZmxvdzogZnVuY3Rpb24gcmVmbG93KGVsZW1lbnQpIHsNCiAgICAgICAgcmV0dXJuIGVsZW1lbnQub2Zmc2V0SGVpZ2h0Ow0KICAgICAgfSwNCiAgICAgIHRyaWdnZXJUcmFuc2l0aW9uRW5kOiBmdW5jdGlvbiB0cmlnZ2VyVHJhbnNpdGlvbkVuZChlbGVtZW50KSB7DQogICAgICAgICQkJDEoZWxlbWVudCkudHJpZ2dlcihUUkFOU0lUSU9OX0VORCk7DQogICAgICB9LA0KICAgICAgLy8gVE9ETzogUmVtb3ZlIGluIHY1DQogICAgICBzdXBwb3J0c1RyYW5zaXRpb25FbmQ6IGZ1bmN0aW9uIHN1cHBvcnRzVHJhbnNpdGlvbkVuZCgpIHsNCiAgICAgICAgcmV0dXJuIEJvb2xlYW4oVFJBTlNJVElPTl9FTkQpOw0KICAgICAgfSwNCiAgICAgIGlzRWxlbWVudDogZnVuY3Rpb24gaXNFbGVtZW50KG9iaikgew0KICAgICAgICByZXR1cm4gKG9ialswXSB8fCBvYmopLm5vZGVUeXBlOw0KICAgICAgfSwNCiAgICAgIHR5cGVDaGVja0NvbmZpZzogZnVuY3Rpb24gdHlwZUNoZWNrQ29uZmlnKGNvbXBvbmVudE5hbWUsIGNvbmZpZywgY29uZmlnVHlwZXMpIHsNCiAgICAgICAgZm9yICh2YXIgcHJvcGVydHkgaW4gY29uZmlnVHlwZXMpIHsNCiAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZ1R5cGVzLCBwcm9wZXJ0eSkpIHsNCiAgICAgICAgICAgIHZhciBleHBlY3RlZFR5cGVzID0gY29uZmlnVHlwZXNbcHJvcGVydHldOw0KICAgICAgICAgICAgdmFyIHZhbHVlID0gY29uZmlnW3Byb3BlcnR5XTsNCiAgICAgICAgICAgIHZhciB2YWx1ZVR5cGUgPSB2YWx1ZSAmJiBVdGlsLmlzRWxlbWVudCh2YWx1ZSkgPyAnZWxlbWVudCcgOiB0b1R5cGUodmFsdWUpOw0KDQogICAgICAgICAgICBpZiAoIW5ldyBSZWdFeHAoZXhwZWN0ZWRUeXBlcykudGVzdCh2YWx1ZVR5cGUpKSB7DQogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihjb21wb25lbnROYW1lLnRvVXBwZXJDYXNlKCkgKyAiOiAiICsgKCJPcHRpb24gXCIiICsgcHJvcGVydHkgKyAiXCIgcHJvdmlkZWQgdHlwZSBcIiIgKyB2YWx1ZVR5cGUgKyAiXCIgIikgKyAoImJ1dCBleHBlY3RlZCB0eXBlIFwiIiArIGV4cGVjdGVkVHlwZXMgKyAiXCIuIikpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH07DQogICAgc2V0VHJhbnNpdGlvbkVuZFN1cHBvcnQoKTsNCiAgICByZXR1cm4gVXRpbDsNCiAgfSgkKTsNCg0KICAvKioNCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICogQm9vdHN0cmFwICh2NC4xLjMpOiBhbGVydC5qcw0KICAgKiBMaWNlbnNlZCB1bmRlciBNSVQgKGh0dHBzOi8vZ2l0aHViLmNvbS90d2JzL2Jvb3RzdHJhcC9ibG9iL21hc3Rlci9MSUNFTlNFKQ0KICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgKi8NCg0KICB2YXIgQWxlcnQgPSBmdW5jdGlvbiAoJCQkMSkgew0KICAgIC8qKg0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqIENvbnN0YW50cw0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqLw0KICAgIHZhciBOQU1FID0gJ2FsZXJ0JzsNCiAgICB2YXIgVkVSU0lPTiA9ICc0LjEuMyc7DQogICAgdmFyIERBVEFfS0VZID0gJ2JzLmFsZXJ0JzsNCiAgICB2YXIgRVZFTlRfS0VZID0gIi4iICsgREFUQV9LRVk7DQogICAgdmFyIERBVEFfQVBJX0tFWSA9ICcuZGF0YS1hcGknOw0KICAgIHZhciBKUVVFUllfTk9fQ09ORkxJQ1QgPSAkJCQxLmZuW05BTUVdOw0KICAgIHZhciBTZWxlY3RvciA9IHsNCiAgICAgIERJU01JU1M6ICdbZGF0YS1kaXNtaXNzPSJhbGVydCJdJw0KICAgIH07DQogICAgdmFyIEV2ZW50ID0gew0KICAgICAgQ0xPU0U6ICJjbG9zZSIgKyBFVkVOVF9LRVksDQogICAgICBDTE9TRUQ6ICJjbG9zZWQiICsgRVZFTlRfS0VZLA0KICAgICAgQ0xJQ0tfREFUQV9BUEk6ICJjbGljayIgKyBFVkVOVF9LRVkgKyBEQVRBX0FQSV9LRVkNCiAgICB9Ow0KICAgIHZhciBDbGFzc05hbWUgPSB7DQogICAgICBBTEVSVDogJ2FsZXJ0JywNCiAgICAgIEZBREU6ICdmYWRlJywNCiAgICAgIFNIT1c6ICdzaG93Jw0KICAgICAgLyoqDQogICAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgICAqIENsYXNzIERlZmluaXRpb24NCiAgICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAgICovDQoNCiAgICB9Ow0KDQogICAgdmFyIEFsZXJ0ID0NCiAgICAvKiNfX1BVUkVfXyovDQogICAgZnVuY3Rpb24gKCkgew0KICAgICAgZnVuY3Rpb24gQWxlcnQoZWxlbWVudCkgew0KICAgICAgICB0aGlzLl9lbGVtZW50ID0gZWxlbWVudDsNCiAgICAgIH0gLy8gR2V0dGVycw0KDQoNCiAgICAgIHZhciBfcHJvdG8gPSBBbGVydC5wcm90b3R5cGU7DQoNCiAgICAgIC8vIFB1YmxpYw0KICAgICAgX3Byb3RvLmNsb3NlID0gZnVuY3Rpb24gY2xvc2UoZWxlbWVudCkgew0KICAgICAgICB2YXIgcm9vdEVsZW1lbnQgPSB0aGlzLl9lbGVtZW50Ow0KDQogICAgICAgIGlmIChlbGVtZW50KSB7DQogICAgICAgICAgcm9vdEVsZW1lbnQgPSB0aGlzLl9nZXRSb290RWxlbWVudChlbGVtZW50KTsNCiAgICAgICAgfQ0KDQogICAgICAgIHZhciBjdXN0b21FdmVudCA9IHRoaXMuX3RyaWdnZXJDbG9zZUV2ZW50KHJvb3RFbGVtZW50KTsNCg0KICAgICAgICBpZiAoY3VzdG9tRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkpIHsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICB0aGlzLl9yZW1vdmVFbGVtZW50KHJvb3RFbGVtZW50KTsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5kaXNwb3NlID0gZnVuY3Rpb24gZGlzcG9zZSgpIHsNCiAgICAgICAgJCQkMS5yZW1vdmVEYXRhKHRoaXMuX2VsZW1lbnQsIERBVEFfS0VZKTsNCiAgICAgICAgdGhpcy5fZWxlbWVudCA9IG51bGw7DQogICAgICB9OyAvLyBQcml2YXRlDQoNCg0KICAgICAgX3Byb3RvLl9nZXRSb290RWxlbWVudCA9IGZ1bmN0aW9uIF9nZXRSb290RWxlbWVudChlbGVtZW50KSB7DQogICAgICAgIHZhciBzZWxlY3RvciA9IFV0aWwuZ2V0U2VsZWN0b3JGcm9tRWxlbWVudChlbGVtZW50KTsNCiAgICAgICAgdmFyIHBhcmVudCA9IGZhbHNlOw0KDQogICAgICAgIGlmIChzZWxlY3Rvcikgew0KICAgICAgICAgIHBhcmVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKCFwYXJlbnQpIHsNCiAgICAgICAgICBwYXJlbnQgPSAkJCQxKGVsZW1lbnQpLmNsb3Nlc3QoIi4iICsgQ2xhc3NOYW1lLkFMRVJUKVswXTsNCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiBwYXJlbnQ7DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uX3RyaWdnZXJDbG9zZUV2ZW50ID0gZnVuY3Rpb24gX3RyaWdnZXJDbG9zZUV2ZW50KGVsZW1lbnQpIHsNCiAgICAgICAgdmFyIGNsb3NlRXZlbnQgPSAkJCQxLkV2ZW50KEV2ZW50LkNMT1NFKTsNCiAgICAgICAgJCQkMShlbGVtZW50KS50cmlnZ2VyKGNsb3NlRXZlbnQpOw0KICAgICAgICByZXR1cm4gY2xvc2VFdmVudDsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5fcmVtb3ZlRWxlbWVudCA9IGZ1bmN0aW9uIF9yZW1vdmVFbGVtZW50KGVsZW1lbnQpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCg0KICAgICAgICAkJCQxKGVsZW1lbnQpLnJlbW92ZUNsYXNzKENsYXNzTmFtZS5TSE9XKTsNCg0KICAgICAgICBpZiAoISQkJDEoZWxlbWVudCkuaGFzQ2xhc3MoQ2xhc3NOYW1lLkZBREUpKSB7DQogICAgICAgICAgdGhpcy5fZGVzdHJveUVsZW1lbnQoZWxlbWVudCk7DQoNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICB2YXIgdHJhbnNpdGlvbkR1cmF0aW9uID0gVXRpbC5nZXRUcmFuc2l0aW9uRHVyYXRpb25Gcm9tRWxlbWVudChlbGVtZW50KTsNCiAgICAgICAgJCQkMShlbGVtZW50KS5vbmUoVXRpbC5UUkFOU0lUSU9OX0VORCwgZnVuY3Rpb24gKGV2ZW50KSB7DQogICAgICAgICAgcmV0dXJuIF90aGlzLl9kZXN0cm95RWxlbWVudChlbGVtZW50LCBldmVudCk7DQogICAgICAgIH0pLmVtdWxhdGVUcmFuc2l0aW9uRW5kKHRyYW5zaXRpb25EdXJhdGlvbik7DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uX2Rlc3Ryb3lFbGVtZW50ID0gZnVuY3Rpb24gX2Rlc3Ryb3lFbGVtZW50KGVsZW1lbnQpIHsNCiAgICAgICAgJCQkMShlbGVtZW50KS5kZXRhY2goKS50cmlnZ2VyKEV2ZW50LkNMT1NFRCkucmVtb3ZlKCk7DQogICAgICB9OyAvLyBTdGF0aWMNCg0KDQogICAgICBBbGVydC5falF1ZXJ5SW50ZXJmYWNlID0gZnVuY3Rpb24gX2pRdWVyeUludGVyZmFjZShjb25maWcpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7DQogICAgICAgICAgdmFyICRlbGVtZW50ID0gJCQkMSh0aGlzKTsNCiAgICAgICAgICB2YXIgZGF0YSA9ICRlbGVtZW50LmRhdGEoREFUQV9LRVkpOw0KDQogICAgICAgICAgaWYgKCFkYXRhKSB7DQogICAgICAgICAgICBkYXRhID0gbmV3IEFsZXJ0KHRoaXMpOw0KICAgICAgICAgICAgJGVsZW1lbnQuZGF0YShEQVRBX0tFWSwgZGF0YSk7DQogICAgICAgICAgfQ0KDQogICAgICAgICAgaWYgKGNvbmZpZyA9PT0gJ2Nsb3NlJykgew0KICAgICAgICAgICAgZGF0YVtjb25maWddKHRoaXMpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSk7DQogICAgICB9Ow0KDQogICAgICBBbGVydC5faGFuZGxlRGlzbWlzcyA9IGZ1bmN0aW9uIF9oYW5kbGVEaXNtaXNzKGFsZXJ0SW5zdGFuY2UpIHsNCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChldmVudCkgew0KICAgICAgICAgIGlmIChldmVudCkgew0KICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgICB9DQoNCiAgICAgICAgICBhbGVydEluc3RhbmNlLmNsb3NlKHRoaXMpOw0KICAgICAgICB9Ow0KICAgICAgfTsNCg0KICAgICAgX2NyZWF0ZUNsYXNzKEFsZXJ0LCBudWxsLCBbew0KICAgICAgICBrZXk6ICJWRVJTSU9OIiwNCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7DQogICAgICAgICAgcmV0dXJuIFZFUlNJT047DQogICAgICAgIH0NCiAgICAgIH1dKTsNCg0KICAgICAgcmV0dXJuIEFsZXJ0Ow0KICAgIH0oKTsNCiAgICAvKioNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKiBEYXRhIEFwaSBpbXBsZW1lbnRhdGlvbg0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqLw0KDQoNCiAgICAkJCQxKGRvY3VtZW50KS5vbihFdmVudC5DTElDS19EQVRBX0FQSSwgU2VsZWN0b3IuRElTTUlTUywgQWxlcnQuX2hhbmRsZURpc21pc3MobmV3IEFsZXJ0KCkpKTsNCiAgICAvKioNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKiBqUXVlcnkNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKi8NCg0KICAgICQkJDEuZm5bTkFNRV0gPSBBbGVydC5falF1ZXJ5SW50ZXJmYWNlOw0KICAgICQkJDEuZm5bTkFNRV0uQ29uc3RydWN0b3IgPSBBbGVydDsNCg0KICAgICQkJDEuZm5bTkFNRV0ubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICQkJDEuZm5bTkFNRV0gPSBKUVVFUllfTk9fQ09ORkxJQ1Q7DQogICAgICByZXR1cm4gQWxlcnQuX2pRdWVyeUludGVyZmFjZTsNCiAgICB9Ow0KDQogICAgcmV0dXJuIEFsZXJ0Ow0KICB9KCQpOw0KDQogIC8qKg0KICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgKiBCb290c3RyYXAgKHY0LjEuMyk6IGJ1dHRvbi5qcw0KICAgKiBMaWNlbnNlZCB1bmRlciBNSVQgKGh0dHBzOi8vZ2l0aHViLmNvbS90d2JzL2Jvb3RzdHJhcC9ibG9iL21hc3Rlci9MSUNFTlNFKQ0KICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgKi8NCg0KICB2YXIgQnV0dG9uID0gZnVuY3Rpb24gKCQkJDEpIHsNCiAgICAvKioNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKiBDb25zdGFudHMNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKi8NCiAgICB2YXIgTkFNRSA9ICdidXR0b24nOw0KICAgIHZhciBWRVJTSU9OID0gJzQuMS4zJzsNCiAgICB2YXIgREFUQV9LRVkgPSAnYnMuYnV0dG9uJzsNCiAgICB2YXIgRVZFTlRfS0VZID0gIi4iICsgREFUQV9LRVk7DQogICAgdmFyIERBVEFfQVBJX0tFWSA9ICcuZGF0YS1hcGknOw0KICAgIHZhciBKUVVFUllfTk9fQ09ORkxJQ1QgPSAkJCQxLmZuW05BTUVdOw0KICAgIHZhciBDbGFzc05hbWUgPSB7DQogICAgICBBQ1RJVkU6ICdhY3RpdmUnLA0KICAgICAgQlVUVE9OOiAnYnRuJywNCiAgICAgIEZPQ1VTOiAnZm9jdXMnDQogICAgfTsNCiAgICB2YXIgU2VsZWN0b3IgPSB7DQogICAgICBEQVRBX1RPR0dMRV9DQVJST1Q6ICdbZGF0YS10b2dnbGVePSJidXR0b24iXScsDQogICAgICBEQVRBX1RPR0dMRTogJ1tkYXRhLXRvZ2dsZT0iYnV0dG9ucyJdJywNCiAgICAgIElOUFVUOiAnaW5wdXQnLA0KICAgICAgQUNUSVZFOiAnLmFjdGl2ZScsDQogICAgICBCVVRUT046ICcuYnRuJw0KICAgIH07DQogICAgdmFyIEV2ZW50ID0gew0KICAgICAgQ0xJQ0tfREFUQV9BUEk6ICJjbGljayIgKyBFVkVOVF9LRVkgKyBEQVRBX0FQSV9LRVksDQogICAgICBGT0NVU19CTFVSX0RBVEFfQVBJOiAiZm9jdXMiICsgRVZFTlRfS0VZICsgREFUQV9BUElfS0VZICsgIiAiICsgKCJibHVyIiArIEVWRU5UX0tFWSArIERBVEFfQVBJX0tFWSkNCiAgICAgIC8qKg0KICAgICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICAgKiBDbGFzcyBEZWZpbml0aW9uDQogICAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgICAqLw0KDQogICAgfTsNCg0KICAgIHZhciBCdXR0b24gPQ0KICAgIC8qI19fUFVSRV9fKi8NCiAgICBmdW5jdGlvbiAoKSB7DQogICAgICBmdW5jdGlvbiBCdXR0b24oZWxlbWVudCkgew0KICAgICAgICB0aGlzLl9lbGVtZW50ID0gZWxlbWVudDsNCiAgICAgIH0gLy8gR2V0dGVycw0KDQoNCiAgICAgIHZhciBfcHJvdG8gPSBCdXR0b24ucHJvdG90eXBlOw0KDQogICAgICAvLyBQdWJsaWMNCiAgICAgIF9wcm90by50b2dnbGUgPSBmdW5jdGlvbiB0b2dnbGUoKSB7DQogICAgICAgIHZhciB0cmlnZ2VyQ2hhbmdlRXZlbnQgPSB0cnVlOw0KICAgICAgICB2YXIgYWRkQXJpYVByZXNzZWQgPSB0cnVlOw0KICAgICAgICB2YXIgcm9vdEVsZW1lbnQgPSAkJCQxKHRoaXMuX2VsZW1lbnQpLmNsb3Nlc3QoU2VsZWN0b3IuREFUQV9UT0dHTEUpWzBdOw0KDQogICAgICAgIGlmIChyb290RWxlbWVudCkgew0KICAgICAgICAgIHZhciBpbnB1dCA9IHRoaXMuX2VsZW1lbnQucXVlcnlTZWxlY3RvcihTZWxlY3Rvci5JTlBVVCk7DQoNCiAgICAgICAgICBpZiAoaW5wdXQpIHsNCiAgICAgICAgICAgIGlmIChpbnB1dC50eXBlID09PSAncmFkaW8nKSB7DQogICAgICAgICAgICAgIGlmIChpbnB1dC5jaGVja2VkICYmIHRoaXMuX2VsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKENsYXNzTmFtZS5BQ1RJVkUpKSB7DQogICAgICAgICAgICAgICAgdHJpZ2dlckNoYW5nZUV2ZW50ID0gZmFsc2U7DQogICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgdmFyIGFjdGl2ZUVsZW1lbnQgPSByb290RWxlbWVudC5xdWVyeVNlbGVjdG9yKFNlbGVjdG9yLkFDVElWRSk7DQoNCiAgICAgICAgICAgICAgICBpZiAoYWN0aXZlRWxlbWVudCkgew0KICAgICAgICAgICAgICAgICAgJCQkMShhY3RpdmVFbGVtZW50KS5yZW1vdmVDbGFzcyhDbGFzc05hbWUuQUNUSVZFKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYgKHRyaWdnZXJDaGFuZ2VFdmVudCkgew0KICAgICAgICAgICAgICBpZiAoaW5wdXQuaGFzQXR0cmlidXRlKCdkaXNhYmxlZCcpIHx8IHJvb3RFbGVtZW50Lmhhc0F0dHJpYnV0ZSgnZGlzYWJsZWQnKSB8fCBpbnB1dC5jbGFzc0xpc3QuY29udGFpbnMoJ2Rpc2FibGVkJykgfHwgcm9vdEVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKCdkaXNhYmxlZCcpKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgaW5wdXQuY2hlY2tlZCA9ICF0aGlzLl9lbGVtZW50LmNsYXNzTGlzdC5jb250YWlucyhDbGFzc05hbWUuQUNUSVZFKTsNCiAgICAgICAgICAgICAgJCQkMShpbnB1dCkudHJpZ2dlcignY2hhbmdlJyk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGlucHV0LmZvY3VzKCk7DQogICAgICAgICAgICBhZGRBcmlhUHJlc3NlZCA9IGZhbHNlOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChhZGRBcmlhUHJlc3NlZCkgew0KICAgICAgICAgIHRoaXMuX2VsZW1lbnQuc2V0QXR0cmlidXRlKCdhcmlhLXByZXNzZWQnLCAhdGhpcy5fZWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoQ2xhc3NOYW1lLkFDVElWRSkpOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKHRyaWdnZXJDaGFuZ2VFdmVudCkgew0KICAgICAgICAgICQkJDEodGhpcy5fZWxlbWVudCkudG9nZ2xlQ2xhc3MoQ2xhc3NOYW1lLkFDVElWRSk7DQogICAgICAgIH0NCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5kaXNwb3NlID0gZnVuY3Rpb24gZGlzcG9zZSgpIHsNCiAgICAgICAgJCQkMS5yZW1vdmVEYXRhKHRoaXMuX2VsZW1lbnQsIERBVEFfS0VZKTsNCiAgICAgICAgdGhpcy5fZWxlbWVudCA9IG51bGw7DQogICAgICB9OyAvLyBTdGF0aWMNCg0KDQogICAgICBCdXR0b24uX2pRdWVyeUludGVyZmFjZSA9IGZ1bmN0aW9uIF9qUXVlcnlJbnRlcmZhY2UoY29uZmlnKSB7DQogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgew0KICAgICAgICAgIHZhciBkYXRhID0gJCQkMSh0aGlzKS5kYXRhKERBVEFfS0VZKTsNCg0KICAgICAgICAgIGlmICghZGF0YSkgew0KICAgICAgICAgICAgZGF0YSA9IG5ldyBCdXR0b24odGhpcyk7DQogICAgICAgICAgICAkJCQxKHRoaXMpLmRhdGEoREFUQV9LRVksIGRhdGEpOw0KICAgICAgICAgIH0NCg0KICAgICAgICAgIGlmIChjb25maWcgPT09ICd0b2dnbGUnKSB7DQogICAgICAgICAgICBkYXRhW2NvbmZpZ10oKTsNCiAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgfTsNCg0KICAgICAgX2NyZWF0ZUNsYXNzKEJ1dHRvbiwgbnVsbCwgW3sNCiAgICAgICAga2V5OiAiVkVSU0lPTiIsDQogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgew0KICAgICAgICAgIHJldHVybiBWRVJTSU9OOw0KICAgICAgICB9DQogICAgICB9XSk7DQoNCiAgICAgIHJldHVybiBCdXR0b247DQogICAgfSgpOw0KICAgIC8qKg0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqIERhdGEgQXBpIGltcGxlbWVudGF0aW9uDQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICovDQoNCg0KICAgICQkJDEoZG9jdW1lbnQpLm9uKEV2ZW50LkNMSUNLX0RBVEFfQVBJLCBTZWxlY3Rvci5EQVRBX1RPR0dMRV9DQVJST1QsIGZ1bmN0aW9uIChldmVudCkgew0KICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsNCiAgICAgIHZhciBidXR0b24gPSBldmVudC50YXJnZXQ7DQoNCiAgICAgIGlmICghJCQkMShidXR0b24pLmhhc0NsYXNzKENsYXNzTmFtZS5CVVRUT04pKSB7DQogICAgICAgIGJ1dHRvbiA9ICQkJDEoYnV0dG9uKS5jbG9zZXN0KFNlbGVjdG9yLkJVVFRPTik7DQogICAgICB9DQoNCiAgICAgIEJ1dHRvbi5falF1ZXJ5SW50ZXJmYWNlLmNhbGwoJCQkMShidXR0b24pLCAndG9nZ2xlJyk7DQogICAgfSkub24oRXZlbnQuRk9DVVNfQkxVUl9EQVRBX0FQSSwgU2VsZWN0b3IuREFUQV9UT0dHTEVfQ0FSUk9ULCBmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgIHZhciBidXR0b24gPSAkJCQxKGV2ZW50LnRhcmdldCkuY2xvc2VzdChTZWxlY3Rvci5CVVRUT04pWzBdOw0KICAgICAgJCQkMShidXR0b24pLnRvZ2dsZUNsYXNzKENsYXNzTmFtZS5GT0NVUywgL15mb2N1cyhpbik/JC8udGVzdChldmVudC50eXBlKSk7DQogICAgfSk7DQogICAgLyoqDQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICogalF1ZXJ5DQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICovDQoNCiAgICAkJCQxLmZuW05BTUVdID0gQnV0dG9uLl9qUXVlcnlJbnRlcmZhY2U7DQogICAgJCQkMS5mbltOQU1FXS5Db25zdHJ1Y3RvciA9IEJ1dHRvbjsNCg0KICAgICQkJDEuZm5bTkFNRV0ubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICQkJDEuZm5bTkFNRV0gPSBKUVVFUllfTk9fQ09ORkxJQ1Q7DQogICAgICByZXR1cm4gQnV0dG9uLl9qUXVlcnlJbnRlcmZhY2U7DQogICAgfTsNCg0KICAgIHJldHVybiBCdXR0b247DQogIH0oJCk7DQoNCiAgLyoqDQogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAqIEJvb3RzdHJhcCAodjQuMS4zKTogY2Fyb3VzZWwuanMNCiAgICogTGljZW5zZWQgdW5kZXIgTUlUIChodHRwczovL2dpdGh1Yi5jb20vdHdicy9ib290c3RyYXAvYmxvYi9tYXN0ZXIvTElDRU5TRSkNCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICovDQoNCiAgdmFyIENhcm91c2VsID0gZnVuY3Rpb24gKCQkJDEpIHsNCiAgICAvKioNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKiBDb25zdGFudHMNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKi8NCiAgICB2YXIgTkFNRSA9ICdjYXJvdXNlbCc7DQogICAgdmFyIFZFUlNJT04gPSAnNC4xLjMnOw0KICAgIHZhciBEQVRBX0tFWSA9ICdicy5jYXJvdXNlbCc7DQogICAgdmFyIEVWRU5UX0tFWSA9ICIuIiArIERBVEFfS0VZOw0KICAgIHZhciBEQVRBX0FQSV9LRVkgPSAnLmRhdGEtYXBpJzsNCiAgICB2YXIgSlFVRVJZX05PX0NPTkZMSUNUID0gJCQkMS5mbltOQU1FXTsNCiAgICB2YXIgQVJST1dfTEVGVF9LRVlDT0RFID0gMzc7IC8vIEtleWJvYXJkRXZlbnQud2hpY2ggdmFsdWUgZm9yIGxlZnQgYXJyb3cga2V5DQoNCiAgICB2YXIgQVJST1dfUklHSFRfS0VZQ09ERSA9IDM5OyAvLyBLZXlib2FyZEV2ZW50LndoaWNoIHZhbHVlIGZvciByaWdodCBhcnJvdyBrZXkNCg0KICAgIHZhciBUT1VDSEVWRU5UX0NPTVBBVF9XQUlUID0gNTAwOyAvLyBUaW1lIGZvciBtb3VzZSBjb21wYXQgZXZlbnRzIHRvIGZpcmUgYWZ0ZXIgdG91Y2gNCg0KICAgIHZhciBEZWZhdWx0ID0gew0KICAgICAgaW50ZXJ2YWw6IDUwMDAsDQogICAgICBrZXlib2FyZDogdHJ1ZSwNCiAgICAgIHNsaWRlOiBmYWxzZSwNCiAgICAgIHBhdXNlOiAnaG92ZXInLA0KICAgICAgd3JhcDogdHJ1ZQ0KICAgIH07DQogICAgdmFyIERlZmF1bHRUeXBlID0gew0KICAgICAgaW50ZXJ2YWw6ICcobnVtYmVyfGJvb2xlYW4pJywNCiAgICAgIGtleWJvYXJkOiAnYm9vbGVhbicsDQogICAgICBzbGlkZTogJyhib29sZWFufHN0cmluZyknLA0KICAgICAgcGF1c2U6ICcoc3RyaW5nfGJvb2xlYW4pJywNCiAgICAgIHdyYXA6ICdib29sZWFuJw0KICAgIH07DQogICAgdmFyIERpcmVjdGlvbiA9IHsNCiAgICAgIE5FWFQ6ICduZXh0JywNCiAgICAgIFBSRVY6ICdwcmV2JywNCiAgICAgIExFRlQ6ICdsZWZ0JywNCiAgICAgIFJJR0hUOiAncmlnaHQnDQogICAgfTsNCiAgICB2YXIgRXZlbnQgPSB7DQogICAgICBTTElERTogInNsaWRlIiArIEVWRU5UX0tFWSwNCiAgICAgIFNMSUQ6ICJzbGlkIiArIEVWRU5UX0tFWSwNCiAgICAgIEtFWURPV046ICJrZXlkb3duIiArIEVWRU5UX0tFWSwNCiAgICAgIE1PVVNFRU5URVI6ICJtb3VzZWVudGVyIiArIEVWRU5UX0tFWSwNCiAgICAgIE1PVVNFTEVBVkU6ICJtb3VzZWxlYXZlIiArIEVWRU5UX0tFWSwNCiAgICAgIFRPVUNIRU5EOiAidG91Y2hlbmQiICsgRVZFTlRfS0VZLA0KICAgICAgTE9BRF9EQVRBX0FQSTogImxvYWQiICsgRVZFTlRfS0VZICsgREFUQV9BUElfS0VZLA0KICAgICAgQ0xJQ0tfREFUQV9BUEk6ICJjbGljayIgKyBFVkVOVF9LRVkgKyBEQVRBX0FQSV9LRVkNCiAgICB9Ow0KICAgIHZhciBDbGFzc05hbWUgPSB7DQogICAgICBDQVJPVVNFTDogJ2Nhcm91c2VsJywNCiAgICAgIEFDVElWRTogJ2FjdGl2ZScsDQogICAgICBTTElERTogJ3NsaWRlJywNCiAgICAgIFJJR0hUOiAnY2Fyb3VzZWwtaXRlbS1yaWdodCcsDQogICAgICBMRUZUOiAnY2Fyb3VzZWwtaXRlbS1sZWZ0JywNCiAgICAgIE5FWFQ6ICdjYXJvdXNlbC1pdGVtLW5leHQnLA0KICAgICAgUFJFVjogJ2Nhcm91c2VsLWl0ZW0tcHJldicsDQogICAgICBJVEVNOiAnY2Fyb3VzZWwtaXRlbScNCiAgICB9Ow0KICAgIHZhciBTZWxlY3RvciA9IHsNCiAgICAgIEFDVElWRTogJy5hY3RpdmUnLA0KICAgICAgQUNUSVZFX0lURU06ICcuYWN0aXZlLmNhcm91c2VsLWl0ZW0nLA0KICAgICAgSVRFTTogJy5jYXJvdXNlbC1pdGVtJywNCiAgICAgIE5FWFRfUFJFVjogJy5jYXJvdXNlbC1pdGVtLW5leHQsIC5jYXJvdXNlbC1pdGVtLXByZXYnLA0KICAgICAgSU5ESUNBVE9SUzogJy5jYXJvdXNlbC1pbmRpY2F0b3JzJywNCiAgICAgIERBVEFfU0xJREU6ICdbZGF0YS1zbGlkZV0sIFtkYXRhLXNsaWRlLXRvXScsDQogICAgICBEQVRBX1JJREU6ICdbZGF0YS1yaWRlPSJjYXJvdXNlbCJdJw0KICAgICAgLyoqDQogICAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgICAqIENsYXNzIERlZmluaXRpb24NCiAgICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAgICovDQoNCiAgICB9Ow0KDQogICAgdmFyIENhcm91c2VsID0NCiAgICAvKiNfX1BVUkVfXyovDQogICAgZnVuY3Rpb24gKCkgew0KICAgICAgZnVuY3Rpb24gQ2Fyb3VzZWwoZWxlbWVudCwgY29uZmlnKSB7DQogICAgICAgIHRoaXMuX2l0ZW1zID0gbnVsbDsNCiAgICAgICAgdGhpcy5faW50ZXJ2YWwgPSBudWxsOw0KICAgICAgICB0aGlzLl9hY3RpdmVFbGVtZW50ID0gbnVsbDsNCiAgICAgICAgdGhpcy5faXNQYXVzZWQgPSBmYWxzZTsNCiAgICAgICAgdGhpcy5faXNTbGlkaW5nID0gZmFsc2U7DQogICAgICAgIHRoaXMudG91Y2hUaW1lb3V0ID0gbnVsbDsNCiAgICAgICAgdGhpcy5fY29uZmlnID0gdGhpcy5fZ2V0Q29uZmlnKGNvbmZpZyk7DQogICAgICAgIHRoaXMuX2VsZW1lbnQgPSAkJCQxKGVsZW1lbnQpWzBdOw0KICAgICAgICB0aGlzLl9pbmRpY2F0b3JzRWxlbWVudCA9IHRoaXMuX2VsZW1lbnQucXVlcnlTZWxlY3RvcihTZWxlY3Rvci5JTkRJQ0FUT1JTKTsNCg0KICAgICAgICB0aGlzLl9hZGRFdmVudExpc3RlbmVycygpOw0KICAgICAgfSAvLyBHZXR0ZXJzDQoNCg0KICAgICAgdmFyIF9wcm90byA9IENhcm91c2VsLnByb3RvdHlwZTsNCg0KICAgICAgLy8gUHVibGljDQogICAgICBfcHJvdG8ubmV4dCA9IGZ1bmN0aW9uIG5leHQoKSB7DQogICAgICAgIGlmICghdGhpcy5faXNTbGlkaW5nKSB7DQogICAgICAgICAgdGhpcy5fc2xpZGUoRGlyZWN0aW9uLk5FWFQpOw0KICAgICAgICB9DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8ubmV4dFdoZW5WaXNpYmxlID0gZnVuY3Rpb24gbmV4dFdoZW5WaXNpYmxlKCkgew0KICAgICAgICAvLyBEb24ndCBjYWxsIG5leHQgd2hlbiB0aGUgcGFnZSBpc24ndCB2aXNpYmxlDQogICAgICAgIC8vIG9yIHRoZSBjYXJvdXNlbCBvciBpdHMgcGFyZW50IGlzbid0IHZpc2libGUNCiAgICAgICAgaWYgKCFkb2N1bWVudC5oaWRkZW4gJiYgJCQkMSh0aGlzLl9lbGVtZW50KS5pcygnOnZpc2libGUnKSAmJiAkJCQxKHRoaXMuX2VsZW1lbnQpLmNzcygndmlzaWJpbGl0eScpICE9PSAnaGlkZGVuJykgew0KICAgICAgICAgIHRoaXMubmV4dCgpOw0KICAgICAgICB9DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8ucHJldiA9IGZ1bmN0aW9uIHByZXYoKSB7DQogICAgICAgIGlmICghdGhpcy5faXNTbGlkaW5nKSB7DQogICAgICAgICAgdGhpcy5fc2xpZGUoRGlyZWN0aW9uLlBSRVYpOw0KICAgICAgICB9DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8ucGF1c2UgPSBmdW5jdGlvbiBwYXVzZShldmVudCkgew0KICAgICAgICBpZiAoIWV2ZW50KSB7DQogICAgICAgICAgdGhpcy5faXNQYXVzZWQgPSB0cnVlOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKHRoaXMuX2VsZW1lbnQucXVlcnlTZWxlY3RvcihTZWxlY3Rvci5ORVhUX1BSRVYpKSB7DQogICAgICAgICAgVXRpbC50cmlnZ2VyVHJhbnNpdGlvbkVuZCh0aGlzLl9lbGVtZW50KTsNCiAgICAgICAgICB0aGlzLmN5Y2xlKHRydWUpOw0KICAgICAgICB9DQoNCiAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9pbnRlcnZhbCk7DQogICAgICAgIHRoaXMuX2ludGVydmFsID0gbnVsbDsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5jeWNsZSA9IGZ1bmN0aW9uIGN5Y2xlKGV2ZW50KSB7DQogICAgICAgIGlmICghZXZlbnQpIHsNCiAgICAgICAgICB0aGlzLl9pc1BhdXNlZCA9IGZhbHNlOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKHRoaXMuX2ludGVydmFsKSB7DQogICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9pbnRlcnZhbCk7DQogICAgICAgICAgdGhpcy5faW50ZXJ2YWwgPSBudWxsOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKHRoaXMuX2NvbmZpZy5pbnRlcnZhbCAmJiAhdGhpcy5faXNQYXVzZWQpIHsNCiAgICAgICAgICB0aGlzLl9pbnRlcnZhbCA9IHNldEludGVydmFsKChkb2N1bWVudC52aXNpYmlsaXR5U3RhdGUgPyB0aGlzLm5leHRXaGVuVmlzaWJsZSA6IHRoaXMubmV4dCkuYmluZCh0aGlzKSwgdGhpcy5fY29uZmlnLmludGVydmFsKTsNCiAgICAgICAgfQ0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLnRvID0gZnVuY3Rpb24gdG8oaW5kZXgpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCg0KICAgICAgICB0aGlzLl9hY3RpdmVFbGVtZW50ID0gdGhpcy5fZWxlbWVudC5xdWVyeVNlbGVjdG9yKFNlbGVjdG9yLkFDVElWRV9JVEVNKTsNCg0KICAgICAgICB2YXIgYWN0aXZlSW5kZXggPSB0aGlzLl9nZXRJdGVtSW5kZXgodGhpcy5fYWN0aXZlRWxlbWVudCk7DQoNCiAgICAgICAgaWYgKGluZGV4ID4gdGhpcy5faXRlbXMubGVuZ3RoIC0gMSB8fCBpbmRleCA8IDApIHsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICBpZiAodGhpcy5faXNTbGlkaW5nKSB7DQogICAgICAgICAgJCQkMSh0aGlzLl9lbGVtZW50KS5vbmUoRXZlbnQuU0xJRCwgZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgcmV0dXJuIF90aGlzLnRvKGluZGV4KTsNCiAgICAgICAgICB9KTsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoYWN0aXZlSW5kZXggPT09IGluZGV4KSB7DQogICAgICAgICAgdGhpcy5wYXVzZSgpOw0KICAgICAgICAgIHRoaXMuY3ljbGUoKTsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICB2YXIgZGlyZWN0aW9uID0gaW5kZXggPiBhY3RpdmVJbmRleCA/IERpcmVjdGlvbi5ORVhUIDogRGlyZWN0aW9uLlBSRVY7DQoNCiAgICAgICAgdGhpcy5fc2xpZGUoZGlyZWN0aW9uLCB0aGlzLl9pdGVtc1tpbmRleF0pOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLmRpc3Bvc2UgPSBmdW5jdGlvbiBkaXNwb3NlKCkgew0KICAgICAgICAkJCQxKHRoaXMuX2VsZW1lbnQpLm9mZihFVkVOVF9LRVkpOw0KICAgICAgICAkJCQxLnJlbW92ZURhdGEodGhpcy5fZWxlbWVudCwgREFUQV9LRVkpOw0KICAgICAgICB0aGlzLl9pdGVtcyA9IG51bGw7DQogICAgICAgIHRoaXMuX2NvbmZpZyA9IG51bGw7DQogICAgICAgIHRoaXMuX2VsZW1lbnQgPSBudWxsOw0KICAgICAgICB0aGlzLl9pbnRlcnZhbCA9IG51bGw7DQogICAgICAgIHRoaXMuX2lzUGF1c2VkID0gbnVsbDsNCiAgICAgICAgdGhpcy5faXNTbGlkaW5nID0gbnVsbDsNCiAgICAgICAgdGhpcy5fYWN0aXZlRWxlbWVudCA9IG51bGw7DQogICAgICAgIHRoaXMuX2luZGljYXRvcnNFbGVtZW50ID0gbnVsbDsNCiAgICAgIH07IC8vIFByaXZhdGUNCg0KDQogICAgICBfcHJvdG8uX2dldENvbmZpZyA9IGZ1bmN0aW9uIF9nZXRDb25maWcoY29uZmlnKSB7DQogICAgICAgIGNvbmZpZyA9IF9vYmplY3RTcHJlYWQoe30sIERlZmF1bHQsIGNvbmZpZyk7DQogICAgICAgIFV0aWwudHlwZUNoZWNrQ29uZmlnKE5BTUUsIGNvbmZpZywgRGVmYXVsdFR5cGUpOw0KICAgICAgICByZXR1cm4gY29uZmlnOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9hZGRFdmVudExpc3RlbmVycyA9IGZ1bmN0aW9uIF9hZGRFdmVudExpc3RlbmVycygpIHsNCiAgICAgICAgdmFyIF90aGlzMiA9IHRoaXM7DQoNCiAgICAgICAgaWYgKHRoaXMuX2NvbmZpZy5rZXlib2FyZCkgew0KICAgICAgICAgICQkJDEodGhpcy5fZWxlbWVudCkub24oRXZlbnQuS0VZRE9XTiwgZnVuY3Rpb24gKGV2ZW50KSB7DQogICAgICAgICAgICByZXR1cm4gX3RoaXMyLl9rZXlkb3duKGV2ZW50KTsNCiAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmICh0aGlzLl9jb25maWcucGF1c2UgPT09ICdob3ZlcicpIHsNCiAgICAgICAgICAkJCQxKHRoaXMuX2VsZW1lbnQpLm9uKEV2ZW50Lk1PVVNFRU5URVIsIGZ1bmN0aW9uIChldmVudCkgew0KICAgICAgICAgICAgcmV0dXJuIF90aGlzMi5wYXVzZShldmVudCk7DQogICAgICAgICAgfSkub24oRXZlbnQuTU9VU0VMRUFWRSwgZnVuY3Rpb24gKGV2ZW50KSB7DQogICAgICAgICAgICByZXR1cm4gX3RoaXMyLmN5Y2xlKGV2ZW50KTsNCiAgICAgICAgICB9KTsNCg0KICAgICAgICAgIGlmICgnb250b3VjaHN0YXJ0JyBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpIHsNCiAgICAgICAgICAgIC8vIElmIGl0J3MgYSB0b3VjaC1lbmFibGVkIGRldmljZSwgbW91c2VlbnRlci9sZWF2ZSBhcmUgZmlyZWQgYXMNCiAgICAgICAgICAgIC8vIHBhcnQgb2YgdGhlIG1vdXNlIGNvbXBhdGliaWxpdHkgZXZlbnRzIG9uIGZpcnN0IHRhcCAtIHRoZSBjYXJvdXNlbA0KICAgICAgICAgICAgLy8gd291bGQgc3RvcCBjeWNsaW5nIHVudGlsIHVzZXIgdGFwcGVkIG91dCBvZiBpdDsNCiAgICAgICAgICAgIC8vIGhlcmUsIHdlIGxpc3RlbiBmb3IgdG91Y2hlbmQsIGV4cGxpY2l0bHkgcGF1c2UgdGhlIGNhcm91c2VsDQogICAgICAgICAgICAvLyAoYXMgaWYgaXQncyB0aGUgc2Vjb25kIHRpbWUgd2UgdGFwIG9uIGl0LCBtb3VzZWVudGVyIGNvbXBhdCBldmVudA0KICAgICAgICAgICAgLy8gaXMgTk9UIGZpcmVkKSBhbmQgYWZ0ZXIgYSB0aW1lb3V0ICh0byBhbGxvdyBmb3IgbW91c2UgY29tcGF0aWJpbGl0eQ0KICAgICAgICAgICAgLy8gZXZlbnRzIHRvIGZpcmUpIHdlIGV4cGxpY2l0bHkgcmVzdGFydCBjeWNsaW5nDQogICAgICAgICAgICAkJCQxKHRoaXMuX2VsZW1lbnQpLm9uKEV2ZW50LlRPVUNIRU5ELCBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgIF90aGlzMi5wYXVzZSgpOw0KDQogICAgICAgICAgICAgIGlmIChfdGhpczIudG91Y2hUaW1lb3V0KSB7DQogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KF90aGlzMi50b3VjaFRpbWVvdXQpOw0KICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgX3RoaXMyLnRvdWNoVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKGV2ZW50KSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzMi5jeWNsZShldmVudCk7DQogICAgICAgICAgICAgIH0sIFRPVUNIRVZFTlRfQ09NUEFUX1dBSVQgKyBfdGhpczIuX2NvbmZpZy5pbnRlcnZhbCk7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5fa2V5ZG93biA9IGZ1bmN0aW9uIF9rZXlkb3duKGV2ZW50KSB7DQogICAgICAgIGlmICgvaW5wdXR8dGV4dGFyZWEvaS50ZXN0KGV2ZW50LnRhcmdldC50YWdOYW1lKSkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIHN3aXRjaCAoZXZlbnQud2hpY2gpIHsNCiAgICAgICAgICBjYXNlIEFSUk9XX0xFRlRfS0VZQ09ERToNCiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQogICAgICAgICAgICB0aGlzLnByZXYoKTsNCiAgICAgICAgICAgIGJyZWFrOw0KDQogICAgICAgICAgY2FzZSBBUlJPV19SSUdIVF9LRVlDT0RFOg0KICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgICAgIHRoaXMubmV4dCgpOw0KICAgICAgICAgICAgYnJlYWs7DQoNCiAgICAgICAgICBkZWZhdWx0Og0KICAgICAgICB9DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uX2dldEl0ZW1JbmRleCA9IGZ1bmN0aW9uIF9nZXRJdGVtSW5kZXgoZWxlbWVudCkgew0KICAgICAgICB0aGlzLl9pdGVtcyA9IGVsZW1lbnQgJiYgZWxlbWVudC5wYXJlbnROb2RlID8gW10uc2xpY2UuY2FsbChlbGVtZW50LnBhcmVudE5vZGUucXVlcnlTZWxlY3RvckFsbChTZWxlY3Rvci5JVEVNKSkgOiBbXTsNCiAgICAgICAgcmV0dXJuIHRoaXMuX2l0ZW1zLmluZGV4T2YoZWxlbWVudCk7DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uX2dldEl0ZW1CeURpcmVjdGlvbiA9IGZ1bmN0aW9uIF9nZXRJdGVtQnlEaXJlY3Rpb24oZGlyZWN0aW9uLCBhY3RpdmVFbGVtZW50KSB7DQogICAgICAgIHZhciBpc05leHREaXJlY3Rpb24gPSBkaXJlY3Rpb24gPT09IERpcmVjdGlvbi5ORVhUOw0KICAgICAgICB2YXIgaXNQcmV2RGlyZWN0aW9uID0gZGlyZWN0aW9uID09PSBEaXJlY3Rpb24uUFJFVjsNCg0KICAgICAgICB2YXIgYWN0aXZlSW5kZXggPSB0aGlzLl9nZXRJdGVtSW5kZXgoYWN0aXZlRWxlbWVudCk7DQoNCiAgICAgICAgdmFyIGxhc3RJdGVtSW5kZXggPSB0aGlzLl9pdGVtcy5sZW5ndGggLSAxOw0KICAgICAgICB2YXIgaXNHb2luZ1RvV3JhcCA9IGlzUHJldkRpcmVjdGlvbiAmJiBhY3RpdmVJbmRleCA9PT0gMCB8fCBpc05leHREaXJlY3Rpb24gJiYgYWN0aXZlSW5kZXggPT09IGxhc3RJdGVtSW5kZXg7DQoNCiAgICAgICAgaWYgKGlzR29pbmdUb1dyYXAgJiYgIXRoaXMuX2NvbmZpZy53cmFwKSB7DQogICAgICAgICAgcmV0dXJuIGFjdGl2ZUVsZW1lbnQ7DQogICAgICAgIH0NCg0KICAgICAgICB2YXIgZGVsdGEgPSBkaXJlY3Rpb24gPT09IERpcmVjdGlvbi5QUkVWID8gLTEgOiAxOw0KICAgICAgICB2YXIgaXRlbUluZGV4ID0gKGFjdGl2ZUluZGV4ICsgZGVsdGEpICUgdGhpcy5faXRlbXMubGVuZ3RoOw0KICAgICAgICByZXR1cm4gaXRlbUluZGV4ID09PSAtMSA/IHRoaXMuX2l0ZW1zW3RoaXMuX2l0ZW1zLmxlbmd0aCAtIDFdIDogdGhpcy5faXRlbXNbaXRlbUluZGV4XTsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5fdHJpZ2dlclNsaWRlRXZlbnQgPSBmdW5jdGlvbiBfdHJpZ2dlclNsaWRlRXZlbnQocmVsYXRlZFRhcmdldCwgZXZlbnREaXJlY3Rpb25OYW1lKSB7DQogICAgICAgIHZhciB0YXJnZXRJbmRleCA9IHRoaXMuX2dldEl0ZW1JbmRleChyZWxhdGVkVGFyZ2V0KTsNCg0KICAgICAgICB2YXIgZnJvbUluZGV4ID0gdGhpcy5fZ2V0SXRlbUluZGV4KHRoaXMuX2VsZW1lbnQucXVlcnlTZWxlY3RvcihTZWxlY3Rvci5BQ1RJVkVfSVRFTSkpOw0KDQogICAgICAgIHZhciBzbGlkZUV2ZW50ID0gJCQkMS5FdmVudChFdmVudC5TTElERSwgew0KICAgICAgICAgIHJlbGF0ZWRUYXJnZXQ6IHJlbGF0ZWRUYXJnZXQsDQogICAgICAgICAgZGlyZWN0aW9uOiBldmVudERpcmVjdGlvbk5hbWUsDQogICAgICAgICAgZnJvbTogZnJvbUluZGV4LA0KICAgICAgICAgIHRvOiB0YXJnZXRJbmRleA0KICAgICAgICB9KTsNCiAgICAgICAgJCQkMSh0aGlzLl9lbGVtZW50KS50cmlnZ2VyKHNsaWRlRXZlbnQpOw0KICAgICAgICByZXR1cm4gc2xpZGVFdmVudDsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5fc2V0QWN0aXZlSW5kaWNhdG9yRWxlbWVudCA9IGZ1bmN0aW9uIF9zZXRBY3RpdmVJbmRpY2F0b3JFbGVtZW50KGVsZW1lbnQpIHsNCiAgICAgICAgaWYgKHRoaXMuX2luZGljYXRvcnNFbGVtZW50KSB7DQogICAgICAgICAgdmFyIGluZGljYXRvcnMgPSBbXS5zbGljZS5jYWxsKHRoaXMuX2luZGljYXRvcnNFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoU2VsZWN0b3IuQUNUSVZFKSk7DQogICAgICAgICAgJCQkMShpbmRpY2F0b3JzKS5yZW1vdmVDbGFzcyhDbGFzc05hbWUuQUNUSVZFKTsNCg0KICAgICAgICAgIHZhciBuZXh0SW5kaWNhdG9yID0gdGhpcy5faW5kaWNhdG9yc0VsZW1lbnQuY2hpbGRyZW5bdGhpcy5fZ2V0SXRlbUluZGV4KGVsZW1lbnQpXTsNCg0KICAgICAgICAgIGlmIChuZXh0SW5kaWNhdG9yKSB7DQogICAgICAgICAgICAkJCQxKG5leHRJbmRpY2F0b3IpLmFkZENsYXNzKENsYXNzTmFtZS5BQ1RJVkUpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9zbGlkZSA9IGZ1bmN0aW9uIF9zbGlkZShkaXJlY3Rpb24sIGVsZW1lbnQpIHsNCiAgICAgICAgdmFyIF90aGlzMyA9IHRoaXM7DQoNCiAgICAgICAgdmFyIGFjdGl2ZUVsZW1lbnQgPSB0aGlzLl9lbGVtZW50LnF1ZXJ5U2VsZWN0b3IoU2VsZWN0b3IuQUNUSVZFX0lURU0pOw0KDQogICAgICAgIHZhciBhY3RpdmVFbGVtZW50SW5kZXggPSB0aGlzLl9nZXRJdGVtSW5kZXgoYWN0aXZlRWxlbWVudCk7DQoNCiAgICAgICAgdmFyIG5leHRFbGVtZW50ID0gZWxlbWVudCB8fCBhY3RpdmVFbGVtZW50ICYmIHRoaXMuX2dldEl0ZW1CeURpcmVjdGlvbihkaXJlY3Rpb24sIGFjdGl2ZUVsZW1lbnQpOw0KDQogICAgICAgIHZhciBuZXh0RWxlbWVudEluZGV4ID0gdGhpcy5fZ2V0SXRlbUluZGV4KG5leHRFbGVtZW50KTsNCg0KICAgICAgICB2YXIgaXNDeWNsaW5nID0gQm9vbGVhbih0aGlzLl9pbnRlcnZhbCk7DQogICAgICAgIHZhciBkaXJlY3Rpb25hbENsYXNzTmFtZTsNCiAgICAgICAgdmFyIG9yZGVyQ2xhc3NOYW1lOw0KICAgICAgICB2YXIgZXZlbnREaXJlY3Rpb25OYW1lOw0KDQogICAgICAgIGlmIChkaXJlY3Rpb24gPT09IERpcmVjdGlvbi5ORVhUKSB7DQogICAgICAgICAgZGlyZWN0aW9uYWxDbGFzc05hbWUgPSBDbGFzc05hbWUuTEVGVDsNCiAgICAgICAgICBvcmRlckNsYXNzTmFtZSA9IENsYXNzTmFtZS5ORVhUOw0KICAgICAgICAgIGV2ZW50RGlyZWN0aW9uTmFtZSA9IERpcmVjdGlvbi5MRUZUOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGRpcmVjdGlvbmFsQ2xhc3NOYW1lID0gQ2xhc3NOYW1lLlJJR0hUOw0KICAgICAgICAgIG9yZGVyQ2xhc3NOYW1lID0gQ2xhc3NOYW1lLlBSRVY7DQogICAgICAgICAgZXZlbnREaXJlY3Rpb25OYW1lID0gRGlyZWN0aW9uLlJJR0hUOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKG5leHRFbGVtZW50ICYmICQkJDEobmV4dEVsZW1lbnQpLmhhc0NsYXNzKENsYXNzTmFtZS5BQ1RJVkUpKSB7DQogICAgICAgICAgdGhpcy5faXNTbGlkaW5nID0gZmFsc2U7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgdmFyIHNsaWRlRXZlbnQgPSB0aGlzLl90cmlnZ2VyU2xpZGVFdmVudChuZXh0RWxlbWVudCwgZXZlbnREaXJlY3Rpb25OYW1lKTsNCg0KICAgICAgICBpZiAoc2xpZGVFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmICghYWN0aXZlRWxlbWVudCB8fCAhbmV4dEVsZW1lbnQpIHsNCiAgICAgICAgICAvLyBTb21lIHdlaXJkbmVzcyBpcyBoYXBwZW5pbmcsIHNvIHdlIGJhaWwNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICB0aGlzLl9pc1NsaWRpbmcgPSB0cnVlOw0KDQogICAgICAgIGlmIChpc0N5Y2xpbmcpIHsNCiAgICAgICAgICB0aGlzLnBhdXNlKCk7DQogICAgICAgIH0NCg0KICAgICAgICB0aGlzLl9zZXRBY3RpdmVJbmRpY2F0b3JFbGVtZW50KG5leHRFbGVtZW50KTsNCg0KICAgICAgICB2YXIgc2xpZEV2ZW50ID0gJCQkMS5FdmVudChFdmVudC5TTElELCB7DQogICAgICAgICAgcmVsYXRlZFRhcmdldDogbmV4dEVsZW1lbnQsDQogICAgICAgICAgZGlyZWN0aW9uOiBldmVudERpcmVjdGlvbk5hbWUsDQogICAgICAgICAgZnJvbTogYWN0aXZlRWxlbWVudEluZGV4LA0KICAgICAgICAgIHRvOiBuZXh0RWxlbWVudEluZGV4DQogICAgICAgIH0pOw0KDQogICAgICAgIGlmICgkJCQxKHRoaXMuX2VsZW1lbnQpLmhhc0NsYXNzKENsYXNzTmFtZS5TTElERSkpIHsNCiAgICAgICAgICAkJCQxKG5leHRFbGVtZW50KS5hZGRDbGFzcyhvcmRlckNsYXNzTmFtZSk7DQogICAgICAgICAgVXRpbC5yZWZsb3cobmV4dEVsZW1lbnQpOw0KICAgICAgICAgICQkJDEoYWN0aXZlRWxlbWVudCkuYWRkQ2xhc3MoZGlyZWN0aW9uYWxDbGFzc05hbWUpOw0KICAgICAgICAgICQkJDEobmV4dEVsZW1lbnQpLmFkZENsYXNzKGRpcmVjdGlvbmFsQ2xhc3NOYW1lKTsNCiAgICAgICAgICB2YXIgdHJhbnNpdGlvbkR1cmF0aW9uID0gVXRpbC5nZXRUcmFuc2l0aW9uRHVyYXRpb25Gcm9tRWxlbWVudChhY3RpdmVFbGVtZW50KTsNCiAgICAgICAgICAkJCQxKGFjdGl2ZUVsZW1lbnQpLm9uZShVdGlsLlRSQU5TSVRJT05fRU5ELCBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAkJCQxKG5leHRFbGVtZW50KS5yZW1vdmVDbGFzcyhkaXJlY3Rpb25hbENsYXNzTmFtZSArICIgIiArIG9yZGVyQ2xhc3NOYW1lKS5hZGRDbGFzcyhDbGFzc05hbWUuQUNUSVZFKTsNCiAgICAgICAgICAgICQkJDEoYWN0aXZlRWxlbWVudCkucmVtb3ZlQ2xhc3MoQ2xhc3NOYW1lLkFDVElWRSArICIgIiArIG9yZGVyQ2xhc3NOYW1lICsgIiAiICsgZGlyZWN0aW9uYWxDbGFzc05hbWUpOw0KICAgICAgICAgICAgX3RoaXMzLl9pc1NsaWRpbmcgPSBmYWxzZTsNCiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICByZXR1cm4gJCQkMShfdGhpczMuX2VsZW1lbnQpLnRyaWdnZXIoc2xpZEV2ZW50KTsNCiAgICAgICAgICAgIH0sIDApOw0KICAgICAgICAgIH0pLmVtdWxhdGVUcmFuc2l0aW9uRW5kKHRyYW5zaXRpb25EdXJhdGlvbik7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgJCQkMShhY3RpdmVFbGVtZW50KS5yZW1vdmVDbGFzcyhDbGFzc05hbWUuQUNUSVZFKTsNCiAgICAgICAgICAkJCQxKG5leHRFbGVtZW50KS5hZGRDbGFzcyhDbGFzc05hbWUuQUNUSVZFKTsNCiAgICAgICAgICB0aGlzLl9pc1NsaWRpbmcgPSBmYWxzZTsNCiAgICAgICAgICAkJCQxKHRoaXMuX2VsZW1lbnQpLnRyaWdnZXIoc2xpZEV2ZW50KTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChpc0N5Y2xpbmcpIHsNCiAgICAgICAgICB0aGlzLmN5Y2xlKCk7DQogICAgICAgIH0NCiAgICAgIH07IC8vIFN0YXRpYw0KDQoNCiAgICAgIENhcm91c2VsLl9qUXVlcnlJbnRlcmZhY2UgPSBmdW5jdGlvbiBfalF1ZXJ5SW50ZXJmYWNlKGNvbmZpZykgew0KICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICB2YXIgZGF0YSA9ICQkJDEodGhpcykuZGF0YShEQVRBX0tFWSk7DQoNCiAgICAgICAgICB2YXIgX2NvbmZpZyA9IF9vYmplY3RTcHJlYWQoe30sIERlZmF1bHQsICQkJDEodGhpcykuZGF0YSgpKTsNCg0KICAgICAgICAgIGlmICh0eXBlb2YgY29uZmlnID09PSAnb2JqZWN0Jykgew0KICAgICAgICAgICAgX2NvbmZpZyA9IF9vYmplY3RTcHJlYWQoe30sIF9jb25maWcsIGNvbmZpZyk7DQogICAgICAgICAgfQ0KDQogICAgICAgICAgdmFyIGFjdGlvbiA9IHR5cGVvZiBjb25maWcgPT09ICdzdHJpbmcnID8gY29uZmlnIDogX2NvbmZpZy5zbGlkZTsNCg0KICAgICAgICAgIGlmICghZGF0YSkgew0KICAgICAgICAgICAgZGF0YSA9IG5ldyBDYXJvdXNlbCh0aGlzLCBfY29uZmlnKTsNCiAgICAgICAgICAgICQkJDEodGhpcykuZGF0YShEQVRBX0tFWSwgZGF0YSk7DQogICAgICAgICAgfQ0KDQogICAgICAgICAgaWYgKHR5cGVvZiBjb25maWcgPT09ICdudW1iZXInKSB7DQogICAgICAgICAgICBkYXRhLnRvKGNvbmZpZyk7DQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYWN0aW9uID09PSAnc3RyaW5nJykgew0KICAgICAgICAgICAgaWYgKHR5cGVvZiBkYXRhW2FjdGlvbl0gPT09ICd1bmRlZmluZWQnKSB7DQogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIk5vIG1ldGhvZCBuYW1lZCBcIiIgKyBhY3Rpb24gKyAiXCIiKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgZGF0YVthY3Rpb25dKCk7DQogICAgICAgICAgfSBlbHNlIGlmIChfY29uZmlnLmludGVydmFsKSB7DQogICAgICAgICAgICBkYXRhLnBhdXNlKCk7DQogICAgICAgICAgICBkYXRhLmN5Y2xlKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgIH07DQoNCiAgICAgIENhcm91c2VsLl9kYXRhQXBpQ2xpY2tIYW5kbGVyID0gZnVuY3Rpb24gX2RhdGFBcGlDbGlja0hhbmRsZXIoZXZlbnQpIHsNCiAgICAgICAgdmFyIHNlbGVjdG9yID0gVXRpbC5nZXRTZWxlY3RvckZyb21FbGVtZW50KHRoaXMpOw0KDQogICAgICAgIGlmICghc2VsZWN0b3IpIHsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICB2YXIgdGFyZ2V0ID0gJCQkMShzZWxlY3RvcilbMF07DQoNCiAgICAgICAgaWYgKCF0YXJnZXQgfHwgISQkJDEodGFyZ2V0KS5oYXNDbGFzcyhDbGFzc05hbWUuQ0FST1VTRUwpKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgdmFyIGNvbmZpZyA9IF9vYmplY3RTcHJlYWQoe30sICQkJDEodGFyZ2V0KS5kYXRhKCksICQkJDEodGhpcykuZGF0YSgpKTsNCg0KICAgICAgICB2YXIgc2xpZGVJbmRleCA9IHRoaXMuZ2V0QXR0cmlidXRlKCdkYXRhLXNsaWRlLXRvJyk7DQoNCiAgICAgICAgaWYgKHNsaWRlSW5kZXgpIHsNCiAgICAgICAgICBjb25maWcuaW50ZXJ2YWwgPSBmYWxzZTsNCiAgICAgICAgfQ0KDQogICAgICAgIENhcm91c2VsLl9qUXVlcnlJbnRlcmZhY2UuY2FsbCgkJCQxKHRhcmdldCksIGNvbmZpZyk7DQoNCiAgICAgICAgaWYgKHNsaWRlSW5kZXgpIHsNCiAgICAgICAgICAkJCQxKHRhcmdldCkuZGF0YShEQVRBX0tFWSkudG8oc2xpZGVJbmRleCk7DQogICAgICAgIH0NCg0KICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KICAgICAgfTsNCg0KICAgICAgX2NyZWF0ZUNsYXNzKENhcm91c2VsLCBudWxsLCBbew0KICAgICAgICBrZXk6ICJWRVJTSU9OIiwNCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7DQogICAgICAgICAgcmV0dXJuIFZFUlNJT047DQogICAgICAgIH0NCiAgICAgIH0sIHsNCiAgICAgICAga2V5OiAiRGVmYXVsdCIsDQogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgew0KICAgICAgICAgIHJldHVybiBEZWZhdWx0Ow0KICAgICAgICB9DQogICAgICB9XSk7DQoNCiAgICAgIHJldHVybiBDYXJvdXNlbDsNCiAgICB9KCk7DQogICAgLyoqDQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICogRGF0YSBBcGkgaW1wbGVtZW50YXRpb24NCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKi8NCg0KDQogICAgJCQkMShkb2N1bWVudCkub24oRXZlbnQuQ0xJQ0tfREFUQV9BUEksIFNlbGVjdG9yLkRBVEFfU0xJREUsIENhcm91c2VsLl9kYXRhQXBpQ2xpY2tIYW5kbGVyKTsNCiAgICAkJCQxKHdpbmRvdykub24oRXZlbnQuTE9BRF9EQVRBX0FQSSwgZnVuY3Rpb24gKCkgew0KICAgICAgdmFyIGNhcm91c2VscyA9IFtdLnNsaWNlLmNhbGwoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChTZWxlY3Rvci5EQVRBX1JJREUpKTsNCg0KICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGNhcm91c2Vscy5sZW5ndGg7IGkgPCBsZW47IGkrKykgew0KICAgICAgICB2YXIgJGNhcm91c2VsID0gJCQkMShjYXJvdXNlbHNbaV0pOw0KDQogICAgICAgIENhcm91c2VsLl9qUXVlcnlJbnRlcmZhY2UuY2FsbCgkY2Fyb3VzZWwsICRjYXJvdXNlbC5kYXRhKCkpOw0KICAgICAgfQ0KICAgIH0pOw0KICAgIC8qKg0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqIGpRdWVyeQ0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqLw0KDQogICAgJCQkMS5mbltOQU1FXSA9IENhcm91c2VsLl9qUXVlcnlJbnRlcmZhY2U7DQogICAgJCQkMS5mbltOQU1FXS5Db25zdHJ1Y3RvciA9IENhcm91c2VsOw0KDQogICAgJCQkMS5mbltOQU1FXS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKCkgew0KICAgICAgJCQkMS5mbltOQU1FXSA9IEpRVUVSWV9OT19DT05GTElDVDsNCiAgICAgIHJldHVybiBDYXJvdXNlbC5falF1ZXJ5SW50ZXJmYWNlOw0KICAgIH07DQoNCiAgICByZXR1cm4gQ2Fyb3VzZWw7DQogIH0oJCk7DQoNCiAgLyoqDQogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAqIEJvb3RzdHJhcCAodjQuMS4zKTogY29sbGFwc2UuanMNCiAgICogTGljZW5zZWQgdW5kZXIgTUlUIChodHRwczovL2dpdGh1Yi5jb20vdHdicy9ib290c3RyYXAvYmxvYi9tYXN0ZXIvTElDRU5TRSkNCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICovDQoNCiAgdmFyIENvbGxhcHNlID0gZnVuY3Rpb24gKCQkJDEpIHsNCiAgICAvKioNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKiBDb25zdGFudHMNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKi8NCiAgICB2YXIgTkFNRSA9ICdjb2xsYXBzZSc7DQogICAgdmFyIFZFUlNJT04gPSAnNC4xLjMnOw0KICAgIHZhciBEQVRBX0tFWSA9ICdicy5jb2xsYXBzZSc7DQogICAgdmFyIEVWRU5UX0tFWSA9ICIuIiArIERBVEFfS0VZOw0KICAgIHZhciBEQVRBX0FQSV9LRVkgPSAnLmRhdGEtYXBpJzsNCiAgICB2YXIgSlFVRVJZX05PX0NPTkZMSUNUID0gJCQkMS5mbltOQU1FXTsNCiAgICB2YXIgRGVmYXVsdCA9IHsNCiAgICAgIHRvZ2dsZTogdHJ1ZSwNCiAgICAgIHBhcmVudDogJycNCiAgICB9Ow0KICAgIHZhciBEZWZhdWx0VHlwZSA9IHsNCiAgICAgIHRvZ2dsZTogJ2Jvb2xlYW4nLA0KICAgICAgcGFyZW50OiAnKHN0cmluZ3xlbGVtZW50KScNCiAgICB9Ow0KICAgIHZhciBFdmVudCA9IHsNCiAgICAgIFNIT1c6ICJzaG93IiArIEVWRU5UX0tFWSwNCiAgICAgIFNIT1dOOiAic2hvd24iICsgRVZFTlRfS0VZLA0KICAgICAgSElERTogImhpZGUiICsgRVZFTlRfS0VZLA0KICAgICAgSElEREVOOiAiaGlkZGVuIiArIEVWRU5UX0tFWSwNCiAgICAgIENMSUNLX0RBVEFfQVBJOiAiY2xpY2siICsgRVZFTlRfS0VZICsgREFUQV9BUElfS0VZDQogICAgfTsNCiAgICB2YXIgQ2xhc3NOYW1lID0gew0KICAgICAgU0hPVzogJ3Nob3cnLA0KICAgICAgQ09MTEFQU0U6ICdjb2xsYXBzZScsDQogICAgICBDT0xMQVBTSU5HOiAnY29sbGFwc2luZycsDQogICAgICBDT0xMQVBTRUQ6ICdjb2xsYXBzZWQnDQogICAgfTsNCiAgICB2YXIgRGltZW5zaW9uID0gew0KICAgICAgV0lEVEg6ICd3aWR0aCcsDQogICAgICBIRUlHSFQ6ICdoZWlnaHQnDQogICAgfTsNCiAgICB2YXIgU2VsZWN0b3IgPSB7DQogICAgICBBQ1RJVkVTOiAnLnNob3csIC5jb2xsYXBzaW5nJywNCiAgICAgIERBVEFfVE9HR0xFOiAnW2RhdGEtdG9nZ2xlPSJjb2xsYXBzZSJdJw0KICAgICAgLyoqDQogICAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgICAqIENsYXNzIERlZmluaXRpb24NCiAgICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAgICovDQoNCiAgICB9Ow0KDQogICAgdmFyIENvbGxhcHNlID0NCiAgICAvKiNfX1BVUkVfXyovDQogICAgZnVuY3Rpb24gKCkgew0KICAgICAgZnVuY3Rpb24gQ29sbGFwc2UoZWxlbWVudCwgY29uZmlnKSB7DQogICAgICAgIHRoaXMuX2lzVHJhbnNpdGlvbmluZyA9IGZhbHNlOw0KICAgICAgICB0aGlzLl9lbGVtZW50ID0gZWxlbWVudDsNCiAgICAgICAgdGhpcy5fY29uZmlnID0gdGhpcy5fZ2V0Q29uZmlnKGNvbmZpZyk7DQogICAgICAgIHRoaXMuX3RyaWdnZXJBcnJheSA9ICQkJDEubWFrZUFycmF5KGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIltkYXRhLXRvZ2dsZT1cImNvbGxhcHNlXCJdW2hyZWY9XCIjIiArIGVsZW1lbnQuaWQgKyAiXCJdLCIgKyAoIltkYXRhLXRvZ2dsZT1cImNvbGxhcHNlXCJdW2RhdGEtdGFyZ2V0PVwiIyIgKyBlbGVtZW50LmlkICsgIlwiXSIpKSk7DQogICAgICAgIHZhciB0b2dnbGVMaXN0ID0gW10uc2xpY2UuY2FsbChkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFNlbGVjdG9yLkRBVEFfVE9HR0xFKSk7DQoNCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRvZ2dsZUxpc3QubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsNCiAgICAgICAgICB2YXIgZWxlbSA9IHRvZ2dsZUxpc3RbaV07DQogICAgICAgICAgdmFyIHNlbGVjdG9yID0gVXRpbC5nZXRTZWxlY3RvckZyb21FbGVtZW50KGVsZW0pOw0KICAgICAgICAgIHZhciBmaWx0ZXJFbGVtZW50ID0gW10uc2xpY2UuY2FsbChkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKSkuZmlsdGVyKGZ1bmN0aW9uIChmb3VuZEVsZW0pIHsNCiAgICAgICAgICAgIHJldHVybiBmb3VuZEVsZW0gPT09IGVsZW1lbnQ7DQogICAgICAgICAgfSk7DQoNCiAgICAgICAgICBpZiAoc2VsZWN0b3IgIT09IG51bGwgJiYgZmlsdGVyRWxlbWVudC5sZW5ndGggPiAwKSB7DQogICAgICAgICAgICB0aGlzLl9zZWxlY3RvciA9IHNlbGVjdG9yOw0KDQogICAgICAgICAgICB0aGlzLl90cmlnZ2VyQXJyYXkucHVzaChlbGVtKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICB0aGlzLl9wYXJlbnQgPSB0aGlzLl9jb25maWcucGFyZW50ID8gdGhpcy5fZ2V0UGFyZW50KCkgOiBudWxsOw0KDQogICAgICAgIGlmICghdGhpcy5fY29uZmlnLnBhcmVudCkgew0KICAgICAgICAgIHRoaXMuX2FkZEFyaWFBbmRDb2xsYXBzZWRDbGFzcyh0aGlzLl9lbGVtZW50LCB0aGlzLl90cmlnZ2VyQXJyYXkpOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKHRoaXMuX2NvbmZpZy50b2dnbGUpIHsNCiAgICAgICAgICB0aGlzLnRvZ2dsZSgpOw0KICAgICAgICB9DQogICAgICB9IC8vIEdldHRlcnMNCg0KDQogICAgICB2YXIgX3Byb3RvID0gQ29sbGFwc2UucHJvdG90eXBlOw0KDQogICAgICAvLyBQdWJsaWMNCiAgICAgIF9wcm90by50b2dnbGUgPSBmdW5jdGlvbiB0b2dnbGUoKSB7DQogICAgICAgIGlmICgkJCQxKHRoaXMuX2VsZW1lbnQpLmhhc0NsYXNzKENsYXNzTmFtZS5TSE9XKSkgew0KICAgICAgICAgIHRoaXMuaGlkZSgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHRoaXMuc2hvdygpOw0KICAgICAgICB9DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uc2hvdyA9IGZ1bmN0aW9uIHNob3coKSB7DQogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQoNCiAgICAgICAgaWYgKHRoaXMuX2lzVHJhbnNpdGlvbmluZyB8fCAkJCQxKHRoaXMuX2VsZW1lbnQpLmhhc0NsYXNzKENsYXNzTmFtZS5TSE9XKSkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIHZhciBhY3RpdmVzOw0KICAgICAgICB2YXIgYWN0aXZlc0RhdGE7DQoNCiAgICAgICAgaWYgKHRoaXMuX3BhcmVudCkgew0KICAgICAgICAgIGFjdGl2ZXMgPSBbXS5zbGljZS5jYWxsKHRoaXMuX3BhcmVudC5xdWVyeVNlbGVjdG9yQWxsKFNlbGVjdG9yLkFDVElWRVMpKS5maWx0ZXIoZnVuY3Rpb24gKGVsZW0pIHsNCiAgICAgICAgICAgIHJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgnZGF0YS1wYXJlbnQnKSA9PT0gX3RoaXMuX2NvbmZpZy5wYXJlbnQ7DQogICAgICAgICAgfSk7DQoNCiAgICAgICAgICBpZiAoYWN0aXZlcy5sZW5ndGggPT09IDApIHsNCiAgICAgICAgICAgIGFjdGl2ZXMgPSBudWxsOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChhY3RpdmVzKSB7DQogICAgICAgICAgYWN0aXZlc0RhdGEgPSAkJCQxKGFjdGl2ZXMpLm5vdCh0aGlzLl9zZWxlY3RvcikuZGF0YShEQVRBX0tFWSk7DQoNCiAgICAgICAgICBpZiAoYWN0aXZlc0RhdGEgJiYgYWN0aXZlc0RhdGEuX2lzVHJhbnNpdGlvbmluZykgew0KICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIHZhciBzdGFydEV2ZW50ID0gJCQkMS5FdmVudChFdmVudC5TSE9XKTsNCiAgICAgICAgJCQkMSh0aGlzLl9lbGVtZW50KS50cmlnZ2VyKHN0YXJ0RXZlbnQpOw0KDQogICAgICAgIGlmIChzdGFydEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKGFjdGl2ZXMpIHsNCiAgICAgICAgICBDb2xsYXBzZS5falF1ZXJ5SW50ZXJmYWNlLmNhbGwoJCQkMShhY3RpdmVzKS5ub3QodGhpcy5fc2VsZWN0b3IpLCAnaGlkZScpOw0KDQogICAgICAgICAgaWYgKCFhY3RpdmVzRGF0YSkgew0KICAgICAgICAgICAgJCQkMShhY3RpdmVzKS5kYXRhKERBVEFfS0VZLCBudWxsKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICB2YXIgZGltZW5zaW9uID0gdGhpcy5fZ2V0RGltZW5zaW9uKCk7DQoNCiAgICAgICAgJCQkMSh0aGlzLl9lbGVtZW50KS5yZW1vdmVDbGFzcyhDbGFzc05hbWUuQ09MTEFQU0UpLmFkZENsYXNzKENsYXNzTmFtZS5DT0xMQVBTSU5HKTsNCiAgICAgICAgdGhpcy5fZWxlbWVudC5zdHlsZVtkaW1lbnNpb25dID0gMDsNCg0KICAgICAgICBpZiAodGhpcy5fdHJpZ2dlckFycmF5Lmxlbmd0aCkgew0KICAgICAgICAgICQkJDEodGhpcy5fdHJpZ2dlckFycmF5KS5yZW1vdmVDbGFzcyhDbGFzc05hbWUuQ09MTEFQU0VEKS5hdHRyKCdhcmlhLWV4cGFuZGVkJywgdHJ1ZSk7DQogICAgICAgIH0NCg0KICAgICAgICB0aGlzLnNldFRyYW5zaXRpb25pbmcodHJ1ZSk7DQoNCiAgICAgICAgdmFyIGNvbXBsZXRlID0gZnVuY3Rpb24gY29tcGxldGUoKSB7DQogICAgICAgICAgJCQkMShfdGhpcy5fZWxlbWVudCkucmVtb3ZlQ2xhc3MoQ2xhc3NOYW1lLkNPTExBUFNJTkcpLmFkZENsYXNzKENsYXNzTmFtZS5DT0xMQVBTRSkuYWRkQ2xhc3MoQ2xhc3NOYW1lLlNIT1cpOw0KICAgICAgICAgIF90aGlzLl9lbGVtZW50LnN0eWxlW2RpbWVuc2lvbl0gPSAnJzsNCg0KICAgICAgICAgIF90aGlzLnNldFRyYW5zaXRpb25pbmcoZmFsc2UpOw0KDQogICAgICAgICAgJCQkMShfdGhpcy5fZWxlbWVudCkudHJpZ2dlcihFdmVudC5TSE9XTik7DQogICAgICAgIH07DQoNCiAgICAgICAgdmFyIGNhcGl0YWxpemVkRGltZW5zaW9uID0gZGltZW5zaW9uWzBdLnRvVXBwZXJDYXNlKCkgKyBkaW1lbnNpb24uc2xpY2UoMSk7DQogICAgICAgIHZhciBzY3JvbGxTaXplID0gInNjcm9sbCIgKyBjYXBpdGFsaXplZERpbWVuc2lvbjsNCiAgICAgICAgdmFyIHRyYW5zaXRpb25EdXJhdGlvbiA9IFV0aWwuZ2V0VHJhbnNpdGlvbkR1cmF0aW9uRnJvbUVsZW1lbnQodGhpcy5fZWxlbWVudCk7DQogICAgICAgICQkJDEodGhpcy5fZWxlbWVudCkub25lKFV0aWwuVFJBTlNJVElPTl9FTkQsIGNvbXBsZXRlKS5lbXVsYXRlVHJhbnNpdGlvbkVuZCh0cmFuc2l0aW9uRHVyYXRpb24pOw0KICAgICAgICB0aGlzLl9lbGVtZW50LnN0eWxlW2RpbWVuc2lvbl0gPSB0aGlzLl9lbGVtZW50W3Njcm9sbFNpemVdICsgInB4IjsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5oaWRlID0gZnVuY3Rpb24gaGlkZSgpIHsNCiAgICAgICAgdmFyIF90aGlzMiA9IHRoaXM7DQoNCiAgICAgICAgaWYgKHRoaXMuX2lzVHJhbnNpdGlvbmluZyB8fCAhJCQkMSh0aGlzLl9lbGVtZW50KS5oYXNDbGFzcyhDbGFzc05hbWUuU0hPVykpIHsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICB2YXIgc3RhcnRFdmVudCA9ICQkJDEuRXZlbnQoRXZlbnQuSElERSk7DQogICAgICAgICQkJDEodGhpcy5fZWxlbWVudCkudHJpZ2dlcihzdGFydEV2ZW50KTsNCg0KICAgICAgICBpZiAoc3RhcnRFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIHZhciBkaW1lbnNpb24gPSB0aGlzLl9nZXREaW1lbnNpb24oKTsNCg0KICAgICAgICB0aGlzLl9lbGVtZW50LnN0eWxlW2RpbWVuc2lvbl0gPSB0aGlzLl9lbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpW2RpbWVuc2lvbl0gKyAicHgiOw0KICAgICAgICBVdGlsLnJlZmxvdyh0aGlzLl9lbGVtZW50KTsNCiAgICAgICAgJCQkMSh0aGlzLl9lbGVtZW50KS5hZGRDbGFzcyhDbGFzc05hbWUuQ09MTEFQU0lORykucmVtb3ZlQ2xhc3MoQ2xhc3NOYW1lLkNPTExBUFNFKS5yZW1vdmVDbGFzcyhDbGFzc05hbWUuU0hPVyk7DQogICAgICAgIHZhciB0cmlnZ2VyQXJyYXlMZW5ndGggPSB0aGlzLl90cmlnZ2VyQXJyYXkubGVuZ3RoOw0KDQogICAgICAgIGlmICh0cmlnZ2VyQXJyYXlMZW5ndGggPiAwKSB7DQogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0cmlnZ2VyQXJyYXlMZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgdmFyIHRyaWdnZXIgPSB0aGlzLl90cmlnZ2VyQXJyYXlbaV07DQogICAgICAgICAgICB2YXIgc2VsZWN0b3IgPSBVdGlsLmdldFNlbGVjdG9yRnJvbUVsZW1lbnQodHJpZ2dlcik7DQoNCiAgICAgICAgICAgIGlmIChzZWxlY3RvciAhPT0gbnVsbCkgew0KICAgICAgICAgICAgICB2YXIgJGVsZW0gPSAkJCQxKFtdLnNsaWNlLmNhbGwoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvcikpKTsNCg0KICAgICAgICAgICAgICBpZiAoISRlbGVtLmhhc0NsYXNzKENsYXNzTmFtZS5TSE9XKSkgew0KICAgICAgICAgICAgICAgICQkJDEodHJpZ2dlcikuYWRkQ2xhc3MoQ2xhc3NOYW1lLkNPTExBUFNFRCkuYXR0cignYXJpYS1leHBhbmRlZCcsIGZhbHNlKTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIHRoaXMuc2V0VHJhbnNpdGlvbmluZyh0cnVlKTsNCg0KICAgICAgICB2YXIgY29tcGxldGUgPSBmdW5jdGlvbiBjb21wbGV0ZSgpIHsNCiAgICAgICAgICBfdGhpczIuc2V0VHJhbnNpdGlvbmluZyhmYWxzZSk7DQoNCiAgICAgICAgICAkJCQxKF90aGlzMi5fZWxlbWVudCkucmVtb3ZlQ2xhc3MoQ2xhc3NOYW1lLkNPTExBUFNJTkcpLmFkZENsYXNzKENsYXNzTmFtZS5DT0xMQVBTRSkudHJpZ2dlcihFdmVudC5ISURERU4pOw0KICAgICAgICB9Ow0KDQogICAgICAgIHRoaXMuX2VsZW1lbnQuc3R5bGVbZGltZW5zaW9uXSA9ICcnOw0KICAgICAgICB2YXIgdHJhbnNpdGlvbkR1cmF0aW9uID0gVXRpbC5nZXRUcmFuc2l0aW9uRHVyYXRpb25Gcm9tRWxlbWVudCh0aGlzLl9lbGVtZW50KTsNCiAgICAgICAgJCQkMSh0aGlzLl9lbGVtZW50KS5vbmUoVXRpbC5UUkFOU0lUSU9OX0VORCwgY29tcGxldGUpLmVtdWxhdGVUcmFuc2l0aW9uRW5kKHRyYW5zaXRpb25EdXJhdGlvbik7DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uc2V0VHJhbnNpdGlvbmluZyA9IGZ1bmN0aW9uIHNldFRyYW5zaXRpb25pbmcoaXNUcmFuc2l0aW9uaW5nKSB7DQogICAgICAgIHRoaXMuX2lzVHJhbnNpdGlvbmluZyA9IGlzVHJhbnNpdGlvbmluZzsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5kaXNwb3NlID0gZnVuY3Rpb24gZGlzcG9zZSgpIHsNCiAgICAgICAgJCQkMS5yZW1vdmVEYXRhKHRoaXMuX2VsZW1lbnQsIERBVEFfS0VZKTsNCiAgICAgICAgdGhpcy5fY29uZmlnID0gbnVsbDsNCiAgICAgICAgdGhpcy5fcGFyZW50ID0gbnVsbDsNCiAgICAgICAgdGhpcy5fZWxlbWVudCA9IG51bGw7DQogICAgICAgIHRoaXMuX3RyaWdnZXJBcnJheSA9IG51bGw7DQogICAgICAgIHRoaXMuX2lzVHJhbnNpdGlvbmluZyA9IG51bGw7DQogICAgICB9OyAvLyBQcml2YXRlDQoNCg0KICAgICAgX3Byb3RvLl9nZXRDb25maWcgPSBmdW5jdGlvbiBfZ2V0Q29uZmlnKGNvbmZpZykgew0KICAgICAgICBjb25maWcgPSBfb2JqZWN0U3ByZWFkKHt9LCBEZWZhdWx0LCBjb25maWcpOw0KICAgICAgICBjb25maWcudG9nZ2xlID0gQm9vbGVhbihjb25maWcudG9nZ2xlKTsgLy8gQ29lcmNlIHN0cmluZyB2YWx1ZXMNCg0KICAgICAgICBVdGlsLnR5cGVDaGVja0NvbmZpZyhOQU1FLCBjb25maWcsIERlZmF1bHRUeXBlKTsNCiAgICAgICAgcmV0dXJuIGNvbmZpZzsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5fZ2V0RGltZW5zaW9uID0gZnVuY3Rpb24gX2dldERpbWVuc2lvbigpIHsNCiAgICAgICAgdmFyIGhhc1dpZHRoID0gJCQkMSh0aGlzLl9lbGVtZW50KS5oYXNDbGFzcyhEaW1lbnNpb24uV0lEVEgpOw0KICAgICAgICByZXR1cm4gaGFzV2lkdGggPyBEaW1lbnNpb24uV0lEVEggOiBEaW1lbnNpb24uSEVJR0hUOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9nZXRQYXJlbnQgPSBmdW5jdGlvbiBfZ2V0UGFyZW50KCkgew0KICAgICAgICB2YXIgX3RoaXMzID0gdGhpczsNCg0KICAgICAgICB2YXIgcGFyZW50ID0gbnVsbDsNCg0KICAgICAgICBpZiAoVXRpbC5pc0VsZW1lbnQodGhpcy5fY29uZmlnLnBhcmVudCkpIHsNCiAgICAgICAgICBwYXJlbnQgPSB0aGlzLl9jb25maWcucGFyZW50OyAvLyBJdCdzIGEgalF1ZXJ5IG9iamVjdA0KDQogICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLl9jb25maWcucGFyZW50LmpxdWVyeSAhPT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgICAgICAgIHBhcmVudCA9IHRoaXMuX2NvbmZpZy5wYXJlbnRbMF07DQogICAgICAgICAgfQ0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHBhcmVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IodGhpcy5fY29uZmlnLnBhcmVudCk7DQogICAgICAgIH0NCg0KICAgICAgICB2YXIgc2VsZWN0b3IgPSAiW2RhdGEtdG9nZ2xlPVwiY29sbGFwc2VcIl1bZGF0YS1wYXJlbnQ9XCIiICsgdGhpcy5fY29uZmlnLnBhcmVudCArICJcIl0iOw0KICAgICAgICB2YXIgY2hpbGRyZW4gPSBbXS5zbGljZS5jYWxsKHBhcmVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKSk7DQogICAgICAgICQkJDEoY2hpbGRyZW4pLmVhY2goZnVuY3Rpb24gKGksIGVsZW1lbnQpIHsNCiAgICAgICAgICBfdGhpczMuX2FkZEFyaWFBbmRDb2xsYXBzZWRDbGFzcyhDb2xsYXBzZS5fZ2V0VGFyZ2V0RnJvbUVsZW1lbnQoZWxlbWVudCksIFtlbGVtZW50XSk7DQogICAgICAgIH0pOw0KICAgICAgICByZXR1cm4gcGFyZW50Ow0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9hZGRBcmlhQW5kQ29sbGFwc2VkQ2xhc3MgPSBmdW5jdGlvbiBfYWRkQXJpYUFuZENvbGxhcHNlZENsYXNzKGVsZW1lbnQsIHRyaWdnZXJBcnJheSkgew0KICAgICAgICBpZiAoZWxlbWVudCkgew0KICAgICAgICAgIHZhciBpc09wZW4gPSAkJCQxKGVsZW1lbnQpLmhhc0NsYXNzKENsYXNzTmFtZS5TSE9XKTsNCg0KICAgICAgICAgIGlmICh0cmlnZ2VyQXJyYXkubGVuZ3RoKSB7DQogICAgICAgICAgICAkJCQxKHRyaWdnZXJBcnJheSkudG9nZ2xlQ2xhc3MoQ2xhc3NOYW1lLkNPTExBUFNFRCwgIWlzT3BlbikuYXR0cignYXJpYS1leHBhbmRlZCcsIGlzT3Blbik7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9OyAvLyBTdGF0aWMNCg0KDQogICAgICBDb2xsYXBzZS5fZ2V0VGFyZ2V0RnJvbUVsZW1lbnQgPSBmdW5jdGlvbiBfZ2V0VGFyZ2V0RnJvbUVsZW1lbnQoZWxlbWVudCkgew0KICAgICAgICB2YXIgc2VsZWN0b3IgPSBVdGlsLmdldFNlbGVjdG9yRnJvbUVsZW1lbnQoZWxlbWVudCk7DQogICAgICAgIHJldHVybiBzZWxlY3RvciA/IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpIDogbnVsbDsNCiAgICAgIH07DQoNCiAgICAgIENvbGxhcHNlLl9qUXVlcnlJbnRlcmZhY2UgPSBmdW5jdGlvbiBfalF1ZXJ5SW50ZXJmYWNlKGNvbmZpZykgew0KICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICB2YXIgJHRoaXMgPSAkJCQxKHRoaXMpOw0KICAgICAgICAgIHZhciBkYXRhID0gJHRoaXMuZGF0YShEQVRBX0tFWSk7DQoNCiAgICAgICAgICB2YXIgX2NvbmZpZyA9IF9vYmplY3RTcHJlYWQoe30sIERlZmF1bHQsICR0aGlzLmRhdGEoKSwgdHlwZW9mIGNvbmZpZyA9PT0gJ29iamVjdCcgJiYgY29uZmlnID8gY29uZmlnIDoge30pOw0KDQogICAgICAgICAgaWYgKCFkYXRhICYmIF9jb25maWcudG9nZ2xlICYmIC9zaG93fGhpZGUvLnRlc3QoY29uZmlnKSkgew0KICAgICAgICAgICAgX2NvbmZpZy50b2dnbGUgPSBmYWxzZTsNCiAgICAgICAgICB9DQoNCiAgICAgICAgICBpZiAoIWRhdGEpIHsNCiAgICAgICAgICAgIGRhdGEgPSBuZXcgQ29sbGFwc2UodGhpcywgX2NvbmZpZyk7DQogICAgICAgICAgICAkdGhpcy5kYXRhKERBVEFfS0VZLCBkYXRhKTsNCiAgICAgICAgICB9DQoNCiAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gJ3N0cmluZycpIHsNCiAgICAgICAgICAgIGlmICh0eXBlb2YgZGF0YVtjb25maWddID09PSAndW5kZWZpbmVkJykgew0KICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJObyBtZXRob2QgbmFtZWQgXCIiICsgY29uZmlnICsgIlwiIik7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGRhdGFbY29uZmlnXSgpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSk7DQogICAgICB9Ow0KDQogICAgICBfY3JlYXRlQ2xhc3MoQ29sbGFwc2UsIG51bGwsIFt7DQogICAgICAgIGtleTogIlZFUlNJT04iLA0KICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsNCiAgICAgICAgICByZXR1cm4gVkVSU0lPTjsNCiAgICAgICAgfQ0KICAgICAgfSwgew0KICAgICAgICBrZXk6ICJEZWZhdWx0IiwNCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7DQogICAgICAgICAgcmV0dXJuIERlZmF1bHQ7DQogICAgICAgIH0NCiAgICAgIH1dKTsNCg0KICAgICAgcmV0dXJuIENvbGxhcHNlOw0KICAgIH0oKTsNCiAgICAvKioNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKiBEYXRhIEFwaSBpbXBsZW1lbnRhdGlvbg0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqLw0KDQoNCiAgICAkJCQxKGRvY3VtZW50KS5vbihFdmVudC5DTElDS19EQVRBX0FQSSwgU2VsZWN0b3IuREFUQV9UT0dHTEUsIGZ1bmN0aW9uIChldmVudCkgew0KICAgICAgLy8gcHJldmVudERlZmF1bHQgb25seSBmb3IgPGE+IGVsZW1lbnRzICh3aGljaCBjaGFuZ2UgdGhlIFVSTCkgbm90IGluc2lkZSB0aGUgY29sbGFwc2libGUgZWxlbWVudA0KICAgICAgaWYgKGV2ZW50LmN1cnJlbnRUYXJnZXQudGFnTmFtZSA9PT0gJ0EnKSB7DQogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQogICAgICB9DQoNCiAgICAgIHZhciAkdHJpZ2dlciA9ICQkJDEodGhpcyk7DQogICAgICB2YXIgc2VsZWN0b3IgPSBVdGlsLmdldFNlbGVjdG9yRnJvbUVsZW1lbnQodGhpcyk7DQogICAgICB2YXIgc2VsZWN0b3JzID0gW10uc2xpY2UuY2FsbChkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKSk7DQogICAgICAkJCQxKHNlbGVjdG9ycykuZWFjaChmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciAkdGFyZ2V0ID0gJCQkMSh0aGlzKTsNCiAgICAgICAgdmFyIGRhdGEgPSAkdGFyZ2V0LmRhdGEoREFUQV9LRVkpOw0KICAgICAgICB2YXIgY29uZmlnID0gZGF0YSA/ICd0b2dnbGUnIDogJHRyaWdnZXIuZGF0YSgpOw0KDQogICAgICAgIENvbGxhcHNlLl9qUXVlcnlJbnRlcmZhY2UuY2FsbCgkdGFyZ2V0LCBjb25maWcpOw0KICAgICAgfSk7DQogICAgfSk7DQogICAgLyoqDQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICogalF1ZXJ5DQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICovDQoNCiAgICAkJCQxLmZuW05BTUVdID0gQ29sbGFwc2UuX2pRdWVyeUludGVyZmFjZTsNCiAgICAkJCQxLmZuW05BTUVdLkNvbnN0cnVjdG9yID0gQ29sbGFwc2U7DQoNCiAgICAkJCQxLmZuW05BTUVdLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7DQogICAgICAkJCQxLmZuW05BTUVdID0gSlFVRVJZX05PX0NPTkZMSUNUOw0KICAgICAgcmV0dXJuIENvbGxhcHNlLl9qUXVlcnlJbnRlcmZhY2U7DQogICAgfTsNCg0KICAgIHJldHVybiBDb2xsYXBzZTsNCiAgfSgkKTsNCg0KICAvKioNCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICogQm9vdHN0cmFwICh2NC4xLjMpOiBkcm9wZG93bi5qcw0KICAgKiBMaWNlbnNlZCB1bmRlciBNSVQgKGh0dHBzOi8vZ2l0aHViLmNvbS90d2JzL2Jvb3RzdHJhcC9ibG9iL21hc3Rlci9MSUNFTlNFKQ0KICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgKi8NCg0KICB2YXIgRHJvcGRvd24gPSBmdW5jdGlvbiAoJCQkMSkgew0KICAgIC8qKg0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqIENvbnN0YW50cw0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqLw0KICAgIHZhciBOQU1FID0gJ2Ryb3Bkb3duJzsNCiAgICB2YXIgVkVSU0lPTiA9ICc0LjEuMyc7DQogICAgdmFyIERBVEFfS0VZID0gJ2JzLmRyb3Bkb3duJzsNCiAgICB2YXIgRVZFTlRfS0VZID0gIi4iICsgREFUQV9LRVk7DQogICAgdmFyIERBVEFfQVBJX0tFWSA9ICcuZGF0YS1hcGknOw0KICAgIHZhciBKUVVFUllfTk9fQ09ORkxJQ1QgPSAkJCQxLmZuW05BTUVdOw0KICAgIHZhciBFU0NBUEVfS0VZQ09ERSA9IDI3OyAvLyBLZXlib2FyZEV2ZW50LndoaWNoIHZhbHVlIGZvciBFc2NhcGUgKEVzYykga2V5DQoNCiAgICB2YXIgU1BBQ0VfS0VZQ09ERSA9IDMyOyAvLyBLZXlib2FyZEV2ZW50LndoaWNoIHZhbHVlIGZvciBzcGFjZSBrZXkNCg0KICAgIHZhciBUQUJfS0VZQ09ERSA9IDk7IC8vIEtleWJvYXJkRXZlbnQud2hpY2ggdmFsdWUgZm9yIHRhYiBrZXkNCg0KICAgIHZhciBBUlJPV19VUF9LRVlDT0RFID0gMzg7IC8vIEtleWJvYXJkRXZlbnQud2hpY2ggdmFsdWUgZm9yIHVwIGFycm93IGtleQ0KDQogICAgdmFyIEFSUk9XX0RPV05fS0VZQ09ERSA9IDQwOyAvLyBLZXlib2FyZEV2ZW50LndoaWNoIHZhbHVlIGZvciBkb3duIGFycm93IGtleQ0KDQogICAgdmFyIFJJR0hUX01PVVNFX0JVVFRPTl9XSElDSCA9IDM7IC8vIE1vdXNlRXZlbnQud2hpY2ggdmFsdWUgZm9yIHRoZSByaWdodCBidXR0b24gKGFzc3VtaW5nIGEgcmlnaHQtaGFuZGVkIG1vdXNlKQ0KDQogICAgdmFyIFJFR0VYUF9LRVlET1dOID0gbmV3IFJlZ0V4cChBUlJPV19VUF9LRVlDT0RFICsgInwiICsgQVJST1dfRE9XTl9LRVlDT0RFICsgInwiICsgRVNDQVBFX0tFWUNPREUpOw0KICAgIHZhciBFdmVudCA9IHsNCiAgICAgIEhJREU6ICJoaWRlIiArIEVWRU5UX0tFWSwNCiAgICAgIEhJRERFTjogImhpZGRlbiIgKyBFVkVOVF9LRVksDQogICAgICBTSE9XOiAic2hvdyIgKyBFVkVOVF9LRVksDQogICAgICBTSE9XTjogInNob3duIiArIEVWRU5UX0tFWSwNCiAgICAgIENMSUNLOiAiY2xpY2siICsgRVZFTlRfS0VZLA0KICAgICAgQ0xJQ0tfREFUQV9BUEk6ICJjbGljayIgKyBFVkVOVF9LRVkgKyBEQVRBX0FQSV9LRVksDQogICAgICBLRVlET1dOX0RBVEFfQVBJOiAia2V5ZG93biIgKyBFVkVOVF9LRVkgKyBEQVRBX0FQSV9LRVksDQogICAgICBLRVlVUF9EQVRBX0FQSTogImtleXVwIiArIEVWRU5UX0tFWSArIERBVEFfQVBJX0tFWQ0KICAgIH07DQogICAgdmFyIENsYXNzTmFtZSA9IHsNCiAgICAgIERJU0FCTEVEOiAnZGlzYWJsZWQnLA0KICAgICAgU0hPVzogJ3Nob3cnLA0KICAgICAgRFJPUFVQOiAnZHJvcHVwJywNCiAgICAgIERST1BSSUdIVDogJ2Ryb3ByaWdodCcsDQogICAgICBEUk9QTEVGVDogJ2Ryb3BsZWZ0JywNCiAgICAgIE1FTlVSSUdIVDogJ2Ryb3Bkb3duLW1lbnUtcmlnaHQnLA0KICAgICAgTUVOVUxFRlQ6ICdkcm9wZG93bi1tZW51LWxlZnQnLA0KICAgICAgUE9TSVRJT05fU1RBVElDOiAncG9zaXRpb24tc3RhdGljJw0KICAgIH07DQogICAgdmFyIFNlbGVjdG9yID0gew0KICAgICAgREFUQV9UT0dHTEU6ICdbZGF0YS10b2dnbGU9ImRyb3Bkb3duIl0nLA0KICAgICAgRk9STV9DSElMRDogJy5kcm9wZG93biBmb3JtJywNCiAgICAgIE1FTlU6ICcuZHJvcGRvd24tbWVudScsDQogICAgICBOQVZCQVJfTkFWOiAnLm5hdmJhci1uYXYnLA0KICAgICAgVklTSUJMRV9JVEVNUzogJy5kcm9wZG93bi1tZW51IC5kcm9wZG93bi1pdGVtOm5vdCguZGlzYWJsZWQpOm5vdCg6ZGlzYWJsZWQpJw0KICAgIH07DQogICAgdmFyIEF0dGFjaG1lbnRNYXAgPSB7DQogICAgICBUT1A6ICd0b3Atc3RhcnQnLA0KICAgICAgVE9QRU5EOiAndG9wLWVuZCcsDQogICAgICBCT1RUT006ICdib3R0b20tc3RhcnQnLA0KICAgICAgQk9UVE9NRU5EOiAnYm90dG9tLWVuZCcsDQogICAgICBSSUdIVDogJ3JpZ2h0LXN0YXJ0JywNCiAgICAgIFJJR0hURU5EOiAncmlnaHQtZW5kJywNCiAgICAgIExFRlQ6ICdsZWZ0LXN0YXJ0JywNCiAgICAgIExFRlRFTkQ6ICdsZWZ0LWVuZCcNCiAgICB9Ow0KICAgIHZhciBEZWZhdWx0ID0gew0KICAgICAgb2Zmc2V0OiAwLA0KICAgICAgZmxpcDogdHJ1ZSwNCiAgICAgIGJvdW5kYXJ5OiAnc2Nyb2xsUGFyZW50JywNCiAgICAgIHJlZmVyZW5jZTogJ3RvZ2dsZScsDQogICAgICBkaXNwbGF5OiAnZHluYW1pYycNCiAgICB9Ow0KICAgIHZhciBEZWZhdWx0VHlwZSA9IHsNCiAgICAgIG9mZnNldDogJyhudW1iZXJ8c3RyaW5nfGZ1bmN0aW9uKScsDQogICAgICBmbGlwOiAnYm9vbGVhbicsDQogICAgICBib3VuZGFyeTogJyhzdHJpbmd8ZWxlbWVudCknLA0KICAgICAgcmVmZXJlbmNlOiAnKHN0cmluZ3xlbGVtZW50KScsDQogICAgICBkaXNwbGF5OiAnc3RyaW5nJw0KICAgICAgLyoqDQogICAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgICAqIENsYXNzIERlZmluaXRpb24NCiAgICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAgICovDQoNCiAgICB9Ow0KDQogICAgdmFyIERyb3Bkb3duID0NCiAgICAvKiNfX1BVUkVfXyovDQogICAgZnVuY3Rpb24gKCkgew0KICAgICAgZnVuY3Rpb24gRHJvcGRvd24oZWxlbWVudCwgY29uZmlnKSB7DQogICAgICAgIHRoaXMuX2VsZW1lbnQgPSBlbGVtZW50Ow0KICAgICAgICB0aGlzLl9wb3BwZXIgPSBudWxsOw0KICAgICAgICB0aGlzLl9jb25maWcgPSB0aGlzLl9nZXRDb25maWcoY29uZmlnKTsNCiAgICAgICAgdGhpcy5fbWVudSA9IHRoaXMuX2dldE1lbnVFbGVtZW50KCk7DQogICAgICAgIHRoaXMuX2luTmF2YmFyID0gdGhpcy5fZGV0ZWN0TmF2YmFyKCk7DQoNCiAgICAgICAgdGhpcy5fYWRkRXZlbnRMaXN0ZW5lcnMoKTsNCiAgICAgIH0gLy8gR2V0dGVycw0KDQoNCiAgICAgIHZhciBfcHJvdG8gPSBEcm9wZG93bi5wcm90b3R5cGU7DQoNCiAgICAgIC8vIFB1YmxpYw0KICAgICAgX3Byb3RvLnRvZ2dsZSA9IGZ1bmN0aW9uIHRvZ2dsZSgpIHsNCiAgICAgICAgaWYgKHRoaXMuX2VsZW1lbnQuZGlzYWJsZWQgfHwgJCQkMSh0aGlzLl9lbGVtZW50KS5oYXNDbGFzcyhDbGFzc05hbWUuRElTQUJMRUQpKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgdmFyIHBhcmVudCA9IERyb3Bkb3duLl9nZXRQYXJlbnRGcm9tRWxlbWVudCh0aGlzLl9lbGVtZW50KTsNCg0KICAgICAgICB2YXIgaXNBY3RpdmUgPSAkJCQxKHRoaXMuX21lbnUpLmhhc0NsYXNzKENsYXNzTmFtZS5TSE9XKTsNCg0KICAgICAgICBEcm9wZG93bi5fY2xlYXJNZW51cygpOw0KDQogICAgICAgIGlmIChpc0FjdGl2ZSkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIHZhciByZWxhdGVkVGFyZ2V0ID0gew0KICAgICAgICAgIHJlbGF0ZWRUYXJnZXQ6IHRoaXMuX2VsZW1lbnQNCiAgICAgICAgfTsNCiAgICAgICAgdmFyIHNob3dFdmVudCA9ICQkJDEuRXZlbnQoRXZlbnQuU0hPVywgcmVsYXRlZFRhcmdldCk7DQogICAgICAgICQkJDEocGFyZW50KS50cmlnZ2VyKHNob3dFdmVudCk7DQoNCiAgICAgICAgaWYgKHNob3dFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfSAvLyBEaXNhYmxlIHRvdGFsbHkgUG9wcGVyLmpzIGZvciBEcm9wZG93biBpbiBOYXZiYXINCg0KDQogICAgICAgIGlmICghdGhpcy5faW5OYXZiYXIpIHsNCiAgICAgICAgICAvKioNCiAgICAgICAgICAgKiBDaGVjayBmb3IgUG9wcGVyIGRlcGVuZGVuY3kNCiAgICAgICAgICAgKiBQb3BwZXIgLSBodHRwczovL3BvcHBlci5qcy5vcmcNCiAgICAgICAgICAgKi8NCiAgICAgICAgICBpZiAodHlwZW9mIFBvcHBlciA9PT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0Jvb3RzdHJhcCBkcm9wZG93biByZXF1aXJlIFBvcHBlci5qcyAoaHR0cHM6Ly9wb3BwZXIuanMub3JnKScpOw0KICAgICAgICAgIH0NCg0KICAgICAgICAgIHZhciByZWZlcmVuY2VFbGVtZW50ID0gdGhpcy5fZWxlbWVudDsNCg0KICAgICAgICAgIGlmICh0aGlzLl9jb25maWcucmVmZXJlbmNlID09PSAncGFyZW50Jykgew0KICAgICAgICAgICAgcmVmZXJlbmNlRWxlbWVudCA9IHBhcmVudDsNCiAgICAgICAgICB9IGVsc2UgaWYgKFV0aWwuaXNFbGVtZW50KHRoaXMuX2NvbmZpZy5yZWZlcmVuY2UpKSB7DQogICAgICAgICAgICByZWZlcmVuY2VFbGVtZW50ID0gdGhpcy5fY29uZmlnLnJlZmVyZW5jZTsgLy8gQ2hlY2sgaWYgaXQncyBqUXVlcnkgZWxlbWVudA0KDQogICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuX2NvbmZpZy5yZWZlcmVuY2UuanF1ZXJ5ICE9PSAndW5kZWZpbmVkJykgew0KICAgICAgICAgICAgICByZWZlcmVuY2VFbGVtZW50ID0gdGhpcy5fY29uZmlnLnJlZmVyZW5jZVswXTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9IC8vIElmIGJvdW5kYXJ5IGlzIG5vdCBgc2Nyb2xsUGFyZW50YCwgdGhlbiBzZXQgcG9zaXRpb24gdG8gYHN0YXRpY2ANCiAgICAgICAgICAvLyB0byBhbGxvdyB0aGUgbWVudSB0byAiZXNjYXBlIiB0aGUgc2Nyb2xsIHBhcmVudCdzIGJvdW5kYXJpZXMNCiAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vdHdicy9ib290c3RyYXAvaXNzdWVzLzI0MjUxDQoNCg0KICAgICAgICAgIGlmICh0aGlzLl9jb25maWcuYm91bmRhcnkgIT09ICdzY3JvbGxQYXJlbnQnKSB7DQogICAgICAgICAgICAkJCQxKHBhcmVudCkuYWRkQ2xhc3MoQ2xhc3NOYW1lLlBPU0lUSU9OX1NUQVRJQyk7DQogICAgICAgICAgfQ0KDQogICAgICAgICAgdGhpcy5fcG9wcGVyID0gbmV3IFBvcHBlcihyZWZlcmVuY2VFbGVtZW50LCB0aGlzLl9tZW51LCB0aGlzLl9nZXRQb3BwZXJDb25maWcoKSk7DQogICAgICAgIH0gLy8gSWYgdGhpcyBpcyBhIHRvdWNoLWVuYWJsZWQgZGV2aWNlIHdlIGFkZCBleHRyYQ0KICAgICAgICAvLyBlbXB0eSBtb3VzZW92ZXIgbGlzdGVuZXJzIHRvIHRoZSBib2R5J3MgaW1tZWRpYXRlIGNoaWxkcmVuOw0KICAgICAgICAvLyBvbmx5IG5lZWRlZCBiZWNhdXNlIG9mIGJyb2tlbiBldmVudCBkZWxlZ2F0aW9uIG9uIGlPUw0KICAgICAgICAvLyBodHRwczovL3d3dy5xdWlya3Ntb2RlLm9yZy9ibG9nL2FyY2hpdmVzLzIwMTQvMDIvbW91c2VfZXZlbnRfYnViLmh0bWwNCg0KDQogICAgICAgIGlmICgnb250b3VjaHN0YXJ0JyBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgJiYgJCQkMShwYXJlbnQpLmNsb3Nlc3QoU2VsZWN0b3IuTkFWQkFSX05BVikubGVuZ3RoID09PSAwKSB7DQogICAgICAgICAgJCQkMShkb2N1bWVudC5ib2R5KS5jaGlsZHJlbigpLm9uKCdtb3VzZW92ZXInLCBudWxsLCAkJCQxLm5vb3ApOw0KICAgICAgICB9DQoNCiAgICAgICAgdGhpcy5fZWxlbWVudC5mb2N1cygpOw0KDQogICAgICAgIHRoaXMuX2VsZW1lbnQuc2V0QXR0cmlidXRlKCdhcmlhLWV4cGFuZGVkJywgdHJ1ZSk7DQoNCiAgICAgICAgJCQkMSh0aGlzLl9tZW51KS50b2dnbGVDbGFzcyhDbGFzc05hbWUuU0hPVyk7DQogICAgICAgICQkJDEocGFyZW50KS50b2dnbGVDbGFzcyhDbGFzc05hbWUuU0hPVykudHJpZ2dlcigkJCQxLkV2ZW50KEV2ZW50LlNIT1dOLCByZWxhdGVkVGFyZ2V0KSk7DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uZGlzcG9zZSA9IGZ1bmN0aW9uIGRpc3Bvc2UoKSB7DQogICAgICAgICQkJDEucmVtb3ZlRGF0YSh0aGlzLl9lbGVtZW50LCBEQVRBX0tFWSk7DQogICAgICAgICQkJDEodGhpcy5fZWxlbWVudCkub2ZmKEVWRU5UX0tFWSk7DQogICAgICAgIHRoaXMuX2VsZW1lbnQgPSBudWxsOw0KICAgICAgICB0aGlzLl9tZW51ID0gbnVsbDsNCg0KICAgICAgICBpZiAodGhpcy5fcG9wcGVyICE9PSBudWxsKSB7DQogICAgICAgICAgdGhpcy5fcG9wcGVyLmRlc3Ryb3koKTsNCg0KICAgICAgICAgIHRoaXMuX3BvcHBlciA9IG51bGw7DQogICAgICAgIH0NCiAgICAgIH07DQoNCiAgICAgIF9wcm90by51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUoKSB7DQogICAgICAgIHRoaXMuX2luTmF2YmFyID0gdGhpcy5fZGV0ZWN0TmF2YmFyKCk7DQoNCiAgICAgICAgaWYgKHRoaXMuX3BvcHBlciAhPT0gbnVsbCkgew0KICAgICAgICAgIHRoaXMuX3BvcHBlci5zY2hlZHVsZVVwZGF0ZSgpOw0KICAgICAgICB9DQogICAgICB9OyAvLyBQcml2YXRlDQoNCg0KICAgICAgX3Byb3RvLl9hZGRFdmVudExpc3RlbmVycyA9IGZ1bmN0aW9uIF9hZGRFdmVudExpc3RlbmVycygpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCg0KICAgICAgICAkJCQxKHRoaXMuX2VsZW1lbnQpLm9uKEV2ZW50LkNMSUNLLCBmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOw0KDQogICAgICAgICAgX3RoaXMudG9nZ2xlKCk7DQogICAgICAgIH0pOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9nZXRDb25maWcgPSBmdW5jdGlvbiBfZ2V0Q29uZmlnKGNvbmZpZykgew0KICAgICAgICBjb25maWcgPSBfb2JqZWN0U3ByZWFkKHt9LCB0aGlzLmNvbnN0cnVjdG9yLkRlZmF1bHQsICQkJDEodGhpcy5fZWxlbWVudCkuZGF0YSgpLCBjb25maWcpOw0KICAgICAgICBVdGlsLnR5cGVDaGVja0NvbmZpZyhOQU1FLCBjb25maWcsIHRoaXMuY29uc3RydWN0b3IuRGVmYXVsdFR5cGUpOw0KICAgICAgICByZXR1cm4gY29uZmlnOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9nZXRNZW51RWxlbWVudCA9IGZ1bmN0aW9uIF9nZXRNZW51RWxlbWVudCgpIHsNCiAgICAgICAgaWYgKCF0aGlzLl9tZW51KSB7DQogICAgICAgICAgdmFyIHBhcmVudCA9IERyb3Bkb3duLl9nZXRQYXJlbnRGcm9tRWxlbWVudCh0aGlzLl9lbGVtZW50KTsNCg0KICAgICAgICAgIGlmIChwYXJlbnQpIHsNCiAgICAgICAgICAgIHRoaXMuX21lbnUgPSBwYXJlbnQucXVlcnlTZWxlY3RvcihTZWxlY3Rvci5NRU5VKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpcy5fbWVudTsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5fZ2V0UGxhY2VtZW50ID0gZnVuY3Rpb24gX2dldFBsYWNlbWVudCgpIHsNCiAgICAgICAgdmFyICRwYXJlbnREcm9wZG93biA9ICQkJDEodGhpcy5fZWxlbWVudC5wYXJlbnROb2RlKTsNCiAgICAgICAgdmFyIHBsYWNlbWVudCA9IEF0dGFjaG1lbnRNYXAuQk9UVE9NOyAvLyBIYW5kbGUgZHJvcHVwDQoNCiAgICAgICAgaWYgKCRwYXJlbnREcm9wZG93bi5oYXNDbGFzcyhDbGFzc05hbWUuRFJPUFVQKSkgew0KICAgICAgICAgIHBsYWNlbWVudCA9IEF0dGFjaG1lbnRNYXAuVE9QOw0KDQogICAgICAgICAgaWYgKCQkJDEodGhpcy5fbWVudSkuaGFzQ2xhc3MoQ2xhc3NOYW1lLk1FTlVSSUdIVCkpIHsNCiAgICAgICAgICAgIHBsYWNlbWVudCA9IEF0dGFjaG1lbnRNYXAuVE9QRU5EOw0KICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIGlmICgkcGFyZW50RHJvcGRvd24uaGFzQ2xhc3MoQ2xhc3NOYW1lLkRST1BSSUdIVCkpIHsNCiAgICAgICAgICBwbGFjZW1lbnQgPSBBdHRhY2htZW50TWFwLlJJR0hUOw0KICAgICAgICB9IGVsc2UgaWYgKCRwYXJlbnREcm9wZG93bi5oYXNDbGFzcyhDbGFzc05hbWUuRFJPUExFRlQpKSB7DQogICAgICAgICAgcGxhY2VtZW50ID0gQXR0YWNobWVudE1hcC5MRUZUOw0KICAgICAgICB9IGVsc2UgaWYgKCQkJDEodGhpcy5fbWVudSkuaGFzQ2xhc3MoQ2xhc3NOYW1lLk1FTlVSSUdIVCkpIHsNCiAgICAgICAgICBwbGFjZW1lbnQgPSBBdHRhY2htZW50TWFwLkJPVFRPTUVORDsNCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiBwbGFjZW1lbnQ7DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uX2RldGVjdE5hdmJhciA9IGZ1bmN0aW9uIF9kZXRlY3ROYXZiYXIoKSB7DQogICAgICAgIHJldHVybiAkJCQxKHRoaXMuX2VsZW1lbnQpLmNsb3Nlc3QoJy5uYXZiYXInKS5sZW5ndGggPiAwOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9nZXRQb3BwZXJDb25maWcgPSBmdW5jdGlvbiBfZ2V0UG9wcGVyQ29uZmlnKCkgew0KICAgICAgICB2YXIgX3RoaXMyID0gdGhpczsNCg0KICAgICAgICB2YXIgb2Zmc2V0Q29uZiA9IHt9Ow0KDQogICAgICAgIGlmICh0eXBlb2YgdGhpcy5fY29uZmlnLm9mZnNldCA9PT0gJ2Z1bmN0aW9uJykgew0KICAgICAgICAgIG9mZnNldENvbmYuZm4gPSBmdW5jdGlvbiAoZGF0YSkgew0KICAgICAgICAgICAgZGF0YS5vZmZzZXRzID0gX29iamVjdFNwcmVhZCh7fSwgZGF0YS5vZmZzZXRzLCBfdGhpczIuX2NvbmZpZy5vZmZzZXQoZGF0YS5vZmZzZXRzKSB8fCB7fSk7DQogICAgICAgICAgICByZXR1cm4gZGF0YTsNCiAgICAgICAgICB9Ow0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIG9mZnNldENvbmYub2Zmc2V0ID0gdGhpcy5fY29uZmlnLm9mZnNldDsNCiAgICAgICAgfQ0KDQogICAgICAgIHZhciBwb3BwZXJDb25maWcgPSB7DQogICAgICAgICAgcGxhY2VtZW50OiB0aGlzLl9nZXRQbGFjZW1lbnQoKSwNCiAgICAgICAgICBtb2RpZmllcnM6IHsNCiAgICAgICAgICAgIG9mZnNldDogb2Zmc2V0Q29uZiwNCiAgICAgICAgICAgIGZsaXA6IHsNCiAgICAgICAgICAgICAgZW5hYmxlZDogdGhpcy5fY29uZmlnLmZsaXANCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBwcmV2ZW50T3ZlcmZsb3c6IHsNCiAgICAgICAgICAgICAgYm91bmRhcmllc0VsZW1lbnQ6IHRoaXMuX2NvbmZpZy5ib3VuZGFyeQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0gLy8gRGlzYWJsZSBQb3BwZXIuanMgaWYgd2UgaGF2ZSBhIHN0YXRpYyBkaXNwbGF5DQoNCiAgICAgICAgfTsNCg0KICAgICAgICBpZiAodGhpcy5fY29uZmlnLmRpc3BsYXkgPT09ICdzdGF0aWMnKSB7DQogICAgICAgICAgcG9wcGVyQ29uZmlnLm1vZGlmaWVycy5hcHBseVN0eWxlID0gew0KICAgICAgICAgICAgZW5hYmxlZDogZmFsc2UNCiAgICAgICAgICB9Ow0KICAgICAgICB9DQoNCiAgICAgICAgcmV0dXJuIHBvcHBlckNvbmZpZzsNCiAgICAgIH07IC8vIFN0YXRpYw0KDQoNCiAgICAgIERyb3Bkb3duLl9qUXVlcnlJbnRlcmZhY2UgPSBmdW5jdGlvbiBfalF1ZXJ5SW50ZXJmYWNlKGNvbmZpZykgew0KICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICB2YXIgZGF0YSA9ICQkJDEodGhpcykuZGF0YShEQVRBX0tFWSk7DQoNCiAgICAgICAgICB2YXIgX2NvbmZpZyA9IHR5cGVvZiBjb25maWcgPT09ICdvYmplY3QnID8gY29uZmlnIDogbnVsbDsNCg0KICAgICAgICAgIGlmICghZGF0YSkgew0KICAgICAgICAgICAgZGF0YSA9IG5ldyBEcm9wZG93bih0aGlzLCBfY29uZmlnKTsNCiAgICAgICAgICAgICQkJDEodGhpcykuZGF0YShEQVRBX0tFWSwgZGF0YSk7DQogICAgICAgICAgfQ0KDQogICAgICAgICAgaWYgKHR5cGVvZiBjb25maWcgPT09ICdzdHJpbmcnKSB7DQogICAgICAgICAgICBpZiAodHlwZW9mIGRhdGFbY29uZmlnXSA9PT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiTm8gbWV0aG9kIG5hbWVkIFwiIiArIGNvbmZpZyArICJcIiIpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBkYXRhW2NvbmZpZ10oKTsNCiAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgfTsNCg0KICAgICAgRHJvcGRvd24uX2NsZWFyTWVudXMgPSBmdW5jdGlvbiBfY2xlYXJNZW51cyhldmVudCkgew0KICAgICAgICBpZiAoZXZlbnQgJiYgKGV2ZW50LndoaWNoID09PSBSSUdIVF9NT1VTRV9CVVRUT05fV0hJQ0ggfHwgZXZlbnQudHlwZSA9PT0gJ2tleXVwJyAmJiBldmVudC53aGljaCAhPT0gVEFCX0tFWUNPREUpKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgdmFyIHRvZ2dsZXMgPSBbXS5zbGljZS5jYWxsKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoU2VsZWN0b3IuREFUQV9UT0dHTEUpKTsNCg0KICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdG9nZ2xlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgew0KICAgICAgICAgIHZhciBwYXJlbnQgPSBEcm9wZG93bi5fZ2V0UGFyZW50RnJvbUVsZW1lbnQodG9nZ2xlc1tpXSk7DQoNCiAgICAgICAgICB2YXIgY29udGV4dCA9ICQkJDEodG9nZ2xlc1tpXSkuZGF0YShEQVRBX0tFWSk7DQogICAgICAgICAgdmFyIHJlbGF0ZWRUYXJnZXQgPSB7DQogICAgICAgICAgICByZWxhdGVkVGFyZ2V0OiB0b2dnbGVzW2ldDQogICAgICAgICAgfTsNCg0KICAgICAgICAgIGlmIChldmVudCAmJiBldmVudC50eXBlID09PSAnY2xpY2snKSB7DQogICAgICAgICAgICByZWxhdGVkVGFyZ2V0LmNsaWNrRXZlbnQgPSBldmVudDsNCiAgICAgICAgICB9DQoNCiAgICAgICAgICBpZiAoIWNvbnRleHQpIHsNCiAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgIH0NCg0KICAgICAgICAgIHZhciBkcm9wZG93bk1lbnUgPSBjb250ZXh0Ll9tZW51Ow0KDQogICAgICAgICAgaWYgKCEkJCQxKHBhcmVudCkuaGFzQ2xhc3MoQ2xhc3NOYW1lLlNIT1cpKSB7DQogICAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgICB9DQoNCiAgICAgICAgICBpZiAoZXZlbnQgJiYgKGV2ZW50LnR5cGUgPT09ICdjbGljaycgJiYgL2lucHV0fHRleHRhcmVhL2kudGVzdChldmVudC50YXJnZXQudGFnTmFtZSkgfHwgZXZlbnQudHlwZSA9PT0gJ2tleXVwJyAmJiBldmVudC53aGljaCA9PT0gVEFCX0tFWUNPREUpICYmICQkJDEuY29udGFpbnMocGFyZW50LCBldmVudC50YXJnZXQpKSB7DQogICAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgICB9DQoNCiAgICAgICAgICB2YXIgaGlkZUV2ZW50ID0gJCQkMS5FdmVudChFdmVudC5ISURFLCByZWxhdGVkVGFyZ2V0KTsNCiAgICAgICAgICAkJCQxKHBhcmVudCkudHJpZ2dlcihoaWRlRXZlbnQpOw0KDQogICAgICAgICAgaWYgKGhpZGVFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgew0KICAgICAgICAgICAgY29udGludWU7DQogICAgICAgICAgfSAvLyBJZiB0aGlzIGlzIGEgdG91Y2gtZW5hYmxlZCBkZXZpY2Ugd2UgcmVtb3ZlIHRoZSBleHRyYQ0KICAgICAgICAgIC8vIGVtcHR5IG1vdXNlb3ZlciBsaXN0ZW5lcnMgd2UgYWRkZWQgZm9yIGlPUyBzdXBwb3J0DQoNCg0KICAgICAgICAgIGlmICgnb250b3VjaHN0YXJ0JyBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpIHsNCiAgICAgICAgICAgICQkJDEoZG9jdW1lbnQuYm9keSkuY2hpbGRyZW4oKS5vZmYoJ21vdXNlb3ZlcicsIG51bGwsICQkJDEubm9vcCk7DQogICAgICAgICAgfQ0KDQogICAgICAgICAgdG9nZ2xlc1tpXS5zZXRBdHRyaWJ1dGUoJ2FyaWEtZXhwYW5kZWQnLCAnZmFsc2UnKTsNCiAgICAgICAgICAkJCQxKGRyb3Bkb3duTWVudSkucmVtb3ZlQ2xhc3MoQ2xhc3NOYW1lLlNIT1cpOw0KICAgICAgICAgICQkJDEocGFyZW50KS5yZW1vdmVDbGFzcyhDbGFzc05hbWUuU0hPVykudHJpZ2dlcigkJCQxLkV2ZW50KEV2ZW50LkhJRERFTiwgcmVsYXRlZFRhcmdldCkpOw0KICAgICAgICB9DQogICAgICB9Ow0KDQogICAgICBEcm9wZG93bi5fZ2V0UGFyZW50RnJvbUVsZW1lbnQgPSBmdW5jdGlvbiBfZ2V0UGFyZW50RnJvbUVsZW1lbnQoZWxlbWVudCkgew0KICAgICAgICB2YXIgcGFyZW50Ow0KICAgICAgICB2YXIgc2VsZWN0b3IgPSBVdGlsLmdldFNlbGVjdG9yRnJvbUVsZW1lbnQoZWxlbWVudCk7DQoNCiAgICAgICAgaWYgKHNlbGVjdG9yKSB7DQogICAgICAgICAgcGFyZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gcGFyZW50IHx8IGVsZW1lbnQucGFyZW50Tm9kZTsNCiAgICAgIH07IC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjb21wbGV4aXR5DQoNCg0KICAgICAgRHJvcGRvd24uX2RhdGFBcGlLZXlkb3duSGFuZGxlciA9IGZ1bmN0aW9uIF9kYXRhQXBpS2V5ZG93bkhhbmRsZXIoZXZlbnQpIHsNCiAgICAgICAgLy8gSWYgbm90IGlucHV0L3RleHRhcmVhOg0KICAgICAgICAvLyAgLSBBbmQgbm90IGEga2V5IGluIFJFR0VYUF9LRVlET1dOID0+IG5vdCBhIGRyb3Bkb3duIGNvbW1hbmQNCiAgICAgICAgLy8gSWYgaW5wdXQvdGV4dGFyZWE6DQogICAgICAgIC8vICAtIElmIHNwYWNlIGtleSA9PiBub3QgYSBkcm9wZG93biBjb21tYW5kDQogICAgICAgIC8vICAtIElmIGtleSBpcyBvdGhlciB0aGFuIGVzY2FwZQ0KICAgICAgICAvLyAgICAtIElmIGtleSBpcyBub3QgdXAgb3IgZG93biA9PiBub3QgYSBkcm9wZG93biBjb21tYW5kDQogICAgICAgIC8vICAgIC0gSWYgdHJpZ2dlciBpbnNpZGUgdGhlIG1lbnUgPT4gbm90IGEgZHJvcGRvd24gY29tbWFuZA0KICAgICAgICBpZiAoL2lucHV0fHRleHRhcmVhL2kudGVzdChldmVudC50YXJnZXQudGFnTmFtZSkgPyBldmVudC53aGljaCA9PT0gU1BBQ0VfS0VZQ09ERSB8fCBldmVudC53aGljaCAhPT0gRVNDQVBFX0tFWUNPREUgJiYgKGV2ZW50LndoaWNoICE9PSBBUlJPV19ET1dOX0tFWUNPREUgJiYgZXZlbnQud2hpY2ggIT09IEFSUk9XX1VQX0tFWUNPREUgfHwgJCQkMShldmVudC50YXJnZXQpLmNsb3Nlc3QoU2VsZWN0b3IuTUVOVSkubGVuZ3RoKSA6ICFSRUdFWFBfS0VZRE9XTi50ZXN0KGV2ZW50LndoaWNoKSkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQogICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOw0KDQogICAgICAgIGlmICh0aGlzLmRpc2FibGVkIHx8ICQkJDEodGhpcykuaGFzQ2xhc3MoQ2xhc3NOYW1lLkRJU0FCTEVEKSkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIHZhciBwYXJlbnQgPSBEcm9wZG93bi5fZ2V0UGFyZW50RnJvbUVsZW1lbnQodGhpcyk7DQoNCiAgICAgICAgdmFyIGlzQWN0aXZlID0gJCQkMShwYXJlbnQpLmhhc0NsYXNzKENsYXNzTmFtZS5TSE9XKTsNCg0KICAgICAgICBpZiAoIWlzQWN0aXZlICYmIChldmVudC53aGljaCAhPT0gRVNDQVBFX0tFWUNPREUgfHwgZXZlbnQud2hpY2ggIT09IFNQQUNFX0tFWUNPREUpIHx8IGlzQWN0aXZlICYmIChldmVudC53aGljaCA9PT0gRVNDQVBFX0tFWUNPREUgfHwgZXZlbnQud2hpY2ggPT09IFNQQUNFX0tFWUNPREUpKSB7DQogICAgICAgICAgaWYgKGV2ZW50LndoaWNoID09PSBFU0NBUEVfS0VZQ09ERSkgew0KICAgICAgICAgICAgdmFyIHRvZ2dsZSA9IHBhcmVudC5xdWVyeVNlbGVjdG9yKFNlbGVjdG9yLkRBVEFfVE9HR0xFKTsNCiAgICAgICAgICAgICQkJDEodG9nZ2xlKS50cmlnZ2VyKCdmb2N1cycpOw0KICAgICAgICAgIH0NCg0KICAgICAgICAgICQkJDEodGhpcykudHJpZ2dlcignY2xpY2snKTsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICB2YXIgaXRlbXMgPSBbXS5zbGljZS5jYWxsKHBhcmVudC5xdWVyeVNlbGVjdG9yQWxsKFNlbGVjdG9yLlZJU0lCTEVfSVRFTVMpKTsNCg0KICAgICAgICBpZiAoaXRlbXMubGVuZ3RoID09PSAwKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgdmFyIGluZGV4ID0gaXRlbXMuaW5kZXhPZihldmVudC50YXJnZXQpOw0KDQogICAgICAgIGlmIChldmVudC53aGljaCA9PT0gQVJST1dfVVBfS0VZQ09ERSAmJiBpbmRleCA+IDApIHsNCiAgICAgICAgICAvLyBVcA0KICAgICAgICAgIGluZGV4LS07DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoZXZlbnQud2hpY2ggPT09IEFSUk9XX0RPV05fS0VZQ09ERSAmJiBpbmRleCA8IGl0ZW1zLmxlbmd0aCAtIDEpIHsNCiAgICAgICAgICAvLyBEb3duDQogICAgICAgICAgaW5kZXgrKzsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChpbmRleCA8IDApIHsNCiAgICAgICAgICBpbmRleCA9IDA7DQogICAgICAgIH0NCg0KICAgICAgICBpdGVtc1tpbmRleF0uZm9jdXMoKTsNCiAgICAgIH07DQoNCiAgICAgIF9jcmVhdGVDbGFzcyhEcm9wZG93biwgbnVsbCwgW3sNCiAgICAgICAga2V5OiAiVkVSU0lPTiIsDQogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgew0KICAgICAgICAgIHJldHVybiBWRVJTSU9OOw0KICAgICAgICB9DQogICAgICB9LCB7DQogICAgICAgIGtleTogIkRlZmF1bHQiLA0KICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsNCiAgICAgICAgICByZXR1cm4gRGVmYXVsdDsNCiAgICAgICAgfQ0KICAgICAgfSwgew0KICAgICAgICBrZXk6ICJEZWZhdWx0VHlwZSIsDQogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgew0KICAgICAgICAgIHJldHVybiBEZWZhdWx0VHlwZTsNCiAgICAgICAgfQ0KICAgICAgfV0pOw0KDQogICAgICByZXR1cm4gRHJvcGRvd247DQogICAgfSgpOw0KICAgIC8qKg0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqIERhdGEgQXBpIGltcGxlbWVudGF0aW9uDQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICovDQoNCg0KICAgICQkJDEoZG9jdW1lbnQpLm9uKEV2ZW50LktFWURPV05fREFUQV9BUEksIFNlbGVjdG9yLkRBVEFfVE9HR0xFLCBEcm9wZG93bi5fZGF0YUFwaUtleWRvd25IYW5kbGVyKS5vbihFdmVudC5LRVlET1dOX0RBVEFfQVBJLCBTZWxlY3Rvci5NRU5VLCBEcm9wZG93bi5fZGF0YUFwaUtleWRvd25IYW5kbGVyKS5vbihFdmVudC5DTElDS19EQVRBX0FQSSArICIgIiArIEV2ZW50LktFWVVQX0RBVEFfQVBJLCBEcm9wZG93bi5fY2xlYXJNZW51cykub24oRXZlbnQuQ0xJQ0tfREFUQV9BUEksIFNlbGVjdG9yLkRBVEFfVE9HR0xFLCBmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQogICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsNCg0KICAgICAgRHJvcGRvd24uX2pRdWVyeUludGVyZmFjZS5jYWxsKCQkJDEodGhpcyksICd0b2dnbGUnKTsNCiAgICB9KS5vbihFdmVudC5DTElDS19EQVRBX0FQSSwgU2VsZWN0b3IuRk9STV9DSElMRCwgZnVuY3Rpb24gKGUpIHsNCiAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7DQogICAgfSk7DQogICAgLyoqDQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICogalF1ZXJ5DQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICovDQoNCiAgICAkJCQxLmZuW05BTUVdID0gRHJvcGRvd24uX2pRdWVyeUludGVyZmFjZTsNCiAgICAkJCQxLmZuW05BTUVdLkNvbnN0cnVjdG9yID0gRHJvcGRvd247DQoNCiAgICAkJCQxLmZuW05BTUVdLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7DQogICAgICAkJCQxLmZuW05BTUVdID0gSlFVRVJZX05PX0NPTkZMSUNUOw0KICAgICAgcmV0dXJuIERyb3Bkb3duLl9qUXVlcnlJbnRlcmZhY2U7DQogICAgfTsNCg0KICAgIHJldHVybiBEcm9wZG93bjsNCiAgfSgkLCBQb3BwZXIpOw0KDQogIC8qKg0KICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgKiBCb290c3RyYXAgKHY0LjEuMyk6IG1vZGFsLmpzDQogICAqIExpY2Vuc2VkIHVuZGVyIE1JVCAoaHR0cHM6Ly9naXRodWIuY29tL3R3YnMvYm9vdHN0cmFwL2Jsb2IvbWFzdGVyL0xJQ0VOU0UpDQogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAqLw0KDQogIHZhciBNb2RhbCA9IGZ1bmN0aW9uICgkJCQxKSB7DQogICAgLyoqDQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICogQ29uc3RhbnRzDQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICovDQogICAgdmFyIE5BTUUgPSAnbW9kYWwnOw0KICAgIHZhciBWRVJTSU9OID0gJzQuMS4zJzsNCiAgICB2YXIgREFUQV9LRVkgPSAnYnMubW9kYWwnOw0KICAgIHZhciBFVkVOVF9LRVkgPSAiLiIgKyBEQVRBX0tFWTsNCiAgICB2YXIgREFUQV9BUElfS0VZID0gJy5kYXRhLWFwaSc7DQogICAgdmFyIEpRVUVSWV9OT19DT05GTElDVCA9ICQkJDEuZm5bTkFNRV07DQogICAgdmFyIEVTQ0FQRV9LRVlDT0RFID0gMjc7IC8vIEtleWJvYXJkRXZlbnQud2hpY2ggdmFsdWUgZm9yIEVzY2FwZSAoRXNjKSBrZXkNCg0KICAgIHZhciBEZWZhdWx0ID0gew0KICAgICAgYmFja2Ryb3A6IHRydWUsDQogICAgICBrZXlib2FyZDogdHJ1ZSwNCiAgICAgIGZvY3VzOiB0cnVlLA0KICAgICAgc2hvdzogdHJ1ZQ0KICAgIH07DQogICAgdmFyIERlZmF1bHRUeXBlID0gew0KICAgICAgYmFja2Ryb3A6ICcoYm9vbGVhbnxzdHJpbmcpJywNCiAgICAgIGtleWJvYXJkOiAnYm9vbGVhbicsDQogICAgICBmb2N1czogJ2Jvb2xlYW4nLA0KICAgICAgc2hvdzogJ2Jvb2xlYW4nDQogICAgfTsNCiAgICB2YXIgRXZlbnQgPSB7DQogICAgICBISURFOiAiaGlkZSIgKyBFVkVOVF9LRVksDQogICAgICBISURERU46ICJoaWRkZW4iICsgRVZFTlRfS0VZLA0KICAgICAgU0hPVzogInNob3ciICsgRVZFTlRfS0VZLA0KICAgICAgU0hPV046ICJzaG93biIgKyBFVkVOVF9LRVksDQogICAgICBGT0NVU0lOOiAiZm9jdXNpbiIgKyBFVkVOVF9LRVksDQogICAgICBSRVNJWkU6ICJyZXNpemUiICsgRVZFTlRfS0VZLA0KICAgICAgQ0xJQ0tfRElTTUlTUzogImNsaWNrLmRpc21pc3MiICsgRVZFTlRfS0VZLA0KICAgICAgS0VZRE9XTl9ESVNNSVNTOiAia2V5ZG93bi5kaXNtaXNzIiArIEVWRU5UX0tFWSwNCiAgICAgIE1PVVNFVVBfRElTTUlTUzogIm1vdXNldXAuZGlzbWlzcyIgKyBFVkVOVF9LRVksDQogICAgICBNT1VTRURPV05fRElTTUlTUzogIm1vdXNlZG93bi5kaXNtaXNzIiArIEVWRU5UX0tFWSwNCiAgICAgIENMSUNLX0RBVEFfQVBJOiAiY2xpY2siICsgRVZFTlRfS0VZICsgREFUQV9BUElfS0VZDQogICAgfTsNCiAgICB2YXIgQ2xhc3NOYW1lID0gew0KICAgICAgU0NST0xMQkFSX01FQVNVUkVSOiAnbW9kYWwtc2Nyb2xsYmFyLW1lYXN1cmUnLA0KICAgICAgQkFDS0RST1A6ICdtb2RhbC1iYWNrZHJvcCcsDQogICAgICBPUEVOOiAnbW9kYWwtb3BlbicsDQogICAgICBGQURFOiAnZmFkZScsDQogICAgICBTSE9XOiAnc2hvdycNCiAgICB9Ow0KICAgIHZhciBTZWxlY3RvciA9IHsNCiAgICAgIERJQUxPRzogJy5tb2RhbC1kaWFsb2cnLA0KICAgICAgREFUQV9UT0dHTEU6ICdbZGF0YS10b2dnbGU9Im1vZGFsIl0nLA0KICAgICAgREFUQV9ESVNNSVNTOiAnW2RhdGEtZGlzbWlzcz0ibW9kYWwiXScsDQogICAgICBGSVhFRF9DT05URU5UOiAnLmZpeGVkLXRvcCwgLmZpeGVkLWJvdHRvbSwgLmlzLWZpeGVkLCAuc3RpY2t5LXRvcCcsDQogICAgICBTVElDS1lfQ09OVEVOVDogJy5zdGlja3ktdG9wJw0KICAgICAgLyoqDQogICAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgICAqIENsYXNzIERlZmluaXRpb24NCiAgICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAgICovDQoNCiAgICB9Ow0KDQogICAgdmFyIE1vZGFsID0NCiAgICAvKiNfX1BVUkVfXyovDQogICAgZnVuY3Rpb24gKCkgew0KICAgICAgZnVuY3Rpb24gTW9kYWwoZWxlbWVudCwgY29uZmlnKSB7DQogICAgICAgIHRoaXMuX2NvbmZpZyA9IHRoaXMuX2dldENvbmZpZyhjb25maWcpOw0KICAgICAgICB0aGlzLl9lbGVtZW50ID0gZWxlbWVudDsNCiAgICAgICAgdGhpcy5fZGlhbG9nID0gZWxlbWVudC5xdWVyeVNlbGVjdG9yKFNlbGVjdG9yLkRJQUxPRyk7DQogICAgICAgIHRoaXMuX2JhY2tkcm9wID0gbnVsbDsNCiAgICAgICAgdGhpcy5faXNTaG93biA9IGZhbHNlOw0KICAgICAgICB0aGlzLl9pc0JvZHlPdmVyZmxvd2luZyA9IGZhbHNlOw0KICAgICAgICB0aGlzLl9pZ25vcmVCYWNrZHJvcENsaWNrID0gZmFsc2U7DQogICAgICAgIHRoaXMuX3Njcm9sbGJhcldpZHRoID0gMDsNCiAgICAgIH0gLy8gR2V0dGVycw0KDQoNCiAgICAgIHZhciBfcHJvdG8gPSBNb2RhbC5wcm90b3R5cGU7DQoNCiAgICAgIC8vIFB1YmxpYw0KICAgICAgX3Byb3RvLnRvZ2dsZSA9IGZ1bmN0aW9uIHRvZ2dsZShyZWxhdGVkVGFyZ2V0KSB7DQogICAgICAgIHJldHVybiB0aGlzLl9pc1Nob3duID8gdGhpcy5oaWRlKCkgOiB0aGlzLnNob3cocmVsYXRlZFRhcmdldCk7DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uc2hvdyA9IGZ1bmN0aW9uIHNob3cocmVsYXRlZFRhcmdldCkgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KDQogICAgICAgIGlmICh0aGlzLl9pc1RyYW5zaXRpb25pbmcgfHwgdGhpcy5faXNTaG93bikgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmICgkJCQxKHRoaXMuX2VsZW1lbnQpLmhhc0NsYXNzKENsYXNzTmFtZS5GQURFKSkgew0KICAgICAgICAgIHRoaXMuX2lzVHJhbnNpdGlvbmluZyA9IHRydWU7DQogICAgICAgIH0NCg0KICAgICAgICB2YXIgc2hvd0V2ZW50ID0gJCQkMS5FdmVudChFdmVudC5TSE9XLCB7DQogICAgICAgICAgcmVsYXRlZFRhcmdldDogcmVsYXRlZFRhcmdldA0KICAgICAgICB9KTsNCiAgICAgICAgJCQkMSh0aGlzLl9lbGVtZW50KS50cmlnZ2VyKHNob3dFdmVudCk7DQoNCiAgICAgICAgaWYgKHRoaXMuX2lzU2hvd24gfHwgc2hvd0V2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgdGhpcy5faXNTaG93biA9IHRydWU7DQoNCiAgICAgICAgdGhpcy5fY2hlY2tTY3JvbGxiYXIoKTsNCg0KICAgICAgICB0aGlzLl9zZXRTY3JvbGxiYXIoKTsNCg0KICAgICAgICB0aGlzLl9hZGp1c3REaWFsb2coKTsNCg0KICAgICAgICAkJCQxKGRvY3VtZW50LmJvZHkpLmFkZENsYXNzKENsYXNzTmFtZS5PUEVOKTsNCg0KICAgICAgICB0aGlzLl9zZXRFc2NhcGVFdmVudCgpOw0KDQogICAgICAgIHRoaXMuX3NldFJlc2l6ZUV2ZW50KCk7DQoNCiAgICAgICAgJCQkMSh0aGlzLl9lbGVtZW50KS5vbihFdmVudC5DTElDS19ESVNNSVNTLCBTZWxlY3Rvci5EQVRBX0RJU01JU1MsIGZ1bmN0aW9uIChldmVudCkgew0KICAgICAgICAgIHJldHVybiBfdGhpcy5oaWRlKGV2ZW50KTsNCiAgICAgICAgfSk7DQogICAgICAgICQkJDEodGhpcy5fZGlhbG9nKS5vbihFdmVudC5NT1VTRURPV05fRElTTUlTUywgZnVuY3Rpb24gKCkgew0KICAgICAgICAgICQkJDEoX3RoaXMuX2VsZW1lbnQpLm9uZShFdmVudC5NT1VTRVVQX0RJU01JU1MsIGZ1bmN0aW9uIChldmVudCkgew0KICAgICAgICAgICAgaWYgKCQkJDEoZXZlbnQudGFyZ2V0KS5pcyhfdGhpcy5fZWxlbWVudCkpIHsNCiAgICAgICAgICAgICAgX3RoaXMuX2lnbm9yZUJhY2tkcm9wQ2xpY2sgPSB0cnVlOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0pOw0KICAgICAgICB9KTsNCg0KICAgICAgICB0aGlzLl9zaG93QmFja2Ryb3AoZnVuY3Rpb24gKCkgew0KICAgICAgICAgIHJldHVybiBfdGhpcy5fc2hvd0VsZW1lbnQocmVsYXRlZFRhcmdldCk7DQogICAgICAgIH0pOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLmhpZGUgPSBmdW5jdGlvbiBoaWRlKGV2ZW50KSB7DQogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOw0KDQogICAgICAgIGlmIChldmVudCkgew0KICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAodGhpcy5faXNUcmFuc2l0aW9uaW5nIHx8ICF0aGlzLl9pc1Nob3duKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgdmFyIGhpZGVFdmVudCA9ICQkJDEuRXZlbnQoRXZlbnQuSElERSk7DQogICAgICAgICQkJDEodGhpcy5fZWxlbWVudCkudHJpZ2dlcihoaWRlRXZlbnQpOw0KDQogICAgICAgIGlmICghdGhpcy5faXNTaG93biB8fCBoaWRlRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkpIHsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICB0aGlzLl9pc1Nob3duID0gZmFsc2U7DQogICAgICAgIHZhciB0cmFuc2l0aW9uID0gJCQkMSh0aGlzLl9lbGVtZW50KS5oYXNDbGFzcyhDbGFzc05hbWUuRkFERSk7DQoNCiAgICAgICAgaWYgKHRyYW5zaXRpb24pIHsNCiAgICAgICAgICB0aGlzLl9pc1RyYW5zaXRpb25pbmcgPSB0cnVlOw0KICAgICAgICB9DQoNCiAgICAgICAgdGhpcy5fc2V0RXNjYXBlRXZlbnQoKTsNCg0KICAgICAgICB0aGlzLl9zZXRSZXNpemVFdmVudCgpOw0KDQogICAgICAgICQkJDEoZG9jdW1lbnQpLm9mZihFdmVudC5GT0NVU0lOKTsNCiAgICAgICAgJCQkMSh0aGlzLl9lbGVtZW50KS5yZW1vdmVDbGFzcyhDbGFzc05hbWUuU0hPVyk7DQogICAgICAgICQkJDEodGhpcy5fZWxlbWVudCkub2ZmKEV2ZW50LkNMSUNLX0RJU01JU1MpOw0KICAgICAgICAkJCQxKHRoaXMuX2RpYWxvZykub2ZmKEV2ZW50Lk1PVVNFRE9XTl9ESVNNSVNTKTsNCg0KICAgICAgICBpZiAodHJhbnNpdGlvbikgew0KICAgICAgICAgIHZhciB0cmFuc2l0aW9uRHVyYXRpb24gPSBVdGlsLmdldFRyYW5zaXRpb25EdXJhdGlvbkZyb21FbGVtZW50KHRoaXMuX2VsZW1lbnQpOw0KICAgICAgICAgICQkJDEodGhpcy5fZWxlbWVudCkub25lKFV0aWwuVFJBTlNJVElPTl9FTkQsIGZ1bmN0aW9uIChldmVudCkgew0KICAgICAgICAgICAgcmV0dXJuIF90aGlzMi5faGlkZU1vZGFsKGV2ZW50KTsNCiAgICAgICAgICB9KS5lbXVsYXRlVHJhbnNpdGlvbkVuZCh0cmFuc2l0aW9uRHVyYXRpb24pOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHRoaXMuX2hpZGVNb2RhbCgpOw0KICAgICAgICB9DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uZGlzcG9zZSA9IGZ1bmN0aW9uIGRpc3Bvc2UoKSB7DQogICAgICAgICQkJDEucmVtb3ZlRGF0YSh0aGlzLl9lbGVtZW50LCBEQVRBX0tFWSk7DQogICAgICAgICQkJDEod2luZG93LCBkb2N1bWVudCwgdGhpcy5fZWxlbWVudCwgdGhpcy5fYmFja2Ryb3ApLm9mZihFVkVOVF9LRVkpOw0KICAgICAgICB0aGlzLl9jb25maWcgPSBudWxsOw0KICAgICAgICB0aGlzLl9lbGVtZW50ID0gbnVsbDsNCiAgICAgICAgdGhpcy5fZGlhbG9nID0gbnVsbDsNCiAgICAgICAgdGhpcy5fYmFja2Ryb3AgPSBudWxsOw0KICAgICAgICB0aGlzLl9pc1Nob3duID0gbnVsbDsNCiAgICAgICAgdGhpcy5faXNCb2R5T3ZlcmZsb3dpbmcgPSBudWxsOw0KICAgICAgICB0aGlzLl9pZ25vcmVCYWNrZHJvcENsaWNrID0gbnVsbDsNCiAgICAgICAgdGhpcy5fc2Nyb2xsYmFyV2lkdGggPSBudWxsOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLmhhbmRsZVVwZGF0ZSA9IGZ1bmN0aW9uIGhhbmRsZVVwZGF0ZSgpIHsNCiAgICAgICAgdGhpcy5fYWRqdXN0RGlhbG9nKCk7DQogICAgICB9OyAvLyBQcml2YXRlDQoNCg0KICAgICAgX3Byb3RvLl9nZXRDb25maWcgPSBmdW5jdGlvbiBfZ2V0Q29uZmlnKGNvbmZpZykgew0KICAgICAgICBjb25maWcgPSBfb2JqZWN0U3ByZWFkKHt9LCBEZWZhdWx0LCBjb25maWcpOw0KICAgICAgICBVdGlsLnR5cGVDaGVja0NvbmZpZyhOQU1FLCBjb25maWcsIERlZmF1bHRUeXBlKTsNCiAgICAgICAgcmV0dXJuIGNvbmZpZzsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5fc2hvd0VsZW1lbnQgPSBmdW5jdGlvbiBfc2hvd0VsZW1lbnQocmVsYXRlZFRhcmdldCkgew0KICAgICAgICB2YXIgX3RoaXMzID0gdGhpczsNCg0KICAgICAgICB2YXIgdHJhbnNpdGlvbiA9ICQkJDEodGhpcy5fZWxlbWVudCkuaGFzQ2xhc3MoQ2xhc3NOYW1lLkZBREUpOw0KDQogICAgICAgIGlmICghdGhpcy5fZWxlbWVudC5wYXJlbnROb2RlIHx8IHRoaXMuX2VsZW1lbnQucGFyZW50Tm9kZS5ub2RlVHlwZSAhPT0gTm9kZS5FTEVNRU5UX05PREUpIHsNCiAgICAgICAgICAvLyBEb24ndCBtb3ZlIG1vZGFsJ3MgRE9NIHBvc2l0aW9uDQogICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLl9lbGVtZW50KTsNCiAgICAgICAgfQ0KDQogICAgICAgIHRoaXMuX2VsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7DQoNCiAgICAgICAgdGhpcy5fZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoJ2FyaWEtaGlkZGVuJyk7DQoNCiAgICAgICAgdGhpcy5fZWxlbWVudC5zY3JvbGxUb3AgPSAwOw0KDQogICAgICAgIGlmICh0cmFuc2l0aW9uKSB7DQogICAgICAgICAgVXRpbC5yZWZsb3codGhpcy5fZWxlbWVudCk7DQogICAgICAgIH0NCg0KICAgICAgICAkJCQxKHRoaXMuX2VsZW1lbnQpLmFkZENsYXNzKENsYXNzTmFtZS5TSE9XKTsNCg0KICAgICAgICBpZiAodGhpcy5fY29uZmlnLmZvY3VzKSB7DQogICAgICAgICAgdGhpcy5fZW5mb3JjZUZvY3VzKCk7DQogICAgICAgIH0NCg0KICAgICAgICB2YXIgc2hvd25FdmVudCA9ICQkJDEuRXZlbnQoRXZlbnQuU0hPV04sIHsNCiAgICAgICAgICByZWxhdGVkVGFyZ2V0OiByZWxhdGVkVGFyZ2V0DQogICAgICAgIH0pOw0KDQogICAgICAgIHZhciB0cmFuc2l0aW9uQ29tcGxldGUgPSBmdW5jdGlvbiB0cmFuc2l0aW9uQ29tcGxldGUoKSB7DQogICAgICAgICAgaWYgKF90aGlzMy5fY29uZmlnLmZvY3VzKSB7DQogICAgICAgICAgICBfdGhpczMuX2VsZW1lbnQuZm9jdXMoKTsNCiAgICAgICAgICB9DQoNCiAgICAgICAgICBfdGhpczMuX2lzVHJhbnNpdGlvbmluZyA9IGZhbHNlOw0KICAgICAgICAgICQkJDEoX3RoaXMzLl9lbGVtZW50KS50cmlnZ2VyKHNob3duRXZlbnQpOw0KICAgICAgICB9Ow0KDQogICAgICAgIGlmICh0cmFuc2l0aW9uKSB7DQogICAgICAgICAgdmFyIHRyYW5zaXRpb25EdXJhdGlvbiA9IFV0aWwuZ2V0VHJhbnNpdGlvbkR1cmF0aW9uRnJvbUVsZW1lbnQodGhpcy5fZWxlbWVudCk7DQogICAgICAgICAgJCQkMSh0aGlzLl9kaWFsb2cpLm9uZShVdGlsLlRSQU5TSVRJT05fRU5ELCB0cmFuc2l0aW9uQ29tcGxldGUpLmVtdWxhdGVUcmFuc2l0aW9uRW5kKHRyYW5zaXRpb25EdXJhdGlvbik7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgdHJhbnNpdGlvbkNvbXBsZXRlKCk7DQogICAgICAgIH0NCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5fZW5mb3JjZUZvY3VzID0gZnVuY3Rpb24gX2VuZm9yY2VGb2N1cygpIHsNCiAgICAgICAgdmFyIF90aGlzNCA9IHRoaXM7DQoNCiAgICAgICAgJCQkMShkb2N1bWVudCkub2ZmKEV2ZW50LkZPQ1VTSU4pIC8vIEd1YXJkIGFnYWluc3QgaW5maW5pdGUgZm9jdXMgbG9vcA0KICAgICAgICAub24oRXZlbnQuRk9DVVNJTiwgZnVuY3Rpb24gKGV2ZW50KSB7DQogICAgICAgICAgaWYgKGRvY3VtZW50ICE9PSBldmVudC50YXJnZXQgJiYgX3RoaXM0Ll9lbGVtZW50ICE9PSBldmVudC50YXJnZXQgJiYgJCQkMShfdGhpczQuX2VsZW1lbnQpLmhhcyhldmVudC50YXJnZXQpLmxlbmd0aCA9PT0gMCkgew0KICAgICAgICAgICAgX3RoaXM0Ll9lbGVtZW50LmZvY3VzKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5fc2V0RXNjYXBlRXZlbnQgPSBmdW5jdGlvbiBfc2V0RXNjYXBlRXZlbnQoKSB7DQogICAgICAgIHZhciBfdGhpczUgPSB0aGlzOw0KDQogICAgICAgIGlmICh0aGlzLl9pc1Nob3duICYmIHRoaXMuX2NvbmZpZy5rZXlib2FyZCkgew0KICAgICAgICAgICQkJDEodGhpcy5fZWxlbWVudCkub24oRXZlbnQuS0VZRE9XTl9ESVNNSVNTLCBmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgICAgICAgIGlmIChldmVudC53aGljaCA9PT0gRVNDQVBFX0tFWUNPREUpIHsNCiAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsNCg0KICAgICAgICAgICAgICBfdGhpczUuaGlkZSgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0pOw0KICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLl9pc1Nob3duKSB7DQogICAgICAgICAgJCQkMSh0aGlzLl9lbGVtZW50KS5vZmYoRXZlbnQuS0VZRE9XTl9ESVNNSVNTKTsNCiAgICAgICAgfQ0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9zZXRSZXNpemVFdmVudCA9IGZ1bmN0aW9uIF9zZXRSZXNpemVFdmVudCgpIHsNCiAgICAgICAgdmFyIF90aGlzNiA9IHRoaXM7DQoNCiAgICAgICAgaWYgKHRoaXMuX2lzU2hvd24pIHsNCiAgICAgICAgICAkJCQxKHdpbmRvdykub24oRXZlbnQuUkVTSVpFLCBmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgICAgICAgIHJldHVybiBfdGhpczYuaGFuZGxlVXBkYXRlKGV2ZW50KTsNCiAgICAgICAgICB9KTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAkJCQxKHdpbmRvdykub2ZmKEV2ZW50LlJFU0laRSk7DQogICAgICAgIH0NCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5faGlkZU1vZGFsID0gZnVuY3Rpb24gX2hpZGVNb2RhbCgpIHsNCiAgICAgICAgdmFyIF90aGlzNyA9IHRoaXM7DQoNCiAgICAgICAgdGhpcy5fZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOw0KDQogICAgICAgIHRoaXMuX2VsZW1lbnQuc2V0QXR0cmlidXRlKCdhcmlhLWhpZGRlbicsIHRydWUpOw0KDQogICAgICAgIHRoaXMuX2lzVHJhbnNpdGlvbmluZyA9IGZhbHNlOw0KDQogICAgICAgIHRoaXMuX3Nob3dCYWNrZHJvcChmdW5jdGlvbiAoKSB7DQogICAgICAgICAgJCQkMShkb2N1bWVudC5ib2R5KS5yZW1vdmVDbGFzcyhDbGFzc05hbWUuT1BFTik7DQoNCiAgICAgICAgICBfdGhpczcuX3Jlc2V0QWRqdXN0bWVudHMoKTsNCg0KICAgICAgICAgIF90aGlzNy5fcmVzZXRTY3JvbGxiYXIoKTsNCg0KICAgICAgICAgICQkJDEoX3RoaXM3Ll9lbGVtZW50KS50cmlnZ2VyKEV2ZW50LkhJRERFTik7DQogICAgICAgIH0pOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9yZW1vdmVCYWNrZHJvcCA9IGZ1bmN0aW9uIF9yZW1vdmVCYWNrZHJvcCgpIHsNCiAgICAgICAgaWYgKHRoaXMuX2JhY2tkcm9wKSB7DQogICAgICAgICAgJCQkMSh0aGlzLl9iYWNrZHJvcCkucmVtb3ZlKCk7DQogICAgICAgICAgdGhpcy5fYmFja2Ryb3AgPSBudWxsOw0KICAgICAgICB9DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uX3Nob3dCYWNrZHJvcCA9IGZ1bmN0aW9uIF9zaG93QmFja2Ryb3AoY2FsbGJhY2spIHsNCiAgICAgICAgdmFyIF90aGlzOCA9IHRoaXM7DQoNCiAgICAgICAgdmFyIGFuaW1hdGUgPSAkJCQxKHRoaXMuX2VsZW1lbnQpLmhhc0NsYXNzKENsYXNzTmFtZS5GQURFKSA/IENsYXNzTmFtZS5GQURFIDogJyc7DQoNCiAgICAgICAgaWYgKHRoaXMuX2lzU2hvd24gJiYgdGhpcy5fY29uZmlnLmJhY2tkcm9wKSB7DQogICAgICAgICAgdGhpcy5fYmFja2Ryb3AgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsNCiAgICAgICAgICB0aGlzLl9iYWNrZHJvcC5jbGFzc05hbWUgPSBDbGFzc05hbWUuQkFDS0RST1A7DQoNCiAgICAgICAgICBpZiAoYW5pbWF0ZSkgew0KICAgICAgICAgICAgdGhpcy5fYmFja2Ryb3AuY2xhc3NMaXN0LmFkZChhbmltYXRlKTsNCiAgICAgICAgICB9DQoNCiAgICAgICAgICAkJCQxKHRoaXMuX2JhY2tkcm9wKS5hcHBlbmRUbyhkb2N1bWVudC5ib2R5KTsNCiAgICAgICAgICAkJCQxKHRoaXMuX2VsZW1lbnQpLm9uKEV2ZW50LkNMSUNLX0RJU01JU1MsIGZ1bmN0aW9uIChldmVudCkgew0KICAgICAgICAgICAgaWYgKF90aGlzOC5faWdub3JlQmFja2Ryb3BDbGljaykgew0KICAgICAgICAgICAgICBfdGhpczguX2lnbm9yZUJhY2tkcm9wQ2xpY2sgPSBmYWxzZTsNCiAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZiAoZXZlbnQudGFyZ2V0ICE9PSBldmVudC5jdXJyZW50VGFyZ2V0KSB7DQogICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYgKF90aGlzOC5fY29uZmlnLmJhY2tkcm9wID09PSAnc3RhdGljJykgew0KICAgICAgICAgICAgICBfdGhpczguX2VsZW1lbnQuZm9jdXMoKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgIF90aGlzOC5oaWRlKCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgfSk7DQoNCiAgICAgICAgICBpZiAoYW5pbWF0ZSkgew0KICAgICAgICAgICAgVXRpbC5yZWZsb3codGhpcy5fYmFja2Ryb3ApOw0KICAgICAgICAgIH0NCg0KICAgICAgICAgICQkJDEodGhpcy5fYmFja2Ryb3ApLmFkZENsYXNzKENsYXNzTmFtZS5TSE9XKTsNCg0KICAgICAgICAgIGlmICghY2FsbGJhY2spIHsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICB9DQoNCiAgICAgICAgICBpZiAoIWFuaW1hdGUpIHsNCiAgICAgICAgICAgIGNhbGxiYWNrKCk7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgfQ0KDQogICAgICAgICAgdmFyIGJhY2tkcm9wVHJhbnNpdGlvbkR1cmF0aW9uID0gVXRpbC5nZXRUcmFuc2l0aW9uRHVyYXRpb25Gcm9tRWxlbWVudCh0aGlzLl9iYWNrZHJvcCk7DQogICAgICAgICAgJCQkMSh0aGlzLl9iYWNrZHJvcCkub25lKFV0aWwuVFJBTlNJVElPTl9FTkQsIGNhbGxiYWNrKS5lbXVsYXRlVHJhbnNpdGlvbkVuZChiYWNrZHJvcFRyYW5zaXRpb25EdXJhdGlvbik7DQogICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuX2lzU2hvd24gJiYgdGhpcy5fYmFja2Ryb3ApIHsNCiAgICAgICAgICAkJCQxKHRoaXMuX2JhY2tkcm9wKS5yZW1vdmVDbGFzcyhDbGFzc05hbWUuU0hPVyk7DQoNCiAgICAgICAgICB2YXIgY2FsbGJhY2tSZW1vdmUgPSBmdW5jdGlvbiBjYWxsYmFja1JlbW92ZSgpIHsNCiAgICAgICAgICAgIF90aGlzOC5fcmVtb3ZlQmFja2Ryb3AoKTsNCg0KICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7DQogICAgICAgICAgICAgIGNhbGxiYWNrKCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgfTsNCg0KICAgICAgICAgIGlmICgkJCQxKHRoaXMuX2VsZW1lbnQpLmhhc0NsYXNzKENsYXNzTmFtZS5GQURFKSkgew0KICAgICAgICAgICAgdmFyIF9iYWNrZHJvcFRyYW5zaXRpb25EdXJhdGlvbiA9IFV0aWwuZ2V0VHJhbnNpdGlvbkR1cmF0aW9uRnJvbUVsZW1lbnQodGhpcy5fYmFja2Ryb3ApOw0KDQogICAgICAgICAgICAkJCQxKHRoaXMuX2JhY2tkcm9wKS5vbmUoVXRpbC5UUkFOU0lUSU9OX0VORCwgY2FsbGJhY2tSZW1vdmUpLmVtdWxhdGVUcmFuc2l0aW9uRW5kKF9iYWNrZHJvcFRyYW5zaXRpb25EdXJhdGlvbik7DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIGNhbGxiYWNrUmVtb3ZlKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrKSB7DQogICAgICAgICAgY2FsbGJhY2soKTsNCiAgICAgICAgfQ0KICAgICAgfTsgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAgLy8gdGhlIGZvbGxvd2luZyBtZXRob2RzIGFyZSB1c2VkIHRvIGhhbmRsZSBvdmVyZmxvd2luZyBtb2RhbHMNCiAgICAgIC8vIHRvZG8gKGZhdCk6IHRoZXNlIHNob3VsZCBwcm9iYWJseSBiZSByZWZhY3RvcmVkIG91dCBvZiBtb2RhbC5qcw0KICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KDQoNCiAgICAgIF9wcm90by5fYWRqdXN0RGlhbG9nID0gZnVuY3Rpb24gX2FkanVzdERpYWxvZygpIHsNCiAgICAgICAgdmFyIGlzTW9kYWxPdmVyZmxvd2luZyA9IHRoaXMuX2VsZW1lbnQuc2Nyb2xsSGVpZ2h0ID4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodDsNCg0KICAgICAgICBpZiAoIXRoaXMuX2lzQm9keU92ZXJmbG93aW5nICYmIGlzTW9kYWxPdmVyZmxvd2luZykgew0KICAgICAgICAgIHRoaXMuX2VsZW1lbnQuc3R5bGUucGFkZGluZ0xlZnQgPSB0aGlzLl9zY3JvbGxiYXJXaWR0aCArICJweCI7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAodGhpcy5faXNCb2R5T3ZlcmZsb3dpbmcgJiYgIWlzTW9kYWxPdmVyZmxvd2luZykgew0KICAgICAgICAgIHRoaXMuX2VsZW1lbnQuc3R5bGUucGFkZGluZ1JpZ2h0ID0gdGhpcy5fc2Nyb2xsYmFyV2lkdGggKyAicHgiOw0KICAgICAgICB9DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uX3Jlc2V0QWRqdXN0bWVudHMgPSBmdW5jdGlvbiBfcmVzZXRBZGp1c3RtZW50cygpIHsNCiAgICAgICAgdGhpcy5fZWxlbWVudC5zdHlsZS5wYWRkaW5nTGVmdCA9ICcnOw0KICAgICAgICB0aGlzLl9lbGVtZW50LnN0eWxlLnBhZGRpbmdSaWdodCA9ICcnOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9jaGVja1Njcm9sbGJhciA9IGZ1bmN0aW9uIF9jaGVja1Njcm9sbGJhcigpIHsNCiAgICAgICAgdmFyIHJlY3QgPSBkb2N1bWVudC5ib2R5LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOw0KICAgICAgICB0aGlzLl9pc0JvZHlPdmVyZmxvd2luZyA9IHJlY3QubGVmdCArIHJlY3QucmlnaHQgPCB3aW5kb3cuaW5uZXJXaWR0aDsNCiAgICAgICAgdGhpcy5fc2Nyb2xsYmFyV2lkdGggPSB0aGlzLl9nZXRTY3JvbGxiYXJXaWR0aCgpOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9zZXRTY3JvbGxiYXIgPSBmdW5jdGlvbiBfc2V0U2Nyb2xsYmFyKCkgew0KICAgICAgICB2YXIgX3RoaXM5ID0gdGhpczsNCg0KICAgICAgICBpZiAodGhpcy5faXNCb2R5T3ZlcmZsb3dpbmcpIHsNCiAgICAgICAgICAvLyBOb3RlOiBET01Ob2RlLnN0eWxlLnBhZGRpbmdSaWdodCByZXR1cm5zIHRoZSBhY3R1YWwgdmFsdWUgb3IgJycgaWYgbm90IHNldA0KICAgICAgICAgIC8vICAgd2hpbGUgJChET01Ob2RlKS5jc3MoJ3BhZGRpbmctcmlnaHQnKSByZXR1cm5zIHRoZSBjYWxjdWxhdGVkIHZhbHVlIG9yIDAgaWYgbm90IHNldA0KICAgICAgICAgIHZhciBmaXhlZENvbnRlbnQgPSBbXS5zbGljZS5jYWxsKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoU2VsZWN0b3IuRklYRURfQ09OVEVOVCkpOw0KICAgICAgICAgIHZhciBzdGlja3lDb250ZW50ID0gW10uc2xpY2UuY2FsbChkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFNlbGVjdG9yLlNUSUNLWV9DT05URU5UKSk7IC8vIEFkanVzdCBmaXhlZCBjb250ZW50IHBhZGRpbmcNCg0KICAgICAgICAgICQkJDEoZml4ZWRDb250ZW50KS5lYWNoKGZ1bmN0aW9uIChpbmRleCwgZWxlbWVudCkgew0KICAgICAgICAgICAgdmFyIGFjdHVhbFBhZGRpbmcgPSBlbGVtZW50LnN0eWxlLnBhZGRpbmdSaWdodDsNCiAgICAgICAgICAgIHZhciBjYWxjdWxhdGVkUGFkZGluZyA9ICQkJDEoZWxlbWVudCkuY3NzKCdwYWRkaW5nLXJpZ2h0Jyk7DQogICAgICAgICAgICAkJCQxKGVsZW1lbnQpLmRhdGEoJ3BhZGRpbmctcmlnaHQnLCBhY3R1YWxQYWRkaW5nKS5jc3MoJ3BhZGRpbmctcmlnaHQnLCBwYXJzZUZsb2F0KGNhbGN1bGF0ZWRQYWRkaW5nKSArIF90aGlzOS5fc2Nyb2xsYmFyV2lkdGggKyAicHgiKTsNCiAgICAgICAgICB9KTsgLy8gQWRqdXN0IHN0aWNreSBjb250ZW50IG1hcmdpbg0KDQogICAgICAgICAgJCQkMShzdGlja3lDb250ZW50KS5lYWNoKGZ1bmN0aW9uIChpbmRleCwgZWxlbWVudCkgew0KICAgICAgICAgICAgdmFyIGFjdHVhbE1hcmdpbiA9IGVsZW1lbnQuc3R5bGUubWFyZ2luUmlnaHQ7DQogICAgICAgICAgICB2YXIgY2FsY3VsYXRlZE1hcmdpbiA9ICQkJDEoZWxlbWVudCkuY3NzKCdtYXJnaW4tcmlnaHQnKTsNCiAgICAgICAgICAgICQkJDEoZWxlbWVudCkuZGF0YSgnbWFyZ2luLXJpZ2h0JywgYWN0dWFsTWFyZ2luKS5jc3MoJ21hcmdpbi1yaWdodCcsIHBhcnNlRmxvYXQoY2FsY3VsYXRlZE1hcmdpbikgLSBfdGhpczkuX3Njcm9sbGJhcldpZHRoICsgInB4Iik7DQogICAgICAgICAgfSk7IC8vIEFkanVzdCBib2R5IHBhZGRpbmcNCg0KICAgICAgICAgIHZhciBhY3R1YWxQYWRkaW5nID0gZG9jdW1lbnQuYm9keS5zdHlsZS5wYWRkaW5nUmlnaHQ7DQogICAgICAgICAgdmFyIGNhbGN1bGF0ZWRQYWRkaW5nID0gJCQkMShkb2N1bWVudC5ib2R5KS5jc3MoJ3BhZGRpbmctcmlnaHQnKTsNCiAgICAgICAgICAkJCQxKGRvY3VtZW50LmJvZHkpLmRhdGEoJ3BhZGRpbmctcmlnaHQnLCBhY3R1YWxQYWRkaW5nKS5jc3MoJ3BhZGRpbmctcmlnaHQnLCBwYXJzZUZsb2F0KGNhbGN1bGF0ZWRQYWRkaW5nKSArIHRoaXMuX3Njcm9sbGJhcldpZHRoICsgInB4Iik7DQogICAgICAgIH0NCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5fcmVzZXRTY3JvbGxiYXIgPSBmdW5jdGlvbiBfcmVzZXRTY3JvbGxiYXIoKSB7DQogICAgICAgIC8vIFJlc3RvcmUgZml4ZWQgY29udGVudCBwYWRkaW5nDQogICAgICAgIHZhciBmaXhlZENvbnRlbnQgPSBbXS5zbGljZS5jYWxsKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoU2VsZWN0b3IuRklYRURfQ09OVEVOVCkpOw0KICAgICAgICAkJCQxKGZpeGVkQ29udGVudCkuZWFjaChmdW5jdGlvbiAoaW5kZXgsIGVsZW1lbnQpIHsNCiAgICAgICAgICB2YXIgcGFkZGluZyA9ICQkJDEoZWxlbWVudCkuZGF0YSgncGFkZGluZy1yaWdodCcpOw0KICAgICAgICAgICQkJDEoZWxlbWVudCkucmVtb3ZlRGF0YSgncGFkZGluZy1yaWdodCcpOw0KICAgICAgICAgIGVsZW1lbnQuc3R5bGUucGFkZGluZ1JpZ2h0ID0gcGFkZGluZyA/IHBhZGRpbmcgOiAnJzsNCiAgICAgICAgfSk7IC8vIFJlc3RvcmUgc3RpY2t5IGNvbnRlbnQNCg0KICAgICAgICB2YXIgZWxlbWVudHMgPSBbXS5zbGljZS5jYWxsKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIiIgKyBTZWxlY3Rvci5TVElDS1lfQ09OVEVOVCkpOw0KICAgICAgICAkJCQxKGVsZW1lbnRzKS5lYWNoKGZ1bmN0aW9uIChpbmRleCwgZWxlbWVudCkgew0KICAgICAgICAgIHZhciBtYXJnaW4gPSAkJCQxKGVsZW1lbnQpLmRhdGEoJ21hcmdpbi1yaWdodCcpOw0KDQogICAgICAgICAgaWYgKHR5cGVvZiBtYXJnaW4gIT09ICd1bmRlZmluZWQnKSB7DQogICAgICAgICAgICAkJCQxKGVsZW1lbnQpLmNzcygnbWFyZ2luLXJpZ2h0JywgbWFyZ2luKS5yZW1vdmVEYXRhKCdtYXJnaW4tcmlnaHQnKTsNCiAgICAgICAgICB9DQogICAgICAgIH0pOyAvLyBSZXN0b3JlIGJvZHkgcGFkZGluZw0KDQogICAgICAgIHZhciBwYWRkaW5nID0gJCQkMShkb2N1bWVudC5ib2R5KS5kYXRhKCdwYWRkaW5nLXJpZ2h0Jyk7DQogICAgICAgICQkJDEoZG9jdW1lbnQuYm9keSkucmVtb3ZlRGF0YSgncGFkZGluZy1yaWdodCcpOw0KICAgICAgICBkb2N1bWVudC5ib2R5LnN0eWxlLnBhZGRpbmdSaWdodCA9IHBhZGRpbmcgPyBwYWRkaW5nIDogJyc7DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uX2dldFNjcm9sbGJhcldpZHRoID0gZnVuY3Rpb24gX2dldFNjcm9sbGJhcldpZHRoKCkgew0KICAgICAgICAvLyB0aHggZC53YWxzaA0KICAgICAgICB2YXIgc2Nyb2xsRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7DQogICAgICAgIHNjcm9sbERpdi5jbGFzc05hbWUgPSBDbGFzc05hbWUuU0NST0xMQkFSX01FQVNVUkVSOw0KICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcm9sbERpdik7DQogICAgICAgIHZhciBzY3JvbGxiYXJXaWR0aCA9IHNjcm9sbERpdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aCAtIHNjcm9sbERpdi5jbGllbnRXaWR0aDsNCiAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChzY3JvbGxEaXYpOw0KICAgICAgICByZXR1cm4gc2Nyb2xsYmFyV2lkdGg7DQogICAgICB9OyAvLyBTdGF0aWMNCg0KDQogICAgICBNb2RhbC5falF1ZXJ5SW50ZXJmYWNlID0gZnVuY3Rpb24gX2pRdWVyeUludGVyZmFjZShjb25maWcsIHJlbGF0ZWRUYXJnZXQpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7DQogICAgICAgICAgdmFyIGRhdGEgPSAkJCQxKHRoaXMpLmRhdGEoREFUQV9LRVkpOw0KDQogICAgICAgICAgdmFyIF9jb25maWcgPSBfb2JqZWN0U3ByZWFkKHt9LCBEZWZhdWx0LCAkJCQxKHRoaXMpLmRhdGEoKSwgdHlwZW9mIGNvbmZpZyA9PT0gJ29iamVjdCcgJiYgY29uZmlnID8gY29uZmlnIDoge30pOw0KDQogICAgICAgICAgaWYgKCFkYXRhKSB7DQogICAgICAgICAgICBkYXRhID0gbmV3IE1vZGFsKHRoaXMsIF9jb25maWcpOw0KICAgICAgICAgICAgJCQkMSh0aGlzKS5kYXRhKERBVEFfS0VZLCBkYXRhKTsNCiAgICAgICAgICB9DQoNCiAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gJ3N0cmluZycpIHsNCiAgICAgICAgICAgIGlmICh0eXBlb2YgZGF0YVtjb25maWddID09PSAndW5kZWZpbmVkJykgew0KICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJObyBtZXRob2QgbmFtZWQgXCIiICsgY29uZmlnICsgIlwiIik7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGRhdGFbY29uZmlnXShyZWxhdGVkVGFyZ2V0KTsNCiAgICAgICAgICB9IGVsc2UgaWYgKF9jb25maWcuc2hvdykgew0KICAgICAgICAgICAgZGF0YS5zaG93KHJlbGF0ZWRUYXJnZXQpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSk7DQogICAgICB9Ow0KDQogICAgICBfY3JlYXRlQ2xhc3MoTW9kYWwsIG51bGwsIFt7DQogICAgICAgIGtleTogIlZFUlNJT04iLA0KICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsNCiAgICAgICAgICByZXR1cm4gVkVSU0lPTjsNCiAgICAgICAgfQ0KICAgICAgfSwgew0KICAgICAgICBrZXk6ICJEZWZhdWx0IiwNCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7DQogICAgICAgICAgcmV0dXJuIERlZmF1bHQ7DQogICAgICAgIH0NCiAgICAgIH1dKTsNCg0KICAgICAgcmV0dXJuIE1vZGFsOw0KICAgIH0oKTsNCiAgICAvKioNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKiBEYXRhIEFwaSBpbXBsZW1lbnRhdGlvbg0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqLw0KDQoNCiAgICAkJCQxKGRvY3VtZW50KS5vbihFdmVudC5DTElDS19EQVRBX0FQSSwgU2VsZWN0b3IuREFUQV9UT0dHTEUsIGZ1bmN0aW9uIChldmVudCkgew0KICAgICAgdmFyIF90aGlzMTAgPSB0aGlzOw0KDQogICAgICB2YXIgdGFyZ2V0Ow0KICAgICAgdmFyIHNlbGVjdG9yID0gVXRpbC5nZXRTZWxlY3RvckZyb21FbGVtZW50KHRoaXMpOw0KDQogICAgICBpZiAoc2VsZWN0b3IpIHsNCiAgICAgICAgdGFyZ2V0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7DQogICAgICB9DQoNCiAgICAgIHZhciBjb25maWcgPSAkJCQxKHRhcmdldCkuZGF0YShEQVRBX0tFWSkgPyAndG9nZ2xlJyA6IF9vYmplY3RTcHJlYWQoe30sICQkJDEodGFyZ2V0KS5kYXRhKCksICQkJDEodGhpcykuZGF0YSgpKTsNCg0KICAgICAgaWYgKHRoaXMudGFnTmFtZSA9PT0gJ0EnIHx8IHRoaXMudGFnTmFtZSA9PT0gJ0FSRUEnKSB7DQogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQogICAgICB9DQoNCiAgICAgIHZhciAkdGFyZ2V0ID0gJCQkMSh0YXJnZXQpLm9uZShFdmVudC5TSE9XLCBmdW5jdGlvbiAoc2hvd0V2ZW50KSB7DQogICAgICAgIGlmIChzaG93RXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkpIHsNCiAgICAgICAgICAvLyBPbmx5IHJlZ2lzdGVyIGZvY3VzIHJlc3RvcmVyIGlmIG1vZGFsIHdpbGwgYWN0dWFsbHkgZ2V0IHNob3duDQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgJHRhcmdldC5vbmUoRXZlbnQuSElEREVOLCBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgaWYgKCQkJDEoX3RoaXMxMCkuaXMoJzp2aXNpYmxlJykpIHsNCiAgICAgICAgICAgIF90aGlzMTAuZm9jdXMoKTsNCiAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgfSk7DQoNCiAgICAgIE1vZGFsLl9qUXVlcnlJbnRlcmZhY2UuY2FsbCgkJCQxKHRhcmdldCksIGNvbmZpZywgdGhpcyk7DQogICAgfSk7DQogICAgLyoqDQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICogalF1ZXJ5DQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICovDQoNCiAgICAkJCQxLmZuW05BTUVdID0gTW9kYWwuX2pRdWVyeUludGVyZmFjZTsNCiAgICAkJCQxLmZuW05BTUVdLkNvbnN0cnVjdG9yID0gTW9kYWw7DQoNCiAgICAkJCQxLmZuW05BTUVdLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7DQogICAgICAkJCQxLmZuW05BTUVdID0gSlFVRVJZX05PX0NPTkZMSUNUOw0KICAgICAgcmV0dXJuIE1vZGFsLl9qUXVlcnlJbnRlcmZhY2U7DQogICAgfTsNCg0KICAgIHJldHVybiBNb2RhbDsNCiAgfSgkKTsNCg0KICAvKioNCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICogQm9vdHN0cmFwICh2NC4xLjMpOiB0b29sdGlwLmpzDQogICAqIExpY2Vuc2VkIHVuZGVyIE1JVCAoaHR0cHM6Ly9naXRodWIuY29tL3R3YnMvYm9vdHN0cmFwL2Jsb2IvbWFzdGVyL0xJQ0VOU0UpDQogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAqLw0KDQogIHZhciBUb29sdGlwID0gZnVuY3Rpb24gKCQkJDEpIHsNCiAgICAvKioNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKiBDb25zdGFudHMNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKi8NCiAgICB2YXIgTkFNRSA9ICd0b29sdGlwJzsNCiAgICB2YXIgVkVSU0lPTiA9ICc0LjEuMyc7DQogICAgdmFyIERBVEFfS0VZID0gJ2JzLnRvb2x0aXAnOw0KICAgIHZhciBFVkVOVF9LRVkgPSAiLiIgKyBEQVRBX0tFWTsNCiAgICB2YXIgSlFVRVJZX05PX0NPTkZMSUNUID0gJCQkMS5mbltOQU1FXTsNCiAgICB2YXIgQ0xBU1NfUFJFRklYID0gJ2JzLXRvb2x0aXAnOw0KICAgIHZhciBCU0NMU19QUkVGSVhfUkVHRVggPSBuZXcgUmVnRXhwKCIoXnxcXHMpIiArIENMQVNTX1BSRUZJWCArICJcXFMrIiwgJ2cnKTsNCiAgICB2YXIgRGVmYXVsdFR5cGUgPSB7DQogICAgICBhbmltYXRpb246ICdib29sZWFuJywNCiAgICAgIHRlbXBsYXRlOiAnc3RyaW5nJywNCiAgICAgIHRpdGxlOiAnKHN0cmluZ3xlbGVtZW50fGZ1bmN0aW9uKScsDQogICAgICB0cmlnZ2VyOiAnc3RyaW5nJywNCiAgICAgIGRlbGF5OiAnKG51bWJlcnxvYmplY3QpJywNCiAgICAgIGh0bWw6ICdib29sZWFuJywNCiAgICAgIHNlbGVjdG9yOiAnKHN0cmluZ3xib29sZWFuKScsDQogICAgICBwbGFjZW1lbnQ6ICcoc3RyaW5nfGZ1bmN0aW9uKScsDQogICAgICBvZmZzZXQ6ICcobnVtYmVyfHN0cmluZyknLA0KICAgICAgY29udGFpbmVyOiAnKHN0cmluZ3xlbGVtZW50fGJvb2xlYW4pJywNCiAgICAgIGZhbGxiYWNrUGxhY2VtZW50OiAnKHN0cmluZ3xhcnJheSknLA0KICAgICAgYm91bmRhcnk6ICcoc3RyaW5nfGVsZW1lbnQpJw0KICAgIH07DQogICAgdmFyIEF0dGFjaG1lbnRNYXAgPSB7DQogICAgICBBVVRPOiAnYXV0bycsDQogICAgICBUT1A6ICd0b3AnLA0KICAgICAgUklHSFQ6ICdyaWdodCcsDQogICAgICBCT1RUT006ICdib3R0b20nLA0KICAgICAgTEVGVDogJ2xlZnQnDQogICAgfTsNCiAgICB2YXIgRGVmYXVsdCA9IHsNCiAgICAgIGFuaW1hdGlvbjogdHJ1ZSwNCiAgICAgIHRlbXBsYXRlOiAnPGRpdiBjbGFzcz0idG9vbHRpcCIgcm9sZT0idG9vbHRpcCI+JyArICc8ZGl2IGNsYXNzPSJhcnJvdyI+PC9kaXY+JyArICc8ZGl2IGNsYXNzPSJ0b29sdGlwLWlubmVyIj48L2Rpdj48L2Rpdj4nLA0KICAgICAgdHJpZ2dlcjogJ2hvdmVyIGZvY3VzJywNCiAgICAgIHRpdGxlOiAnJywNCiAgICAgIGRlbGF5OiAwLA0KICAgICAgaHRtbDogZmFsc2UsDQogICAgICBzZWxlY3RvcjogZmFsc2UsDQogICAgICBwbGFjZW1lbnQ6ICd0b3AnLA0KICAgICAgb2Zmc2V0OiAwLA0KICAgICAgY29udGFpbmVyOiBmYWxzZSwNCiAgICAgIGZhbGxiYWNrUGxhY2VtZW50OiAnZmxpcCcsDQogICAgICBib3VuZGFyeTogJ3Njcm9sbFBhcmVudCcNCiAgICB9Ow0KICAgIHZhciBIb3ZlclN0YXRlID0gew0KICAgICAgU0hPVzogJ3Nob3cnLA0KICAgICAgT1VUOiAnb3V0Jw0KICAgIH07DQogICAgdmFyIEV2ZW50ID0gew0KICAgICAgSElERTogImhpZGUiICsgRVZFTlRfS0VZLA0KICAgICAgSElEREVOOiAiaGlkZGVuIiArIEVWRU5UX0tFWSwNCiAgICAgIFNIT1c6ICJzaG93IiArIEVWRU5UX0tFWSwNCiAgICAgIFNIT1dOOiAic2hvd24iICsgRVZFTlRfS0VZLA0KICAgICAgSU5TRVJURUQ6ICJpbnNlcnRlZCIgKyBFVkVOVF9LRVksDQogICAgICBDTElDSzogImNsaWNrIiArIEVWRU5UX0tFWSwNCiAgICAgIEZPQ1VTSU46ICJmb2N1c2luIiArIEVWRU5UX0tFWSwNCiAgICAgIEZPQ1VTT1VUOiAiZm9jdXNvdXQiICsgRVZFTlRfS0VZLA0KICAgICAgTU9VU0VFTlRFUjogIm1vdXNlZW50ZXIiICsgRVZFTlRfS0VZLA0KICAgICAgTU9VU0VMRUFWRTogIm1vdXNlbGVhdmUiICsgRVZFTlRfS0VZDQogICAgfTsNCiAgICB2YXIgQ2xhc3NOYW1lID0gew0KICAgICAgRkFERTogJ2ZhZGUnLA0KICAgICAgU0hPVzogJ3Nob3cnDQogICAgfTsNCiAgICB2YXIgU2VsZWN0b3IgPSB7DQogICAgICBUT09MVElQOiAnLnRvb2x0aXAnLA0KICAgICAgVE9PTFRJUF9JTk5FUjogJy50b29sdGlwLWlubmVyJywNCiAgICAgIEFSUk9XOiAnLmFycm93Jw0KICAgIH07DQogICAgdmFyIFRyaWdnZXIgPSB7DQogICAgICBIT1ZFUjogJ2hvdmVyJywNCiAgICAgIEZPQ1VTOiAnZm9jdXMnLA0KICAgICAgQ0xJQ0s6ICdjbGljaycsDQogICAgICBNQU5VQUw6ICdtYW51YWwnDQogICAgICAvKioNCiAgICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAgICogQ2xhc3MgRGVmaW5pdGlvbg0KICAgICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICAgKi8NCg0KICAgIH07DQoNCiAgICB2YXIgVG9vbHRpcCA9DQogICAgLyojX19QVVJFX18qLw0KICAgIGZ1bmN0aW9uICgpIHsNCiAgICAgIGZ1bmN0aW9uIFRvb2x0aXAoZWxlbWVudCwgY29uZmlnKSB7DQogICAgICAgIC8qKg0KICAgICAgICAgKiBDaGVjayBmb3IgUG9wcGVyIGRlcGVuZGVuY3kNCiAgICAgICAgICogUG9wcGVyIC0gaHR0cHM6Ly9wb3BwZXIuanMub3JnDQogICAgICAgICAqLw0KICAgICAgICBpZiAodHlwZW9mIFBvcHBlciA9PT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdCb290c3RyYXAgdG9vbHRpcHMgcmVxdWlyZSBQb3BwZXIuanMgKGh0dHBzOi8vcG9wcGVyLmpzLm9yZyknKTsNCiAgICAgICAgfSAvLyBwcml2YXRlDQoNCg0KICAgICAgICB0aGlzLl9pc0VuYWJsZWQgPSB0cnVlOw0KICAgICAgICB0aGlzLl90aW1lb3V0ID0gMDsNCiAgICAgICAgdGhpcy5faG92ZXJTdGF0ZSA9ICcnOw0KICAgICAgICB0aGlzLl9hY3RpdmVUcmlnZ2VyID0ge307DQogICAgICAgIHRoaXMuX3BvcHBlciA9IG51bGw7IC8vIFByb3RlY3RlZA0KDQogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7DQogICAgICAgIHRoaXMuY29uZmlnID0gdGhpcy5fZ2V0Q29uZmlnKGNvbmZpZyk7DQogICAgICAgIHRoaXMudGlwID0gbnVsbDsNCg0KICAgICAgICB0aGlzLl9zZXRMaXN0ZW5lcnMoKTsNCiAgICAgIH0gLy8gR2V0dGVycw0KDQoNCiAgICAgIHZhciBfcHJvdG8gPSBUb29sdGlwLnByb3RvdHlwZTsNCg0KICAgICAgLy8gUHVibGljDQogICAgICBfcHJvdG8uZW5hYmxlID0gZnVuY3Rpb24gZW5hYmxlKCkgew0KICAgICAgICB0aGlzLl9pc0VuYWJsZWQgPSB0cnVlOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLmRpc2FibGUgPSBmdW5jdGlvbiBkaXNhYmxlKCkgew0KICAgICAgICB0aGlzLl9pc0VuYWJsZWQgPSBmYWxzZTsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by50b2dnbGVFbmFibGVkID0gZnVuY3Rpb24gdG9nZ2xlRW5hYmxlZCgpIHsNCiAgICAgICAgdGhpcy5faXNFbmFibGVkID0gIXRoaXMuX2lzRW5hYmxlZDsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by50b2dnbGUgPSBmdW5jdGlvbiB0b2dnbGUoZXZlbnQpIHsNCiAgICAgICAgaWYgKCF0aGlzLl9pc0VuYWJsZWQpIHsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoZXZlbnQpIHsNCiAgICAgICAgICB2YXIgZGF0YUtleSA9IHRoaXMuY29uc3RydWN0b3IuREFUQV9LRVk7DQogICAgICAgICAgdmFyIGNvbnRleHQgPSAkJCQxKGV2ZW50LmN1cnJlbnRUYXJnZXQpLmRhdGEoZGF0YUtleSk7DQoNCiAgICAgICAgICBpZiAoIWNvbnRleHQpIHsNCiAgICAgICAgICAgIGNvbnRleHQgPSBuZXcgdGhpcy5jb25zdHJ1Y3RvcihldmVudC5jdXJyZW50VGFyZ2V0LCB0aGlzLl9nZXREZWxlZ2F0ZUNvbmZpZygpKTsNCiAgICAgICAgICAgICQkJDEoZXZlbnQuY3VycmVudFRhcmdldCkuZGF0YShkYXRhS2V5LCBjb250ZXh0KTsNCiAgICAgICAgICB9DQoNCiAgICAgICAgICBjb250ZXh0Ll9hY3RpdmVUcmlnZ2VyLmNsaWNrID0gIWNvbnRleHQuX2FjdGl2ZVRyaWdnZXIuY2xpY2s7DQoNCiAgICAgICAgICBpZiAoY29udGV4dC5faXNXaXRoQWN0aXZlVHJpZ2dlcigpKSB7DQogICAgICAgICAgICBjb250ZXh0Ll9lbnRlcihudWxsLCBjb250ZXh0KTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgY29udGV4dC5fbGVhdmUobnVsbCwgY29udGV4dCk7DQogICAgICAgICAgfQ0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGlmICgkJCQxKHRoaXMuZ2V0VGlwRWxlbWVudCgpKS5oYXNDbGFzcyhDbGFzc05hbWUuU0hPVykpIHsNCiAgICAgICAgICAgIHRoaXMuX2xlYXZlKG51bGwsIHRoaXMpOw0KDQogICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgfQ0KDQogICAgICAgICAgdGhpcy5fZW50ZXIobnVsbCwgdGhpcyk7DQogICAgICAgIH0NCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5kaXNwb3NlID0gZnVuY3Rpb24gZGlzcG9zZSgpIHsNCiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3RpbWVvdXQpOw0KICAgICAgICAkJCQxLnJlbW92ZURhdGEodGhpcy5lbGVtZW50LCB0aGlzLmNvbnN0cnVjdG9yLkRBVEFfS0VZKTsNCiAgICAgICAgJCQkMSh0aGlzLmVsZW1lbnQpLm9mZih0aGlzLmNvbnN0cnVjdG9yLkVWRU5UX0tFWSk7DQogICAgICAgICQkJDEodGhpcy5lbGVtZW50KS5jbG9zZXN0KCcubW9kYWwnKS5vZmYoJ2hpZGUuYnMubW9kYWwnKTsNCg0KICAgICAgICBpZiAodGhpcy50aXApIHsNCiAgICAgICAgICAkJCQxKHRoaXMudGlwKS5yZW1vdmUoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIHRoaXMuX2lzRW5hYmxlZCA9IG51bGw7DQogICAgICAgIHRoaXMuX3RpbWVvdXQgPSBudWxsOw0KICAgICAgICB0aGlzLl9ob3ZlclN0YXRlID0gbnVsbDsNCiAgICAgICAgdGhpcy5fYWN0aXZlVHJpZ2dlciA9IG51bGw7DQoNCiAgICAgICAgaWYgKHRoaXMuX3BvcHBlciAhPT0gbnVsbCkgew0KICAgICAgICAgIHRoaXMuX3BvcHBlci5kZXN0cm95KCk7DQogICAgICAgIH0NCg0KICAgICAgICB0aGlzLl9wb3BwZXIgPSBudWxsOw0KICAgICAgICB0aGlzLmVsZW1lbnQgPSBudWxsOw0KICAgICAgICB0aGlzLmNvbmZpZyA9IG51bGw7DQogICAgICAgIHRoaXMudGlwID0gbnVsbDsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5zaG93ID0gZnVuY3Rpb24gc2hvdygpIHsNCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsNCg0KICAgICAgICBpZiAoJCQkMSh0aGlzLmVsZW1lbnQpLmNzcygnZGlzcGxheScpID09PSAnbm9uZScpIHsNCiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1BsZWFzZSB1c2Ugc2hvdyBvbiB2aXNpYmxlIGVsZW1lbnRzJyk7DQogICAgICAgIH0NCg0KICAgICAgICB2YXIgc2hvd0V2ZW50ID0gJCQkMS5FdmVudCh0aGlzLmNvbnN0cnVjdG9yLkV2ZW50LlNIT1cpOw0KDQogICAgICAgIGlmICh0aGlzLmlzV2l0aENvbnRlbnQoKSAmJiB0aGlzLl9pc0VuYWJsZWQpIHsNCiAgICAgICAgICAkJCQxKHRoaXMuZWxlbWVudCkudHJpZ2dlcihzaG93RXZlbnQpOw0KICAgICAgICAgIHZhciBpc0luVGhlRG9tID0gJCQkMS5jb250YWlucyh0aGlzLmVsZW1lbnQub3duZXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIHRoaXMuZWxlbWVudCk7DQoNCiAgICAgICAgICBpZiAoc2hvd0V2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8ICFpc0luVGhlRG9tKSB7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgfQ0KDQogICAgICAgICAgdmFyIHRpcCA9IHRoaXMuZ2V0VGlwRWxlbWVudCgpOw0KICAgICAgICAgIHZhciB0aXBJZCA9IFV0aWwuZ2V0VUlEKHRoaXMuY29uc3RydWN0b3IuTkFNRSk7DQogICAgICAgICAgdGlwLnNldEF0dHJpYnV0ZSgnaWQnLCB0aXBJZCk7DQogICAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSgnYXJpYS1kZXNjcmliZWRieScsIHRpcElkKTsNCiAgICAgICAgICB0aGlzLnNldENvbnRlbnQoKTsNCg0KICAgICAgICAgIGlmICh0aGlzLmNvbmZpZy5hbmltYXRpb24pIHsNCiAgICAgICAgICAgICQkJDEodGlwKS5hZGRDbGFzcyhDbGFzc05hbWUuRkFERSk7DQogICAgICAgICAgfQ0KDQogICAgICAgICAgdmFyIHBsYWNlbWVudCA9IHR5cGVvZiB0aGlzLmNvbmZpZy5wbGFjZW1lbnQgPT09ICdmdW5jdGlvbicgPyB0aGlzLmNvbmZpZy5wbGFjZW1lbnQuY2FsbCh0aGlzLCB0aXAsIHRoaXMuZWxlbWVudCkgOiB0aGlzLmNvbmZpZy5wbGFjZW1lbnQ7DQoNCiAgICAgICAgICB2YXIgYXR0YWNobWVudCA9IHRoaXMuX2dldEF0dGFjaG1lbnQocGxhY2VtZW50KTsNCg0KICAgICAgICAgIHRoaXMuYWRkQXR0YWNobWVudENsYXNzKGF0dGFjaG1lbnQpOw0KICAgICAgICAgIHZhciBjb250YWluZXIgPSB0aGlzLmNvbmZpZy5jb250YWluZXIgPT09IGZhbHNlID8gZG9jdW1lbnQuYm9keSA6ICQkJDEoZG9jdW1lbnQpLmZpbmQodGhpcy5jb25maWcuY29udGFpbmVyKTsNCiAgICAgICAgICAkJCQxKHRpcCkuZGF0YSh0aGlzLmNvbnN0cnVjdG9yLkRBVEFfS0VZLCB0aGlzKTsNCg0KICAgICAgICAgIGlmICghJCQkMS5jb250YWlucyh0aGlzLmVsZW1lbnQub3duZXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIHRoaXMudGlwKSkgew0KICAgICAgICAgICAgJCQkMSh0aXApLmFwcGVuZFRvKGNvbnRhaW5lcik7DQogICAgICAgICAgfQ0KDQogICAgICAgICAgJCQkMSh0aGlzLmVsZW1lbnQpLnRyaWdnZXIodGhpcy5jb25zdHJ1Y3Rvci5FdmVudC5JTlNFUlRFRCk7DQogICAgICAgICAgdGhpcy5fcG9wcGVyID0gbmV3IFBvcHBlcih0aGlzLmVsZW1lbnQsIHRpcCwgew0KICAgICAgICAgICAgcGxhY2VtZW50OiBhdHRhY2htZW50LA0KICAgICAgICAgICAgbW9kaWZpZXJzOiB7DQogICAgICAgICAgICAgIG9mZnNldDogew0KICAgICAgICAgICAgICAgIG9mZnNldDogdGhpcy5jb25maWcub2Zmc2V0DQogICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgIGZsaXA6IHsNCiAgICAgICAgICAgICAgICBiZWhhdmlvcjogdGhpcy5jb25maWcuZmFsbGJhY2tQbGFjZW1lbnQNCiAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgYXJyb3c6IHsNCiAgICAgICAgICAgICAgICBlbGVtZW50OiBTZWxlY3Rvci5BUlJPVw0KICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICBwcmV2ZW50T3ZlcmZsb3c6IHsNCiAgICAgICAgICAgICAgICBib3VuZGFyaWVzRWxlbWVudDogdGhpcy5jb25maWcuYm91bmRhcnkNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIG9uQ3JlYXRlOiBmdW5jdGlvbiBvbkNyZWF0ZShkYXRhKSB7DQogICAgICAgICAgICAgIGlmIChkYXRhLm9yaWdpbmFsUGxhY2VtZW50ICE9PSBkYXRhLnBsYWNlbWVudCkgew0KICAgICAgICAgICAgICAgIF90aGlzLl9oYW5kbGVQb3BwZXJQbGFjZW1lbnRDaGFuZ2UoZGF0YSk7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBvblVwZGF0ZTogZnVuY3Rpb24gb25VcGRhdGUoZGF0YSkgew0KICAgICAgICAgICAgICBfdGhpcy5faGFuZGxlUG9wcGVyUGxhY2VtZW50Q2hhbmdlKGRhdGEpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0pOw0KICAgICAgICAgICQkJDEodGlwKS5hZGRDbGFzcyhDbGFzc05hbWUuU0hPVyk7IC8vIElmIHRoaXMgaXMgYSB0b3VjaC1lbmFibGVkIGRldmljZSB3ZSBhZGQgZXh0cmENCiAgICAgICAgICAvLyBlbXB0eSBtb3VzZW92ZXIgbGlzdGVuZXJzIHRvIHRoZSBib2R5J3MgaW1tZWRpYXRlIGNoaWxkcmVuOw0KICAgICAgICAgIC8vIG9ubHkgbmVlZGVkIGJlY2F1c2Ugb2YgYnJva2VuIGV2ZW50IGRlbGVnYXRpb24gb24gaU9TDQogICAgICAgICAgLy8gaHR0cHM6Ly93d3cucXVpcmtzbW9kZS5vcmcvYmxvZy9hcmNoaXZlcy8yMDE0LzAyL21vdXNlX2V2ZW50X2J1Yi5odG1sDQoNCiAgICAgICAgICBpZiAoJ29udG91Y2hzdGFydCcgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KSB7DQogICAgICAgICAgICAkJCQxKGRvY3VtZW50LmJvZHkpLmNoaWxkcmVuKCkub24oJ21vdXNlb3ZlcicsIG51bGwsICQkJDEubm9vcCk7DQogICAgICAgICAgfQ0KDQogICAgICAgICAgdmFyIGNvbXBsZXRlID0gZnVuY3Rpb24gY29tcGxldGUoKSB7DQogICAgICAgICAgICBpZiAoX3RoaXMuY29uZmlnLmFuaW1hdGlvbikgew0KICAgICAgICAgICAgICBfdGhpcy5fZml4VHJhbnNpdGlvbigpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB2YXIgcHJldkhvdmVyU3RhdGUgPSBfdGhpcy5faG92ZXJTdGF0ZTsNCiAgICAgICAgICAgIF90aGlzLl9ob3ZlclN0YXRlID0gbnVsbDsNCiAgICAgICAgICAgICQkJDEoX3RoaXMuZWxlbWVudCkudHJpZ2dlcihfdGhpcy5jb25zdHJ1Y3Rvci5FdmVudC5TSE9XTik7DQoNCiAgICAgICAgICAgIGlmIChwcmV2SG92ZXJTdGF0ZSA9PT0gSG92ZXJTdGF0ZS5PVVQpIHsNCiAgICAgICAgICAgICAgX3RoaXMuX2xlYXZlKG51bGwsIF90aGlzKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9Ow0KDQogICAgICAgICAgaWYgKCQkJDEodGhpcy50aXApLmhhc0NsYXNzKENsYXNzTmFtZS5GQURFKSkgew0KICAgICAgICAgICAgdmFyIHRyYW5zaXRpb25EdXJhdGlvbiA9IFV0aWwuZ2V0VHJhbnNpdGlvbkR1cmF0aW9uRnJvbUVsZW1lbnQodGhpcy50aXApOw0KICAgICAgICAgICAgJCQkMSh0aGlzLnRpcCkub25lKFV0aWwuVFJBTlNJVElPTl9FTkQsIGNvbXBsZXRlKS5lbXVsYXRlVHJhbnNpdGlvbkVuZCh0cmFuc2l0aW9uRHVyYXRpb24pOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBjb21wbGV0ZSgpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLmhpZGUgPSBmdW5jdGlvbiBoaWRlKGNhbGxiYWNrKSB7DQogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOw0KDQogICAgICAgIHZhciB0aXAgPSB0aGlzLmdldFRpcEVsZW1lbnQoKTsNCiAgICAgICAgdmFyIGhpZGVFdmVudCA9ICQkJDEuRXZlbnQodGhpcy5jb25zdHJ1Y3Rvci5FdmVudC5ISURFKTsNCg0KICAgICAgICB2YXIgY29tcGxldGUgPSBmdW5jdGlvbiBjb21wbGV0ZSgpIHsNCiAgICAgICAgICBpZiAoX3RoaXMyLl9ob3ZlclN0YXRlICE9PSBIb3ZlclN0YXRlLlNIT1cgJiYgdGlwLnBhcmVudE5vZGUpIHsNCiAgICAgICAgICAgIHRpcC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRpcCk7DQogICAgICAgICAgfQ0KDQogICAgICAgICAgX3RoaXMyLl9jbGVhblRpcENsYXNzKCk7DQoNCiAgICAgICAgICBfdGhpczIuZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoJ2FyaWEtZGVzY3JpYmVkYnknKTsNCg0KICAgICAgICAgICQkJDEoX3RoaXMyLmVsZW1lbnQpLnRyaWdnZXIoX3RoaXMyLmNvbnN0cnVjdG9yLkV2ZW50LkhJRERFTik7DQoNCiAgICAgICAgICBpZiAoX3RoaXMyLl9wb3BwZXIgIT09IG51bGwpIHsNCiAgICAgICAgICAgIF90aGlzMi5fcG9wcGVyLmRlc3Ryb3koKTsNCiAgICAgICAgICB9DQoNCiAgICAgICAgICBpZiAoY2FsbGJhY2spIHsNCiAgICAgICAgICAgIGNhbGxiYWNrKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9Ow0KDQogICAgICAgICQkJDEodGhpcy5lbGVtZW50KS50cmlnZ2VyKGhpZGVFdmVudCk7DQoNCiAgICAgICAgaWYgKGhpZGVFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgICQkJDEodGlwKS5yZW1vdmVDbGFzcyhDbGFzc05hbWUuU0hPVyk7IC8vIElmIHRoaXMgaXMgYSB0b3VjaC1lbmFibGVkIGRldmljZSB3ZSByZW1vdmUgdGhlIGV4dHJhDQogICAgICAgIC8vIGVtcHR5IG1vdXNlb3ZlciBsaXN0ZW5lcnMgd2UgYWRkZWQgZm9yIGlPUyBzdXBwb3J0DQoNCiAgICAgICAgaWYgKCdvbnRvdWNoc3RhcnQnIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkgew0KICAgICAgICAgICQkJDEoZG9jdW1lbnQuYm9keSkuY2hpbGRyZW4oKS5vZmYoJ21vdXNlb3ZlcicsIG51bGwsICQkJDEubm9vcCk7DQogICAgICAgIH0NCg0KICAgICAgICB0aGlzLl9hY3RpdmVUcmlnZ2VyW1RyaWdnZXIuQ0xJQ0tdID0gZmFsc2U7DQogICAgICAgIHRoaXMuX2FjdGl2ZVRyaWdnZXJbVHJpZ2dlci5GT0NVU10gPSBmYWxzZTsNCiAgICAgICAgdGhpcy5fYWN0aXZlVHJpZ2dlcltUcmlnZ2VyLkhPVkVSXSA9IGZhbHNlOw0KDQogICAgICAgIGlmICgkJCQxKHRoaXMudGlwKS5oYXNDbGFzcyhDbGFzc05hbWUuRkFERSkpIHsNCiAgICAgICAgICB2YXIgdHJhbnNpdGlvbkR1cmF0aW9uID0gVXRpbC5nZXRUcmFuc2l0aW9uRHVyYXRpb25Gcm9tRWxlbWVudCh0aXApOw0KICAgICAgICAgICQkJDEodGlwKS5vbmUoVXRpbC5UUkFOU0lUSU9OX0VORCwgY29tcGxldGUpLmVtdWxhdGVUcmFuc2l0aW9uRW5kKHRyYW5zaXRpb25EdXJhdGlvbik7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgY29tcGxldGUoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIHRoaXMuX2hvdmVyU3RhdGUgPSAnJzsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUoKSB7DQogICAgICAgIGlmICh0aGlzLl9wb3BwZXIgIT09IG51bGwpIHsNCiAgICAgICAgICB0aGlzLl9wb3BwZXIuc2NoZWR1bGVVcGRhdGUoKTsNCiAgICAgICAgfQ0KICAgICAgfTsgLy8gUHJvdGVjdGVkDQoNCg0KICAgICAgX3Byb3RvLmlzV2l0aENvbnRlbnQgPSBmdW5jdGlvbiBpc1dpdGhDb250ZW50KCkgew0KICAgICAgICByZXR1cm4gQm9vbGVhbih0aGlzLmdldFRpdGxlKCkpOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLmFkZEF0dGFjaG1lbnRDbGFzcyA9IGZ1bmN0aW9uIGFkZEF0dGFjaG1lbnRDbGFzcyhhdHRhY2htZW50KSB7DQogICAgICAgICQkJDEodGhpcy5nZXRUaXBFbGVtZW50KCkpLmFkZENsYXNzKENMQVNTX1BSRUZJWCArICItIiArIGF0dGFjaG1lbnQpOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLmdldFRpcEVsZW1lbnQgPSBmdW5jdGlvbiBnZXRUaXBFbGVtZW50KCkgew0KICAgICAgICB0aGlzLnRpcCA9IHRoaXMudGlwIHx8ICQkJDEodGhpcy5jb25maWcudGVtcGxhdGUpWzBdOw0KICAgICAgICByZXR1cm4gdGhpcy50aXA7DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uc2V0Q29udGVudCA9IGZ1bmN0aW9uIHNldENvbnRlbnQoKSB7DQogICAgICAgIHZhciB0aXAgPSB0aGlzLmdldFRpcEVsZW1lbnQoKTsNCiAgICAgICAgdGhpcy5zZXRFbGVtZW50Q29udGVudCgkJCQxKHRpcC5xdWVyeVNlbGVjdG9yQWxsKFNlbGVjdG9yLlRPT0xUSVBfSU5ORVIpKSwgdGhpcy5nZXRUaXRsZSgpKTsNCiAgICAgICAgJCQkMSh0aXApLnJlbW92ZUNsYXNzKENsYXNzTmFtZS5GQURFICsgIiAiICsgQ2xhc3NOYW1lLlNIT1cpOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLnNldEVsZW1lbnRDb250ZW50ID0gZnVuY3Rpb24gc2V0RWxlbWVudENvbnRlbnQoJGVsZW1lbnQsIGNvbnRlbnQpIHsNCiAgICAgICAgdmFyIGh0bWwgPSB0aGlzLmNvbmZpZy5odG1sOw0KDQogICAgICAgIGlmICh0eXBlb2YgY29udGVudCA9PT0gJ29iamVjdCcgJiYgKGNvbnRlbnQubm9kZVR5cGUgfHwgY29udGVudC5qcXVlcnkpKSB7DQogICAgICAgICAgLy8gQ29udGVudCBpcyBhIERPTSBub2RlIG9yIGEgalF1ZXJ5DQogICAgICAgICAgaWYgKGh0bWwpIHsNCiAgICAgICAgICAgIGlmICghJCQkMShjb250ZW50KS5wYXJlbnQoKS5pcygkZWxlbWVudCkpIHsNCiAgICAgICAgICAgICAgJGVsZW1lbnQuZW1wdHkoKS5hcHBlbmQoY29udGVudCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICRlbGVtZW50LnRleHQoJCQkMShjb250ZW50KS50ZXh0KCkpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAkZWxlbWVudFtodG1sID8gJ2h0bWwnIDogJ3RleHQnXShjb250ZW50KTsNCiAgICAgICAgfQ0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLmdldFRpdGxlID0gZnVuY3Rpb24gZ2V0VGl0bGUoKSB7DQogICAgICAgIHZhciB0aXRsZSA9IHRoaXMuZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtb3JpZ2luYWwtdGl0bGUnKTsNCg0KICAgICAgICBpZiAoIXRpdGxlKSB7DQogICAgICAgICAgdGl0bGUgPSB0eXBlb2YgdGhpcy5jb25maWcudGl0bGUgPT09ICdmdW5jdGlvbicgPyB0aGlzLmNvbmZpZy50aXRsZS5jYWxsKHRoaXMuZWxlbWVudCkgOiB0aGlzLmNvbmZpZy50aXRsZTsNCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiB0aXRsZTsNCiAgICAgIH07IC8vIFByaXZhdGUNCg0KDQogICAgICBfcHJvdG8uX2dldEF0dGFjaG1lbnQgPSBmdW5jdGlvbiBfZ2V0QXR0YWNobWVudChwbGFjZW1lbnQpIHsNCiAgICAgICAgcmV0dXJuIEF0dGFjaG1lbnRNYXBbcGxhY2VtZW50LnRvVXBwZXJDYXNlKCldOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9zZXRMaXN0ZW5lcnMgPSBmdW5jdGlvbiBfc2V0TGlzdGVuZXJzKCkgew0KICAgICAgICB2YXIgX3RoaXMzID0gdGhpczsNCg0KICAgICAgICB2YXIgdHJpZ2dlcnMgPSB0aGlzLmNvbmZpZy50cmlnZ2VyLnNwbGl0KCcgJyk7DQogICAgICAgIHRyaWdnZXJzLmZvckVhY2goZnVuY3Rpb24gKHRyaWdnZXIpIHsNCiAgICAgICAgICBpZiAodHJpZ2dlciA9PT0gJ2NsaWNrJykgew0KICAgICAgICAgICAgJCQkMShfdGhpczMuZWxlbWVudCkub24oX3RoaXMzLmNvbnN0cnVjdG9yLkV2ZW50LkNMSUNLLCBfdGhpczMuY29uZmlnLnNlbGVjdG9yLCBmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgICAgICAgICAgcmV0dXJuIF90aGlzMy50b2dnbGUoZXZlbnQpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgfSBlbHNlIGlmICh0cmlnZ2VyICE9PSBUcmlnZ2VyLk1BTlVBTCkgew0KICAgICAgICAgICAgdmFyIGV2ZW50SW4gPSB0cmlnZ2VyID09PSBUcmlnZ2VyLkhPVkVSID8gX3RoaXMzLmNvbnN0cnVjdG9yLkV2ZW50Lk1PVVNFRU5URVIgOiBfdGhpczMuY29uc3RydWN0b3IuRXZlbnQuRk9DVVNJTjsNCiAgICAgICAgICAgIHZhciBldmVudE91dCA9IHRyaWdnZXIgPT09IFRyaWdnZXIuSE9WRVIgPyBfdGhpczMuY29uc3RydWN0b3IuRXZlbnQuTU9VU0VMRUFWRSA6IF90aGlzMy5jb25zdHJ1Y3Rvci5FdmVudC5GT0NVU09VVDsNCiAgICAgICAgICAgICQkJDEoX3RoaXMzLmVsZW1lbnQpLm9uKGV2ZW50SW4sIF90aGlzMy5jb25maWcuc2VsZWN0b3IsIGZ1bmN0aW9uIChldmVudCkgew0KICAgICAgICAgICAgICByZXR1cm4gX3RoaXMzLl9lbnRlcihldmVudCk7DQogICAgICAgICAgICB9KS5vbihldmVudE91dCwgX3RoaXMzLmNvbmZpZy5zZWxlY3RvciwgZnVuY3Rpb24gKGV2ZW50KSB7DQogICAgICAgICAgICAgIHJldHVybiBfdGhpczMuX2xlYXZlKGV2ZW50KTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgIH0NCg0KICAgICAgICAgICQkJDEoX3RoaXMzLmVsZW1lbnQpLmNsb3Nlc3QoJy5tb2RhbCcpLm9uKCdoaWRlLmJzLm1vZGFsJywgZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgcmV0dXJuIF90aGlzMy5oaWRlKCk7DQogICAgICAgICAgfSk7DQogICAgICAgIH0pOw0KDQogICAgICAgIGlmICh0aGlzLmNvbmZpZy5zZWxlY3Rvcikgew0KICAgICAgICAgIHRoaXMuY29uZmlnID0gX29iamVjdFNwcmVhZCh7fSwgdGhpcy5jb25maWcsIHsNCiAgICAgICAgICAgIHRyaWdnZXI6ICdtYW51YWwnLA0KICAgICAgICAgICAgc2VsZWN0b3I6ICcnDQogICAgICAgICAgfSk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgdGhpcy5fZml4VGl0bGUoKTsNCiAgICAgICAgfQ0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9maXhUaXRsZSA9IGZ1bmN0aW9uIF9maXhUaXRsZSgpIHsNCiAgICAgICAgdmFyIHRpdGxlVHlwZSA9IHR5cGVvZiB0aGlzLmVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLW9yaWdpbmFsLXRpdGxlJyk7DQoNCiAgICAgICAgaWYgKHRoaXMuZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3RpdGxlJykgfHwgdGl0bGVUeXBlICE9PSAnc3RyaW5nJykgew0KICAgICAgICAgIHRoaXMuZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2RhdGEtb3JpZ2luYWwtdGl0bGUnLCB0aGlzLmVsZW1lbnQuZ2V0QXR0cmlidXRlKCd0aXRsZScpIHx8ICcnKTsNCiAgICAgICAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKCd0aXRsZScsICcnKTsNCiAgICAgICAgfQ0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9lbnRlciA9IGZ1bmN0aW9uIF9lbnRlcihldmVudCwgY29udGV4dCkgew0KICAgICAgICB2YXIgZGF0YUtleSA9IHRoaXMuY29uc3RydWN0b3IuREFUQV9LRVk7DQogICAgICAgIGNvbnRleHQgPSBjb250ZXh0IHx8ICQkJDEoZXZlbnQuY3VycmVudFRhcmdldCkuZGF0YShkYXRhS2V5KTsNCg0KICAgICAgICBpZiAoIWNvbnRleHQpIHsNCiAgICAgICAgICBjb250ZXh0ID0gbmV3IHRoaXMuY29uc3RydWN0b3IoZXZlbnQuY3VycmVudFRhcmdldCwgdGhpcy5fZ2V0RGVsZWdhdGVDb25maWcoKSk7DQogICAgICAgICAgJCQkMShldmVudC5jdXJyZW50VGFyZ2V0KS5kYXRhKGRhdGFLZXksIGNvbnRleHQpOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKGV2ZW50KSB7DQogICAgICAgICAgY29udGV4dC5fYWN0aXZlVHJpZ2dlcltldmVudC50eXBlID09PSAnZm9jdXNpbicgPyBUcmlnZ2VyLkZPQ1VTIDogVHJpZ2dlci5IT1ZFUl0gPSB0cnVlOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKCQkJDEoY29udGV4dC5nZXRUaXBFbGVtZW50KCkpLmhhc0NsYXNzKENsYXNzTmFtZS5TSE9XKSB8fCBjb250ZXh0Ll9ob3ZlclN0YXRlID09PSBIb3ZlclN0YXRlLlNIT1cpIHsNCiAgICAgICAgICBjb250ZXh0Ll9ob3ZlclN0YXRlID0gSG92ZXJTdGF0ZS5TSE9XOw0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIGNsZWFyVGltZW91dChjb250ZXh0Ll90aW1lb3V0KTsNCiAgICAgICAgY29udGV4dC5faG92ZXJTdGF0ZSA9IEhvdmVyU3RhdGUuU0hPVzsNCg0KICAgICAgICBpZiAoIWNvbnRleHQuY29uZmlnLmRlbGF5IHx8ICFjb250ZXh0LmNvbmZpZy5kZWxheS5zaG93KSB7DQogICAgICAgICAgY29udGV4dC5zaG93KCk7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgY29udGV4dC5fdGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgew0KICAgICAgICAgIGlmIChjb250ZXh0Ll9ob3ZlclN0YXRlID09PSBIb3ZlclN0YXRlLlNIT1cpIHsNCiAgICAgICAgICAgIGNvbnRleHQuc2hvdygpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSwgY29udGV4dC5jb25maWcuZGVsYXkuc2hvdyk7DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uX2xlYXZlID0gZnVuY3Rpb24gX2xlYXZlKGV2ZW50LCBjb250ZXh0KSB7DQogICAgICAgIHZhciBkYXRhS2V5ID0gdGhpcy5jb25zdHJ1Y3Rvci5EQVRBX0tFWTsNCiAgICAgICAgY29udGV4dCA9IGNvbnRleHQgfHwgJCQkMShldmVudC5jdXJyZW50VGFyZ2V0KS5kYXRhKGRhdGFLZXkpOw0KDQogICAgICAgIGlmICghY29udGV4dCkgew0KICAgICAgICAgIGNvbnRleHQgPSBuZXcgdGhpcy5jb25zdHJ1Y3RvcihldmVudC5jdXJyZW50VGFyZ2V0LCB0aGlzLl9nZXREZWxlZ2F0ZUNvbmZpZygpKTsNCiAgICAgICAgICAkJCQxKGV2ZW50LmN1cnJlbnRUYXJnZXQpLmRhdGEoZGF0YUtleSwgY29udGV4dCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoZXZlbnQpIHsNCiAgICAgICAgICBjb250ZXh0Ll9hY3RpdmVUcmlnZ2VyW2V2ZW50LnR5cGUgPT09ICdmb2N1c291dCcgPyBUcmlnZ2VyLkZPQ1VTIDogVHJpZ2dlci5IT1ZFUl0gPSBmYWxzZTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChjb250ZXh0Ll9pc1dpdGhBY3RpdmVUcmlnZ2VyKCkpIHsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICBjbGVhclRpbWVvdXQoY29udGV4dC5fdGltZW91dCk7DQogICAgICAgIGNvbnRleHQuX2hvdmVyU3RhdGUgPSBIb3ZlclN0YXRlLk9VVDsNCg0KICAgICAgICBpZiAoIWNvbnRleHQuY29uZmlnLmRlbGF5IHx8ICFjb250ZXh0LmNvbmZpZy5kZWxheS5oaWRlKSB7DQogICAgICAgICAgY29udGV4dC5oaWRlKCk7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgY29udGV4dC5fdGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgew0KICAgICAgICAgIGlmIChjb250ZXh0Ll9ob3ZlclN0YXRlID09PSBIb3ZlclN0YXRlLk9VVCkgew0KICAgICAgICAgICAgY29udGV4dC5oaWRlKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9LCBjb250ZXh0LmNvbmZpZy5kZWxheS5oaWRlKTsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5faXNXaXRoQWN0aXZlVHJpZ2dlciA9IGZ1bmN0aW9uIF9pc1dpdGhBY3RpdmVUcmlnZ2VyKCkgew0KICAgICAgICBmb3IgKHZhciB0cmlnZ2VyIGluIHRoaXMuX2FjdGl2ZVRyaWdnZXIpIHsNCiAgICAgICAgICBpZiAodGhpcy5fYWN0aXZlVHJpZ2dlclt0cmlnZ2VyXSkgew0KICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9nZXRDb25maWcgPSBmdW5jdGlvbiBfZ2V0Q29uZmlnKGNvbmZpZykgew0KICAgICAgICBjb25maWcgPSBfb2JqZWN0U3ByZWFkKHt9LCB0aGlzLmNvbnN0cnVjdG9yLkRlZmF1bHQsICQkJDEodGhpcy5lbGVtZW50KS5kYXRhKCksIHR5cGVvZiBjb25maWcgPT09ICdvYmplY3QnICYmIGNvbmZpZyA/IGNvbmZpZyA6IHt9KTsNCg0KICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy5kZWxheSA9PT0gJ251bWJlcicpIHsNCiAgICAgICAgICBjb25maWcuZGVsYXkgPSB7DQogICAgICAgICAgICBzaG93OiBjb25maWcuZGVsYXksDQogICAgICAgICAgICBoaWRlOiBjb25maWcuZGVsYXkNCiAgICAgICAgICB9Ow0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKHR5cGVvZiBjb25maWcudGl0bGUgPT09ICdudW1iZXInKSB7DQogICAgICAgICAgY29uZmlnLnRpdGxlID0gY29uZmlnLnRpdGxlLnRvU3RyaW5nKCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy5jb250ZW50ID09PSAnbnVtYmVyJykgew0KICAgICAgICAgIGNvbmZpZy5jb250ZW50ID0gY29uZmlnLmNvbnRlbnQudG9TdHJpbmcoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIFV0aWwudHlwZUNoZWNrQ29uZmlnKE5BTUUsIGNvbmZpZywgdGhpcy5jb25zdHJ1Y3Rvci5EZWZhdWx0VHlwZSk7DQogICAgICAgIHJldHVybiBjb25maWc7DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uX2dldERlbGVnYXRlQ29uZmlnID0gZnVuY3Rpb24gX2dldERlbGVnYXRlQ29uZmlnKCkgew0KICAgICAgICB2YXIgY29uZmlnID0ge307DQoNCiAgICAgICAgaWYgKHRoaXMuY29uZmlnKSB7DQogICAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuY29uZmlnKSB7DQogICAgICAgICAgICBpZiAodGhpcy5jb25zdHJ1Y3Rvci5EZWZhdWx0W2tleV0gIT09IHRoaXMuY29uZmlnW2tleV0pIHsNCiAgICAgICAgICAgICAgY29uZmlnW2tleV0gPSB0aGlzLmNvbmZpZ1trZXldOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiBjb25maWc7DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uX2NsZWFuVGlwQ2xhc3MgPSBmdW5jdGlvbiBfY2xlYW5UaXBDbGFzcygpIHsNCiAgICAgICAgdmFyICR0aXAgPSAkJCQxKHRoaXMuZ2V0VGlwRWxlbWVudCgpKTsNCiAgICAgICAgdmFyIHRhYkNsYXNzID0gJHRpcC5hdHRyKCdjbGFzcycpLm1hdGNoKEJTQ0xTX1BSRUZJWF9SRUdFWCk7DQoNCiAgICAgICAgaWYgKHRhYkNsYXNzICE9PSBudWxsICYmIHRhYkNsYXNzLmxlbmd0aCkgew0KICAgICAgICAgICR0aXAucmVtb3ZlQ2xhc3ModGFiQ2xhc3Muam9pbignJykpOw0KICAgICAgICB9DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uX2hhbmRsZVBvcHBlclBsYWNlbWVudENoYW5nZSA9IGZ1bmN0aW9uIF9oYW5kbGVQb3BwZXJQbGFjZW1lbnRDaGFuZ2UocG9wcGVyRGF0YSkgew0KICAgICAgICB2YXIgcG9wcGVySW5zdGFuY2UgPSBwb3BwZXJEYXRhLmluc3RhbmNlOw0KICAgICAgICB0aGlzLnRpcCA9IHBvcHBlckluc3RhbmNlLnBvcHBlcjsNCg0KICAgICAgICB0aGlzLl9jbGVhblRpcENsYXNzKCk7DQoNCiAgICAgICAgdGhpcy5hZGRBdHRhY2htZW50Q2xhc3ModGhpcy5fZ2V0QXR0YWNobWVudChwb3BwZXJEYXRhLnBsYWNlbWVudCkpOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9maXhUcmFuc2l0aW9uID0gZnVuY3Rpb24gX2ZpeFRyYW5zaXRpb24oKSB7DQogICAgICAgIHZhciB0aXAgPSB0aGlzLmdldFRpcEVsZW1lbnQoKTsNCiAgICAgICAgdmFyIGluaXRDb25maWdBbmltYXRpb24gPSB0aGlzLmNvbmZpZy5hbmltYXRpb247DQoNCiAgICAgICAgaWYgKHRpcC5nZXRBdHRyaWJ1dGUoJ3gtcGxhY2VtZW50JykgIT09IG51bGwpIHsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICAkJCQxKHRpcCkucmVtb3ZlQ2xhc3MoQ2xhc3NOYW1lLkZBREUpOw0KICAgICAgICB0aGlzLmNvbmZpZy5hbmltYXRpb24gPSBmYWxzZTsNCiAgICAgICAgdGhpcy5oaWRlKCk7DQogICAgICAgIHRoaXMuc2hvdygpOw0KICAgICAgICB0aGlzLmNvbmZpZy5hbmltYXRpb24gPSBpbml0Q29uZmlnQW5pbWF0aW9uOw0KICAgICAgfTsgLy8gU3RhdGljDQoNCg0KICAgICAgVG9vbHRpcC5falF1ZXJ5SW50ZXJmYWNlID0gZnVuY3Rpb24gX2pRdWVyeUludGVyZmFjZShjb25maWcpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7DQogICAgICAgICAgdmFyIGRhdGEgPSAkJCQxKHRoaXMpLmRhdGEoREFUQV9LRVkpOw0KDQogICAgICAgICAgdmFyIF9jb25maWcgPSB0eXBlb2YgY29uZmlnID09PSAnb2JqZWN0JyAmJiBjb25maWc7DQoNCiAgICAgICAgICBpZiAoIWRhdGEgJiYgL2Rpc3Bvc2V8aGlkZS8udGVzdChjb25maWcpKSB7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgfQ0KDQogICAgICAgICAgaWYgKCFkYXRhKSB7DQogICAgICAgICAgICBkYXRhID0gbmV3IFRvb2x0aXAodGhpcywgX2NvbmZpZyk7DQogICAgICAgICAgICAkJCQxKHRoaXMpLmRhdGEoREFUQV9LRVksIGRhdGEpOw0KICAgICAgICAgIH0NCg0KICAgICAgICAgIGlmICh0eXBlb2YgY29uZmlnID09PSAnc3RyaW5nJykgew0KICAgICAgICAgICAgaWYgKHR5cGVvZiBkYXRhW2NvbmZpZ10gPT09ICd1bmRlZmluZWQnKSB7DQogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIk5vIG1ldGhvZCBuYW1lZCBcIiIgKyBjb25maWcgKyAiXCIiKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgZGF0YVtjb25maWddKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgIH07DQoNCiAgICAgIF9jcmVhdGVDbGFzcyhUb29sdGlwLCBudWxsLCBbew0KICAgICAgICBrZXk6ICJWRVJTSU9OIiwNCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7DQogICAgICAgICAgcmV0dXJuIFZFUlNJT047DQogICAgICAgIH0NCiAgICAgIH0sIHsNCiAgICAgICAga2V5OiAiRGVmYXVsdCIsDQogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgew0KICAgICAgICAgIHJldHVybiBEZWZhdWx0Ow0KICAgICAgICB9DQogICAgICB9LCB7DQogICAgICAgIGtleTogIk5BTUUiLA0KICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsNCiAgICAgICAgICByZXR1cm4gTkFNRTsNCiAgICAgICAgfQ0KICAgICAgfSwgew0KICAgICAgICBrZXk6ICJEQVRBX0tFWSIsDQogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgew0KICAgICAgICAgIHJldHVybiBEQVRBX0tFWTsNCiAgICAgICAgfQ0KICAgICAgfSwgew0KICAgICAgICBrZXk6ICJFdmVudCIsDQogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgew0KICAgICAgICAgIHJldHVybiBFdmVudDsNCiAgICAgICAgfQ0KICAgICAgfSwgew0KICAgICAgICBrZXk6ICJFVkVOVF9LRVkiLA0KICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsNCiAgICAgICAgICByZXR1cm4gRVZFTlRfS0VZOw0KICAgICAgICB9DQogICAgICB9LCB7DQogICAgICAgIGtleTogIkRlZmF1bHRUeXBlIiwNCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7DQogICAgICAgICAgcmV0dXJuIERlZmF1bHRUeXBlOw0KICAgICAgICB9DQogICAgICB9XSk7DQoNCiAgICAgIHJldHVybiBUb29sdGlwOw0KICAgIH0oKTsNCiAgICAvKioNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKiBqUXVlcnkNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKi8NCg0KDQogICAgJCQkMS5mbltOQU1FXSA9IFRvb2x0aXAuX2pRdWVyeUludGVyZmFjZTsNCiAgICAkJCQxLmZuW05BTUVdLkNvbnN0cnVjdG9yID0gVG9vbHRpcDsNCg0KICAgICQkJDEuZm5bTkFNRV0ubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICQkJDEuZm5bTkFNRV0gPSBKUVVFUllfTk9fQ09ORkxJQ1Q7DQogICAgICByZXR1cm4gVG9vbHRpcC5falF1ZXJ5SW50ZXJmYWNlOw0KICAgIH07DQoNCiAgICByZXR1cm4gVG9vbHRpcDsNCiAgfSgkLCBQb3BwZXIpOw0KDQogIC8qKg0KICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgKiBCb290c3RyYXAgKHY0LjEuMyk6IHBvcG92ZXIuanMNCiAgICogTGljZW5zZWQgdW5kZXIgTUlUIChodHRwczovL2dpdGh1Yi5jb20vdHdicy9ib290c3RyYXAvYmxvYi9tYXN0ZXIvTElDRU5TRSkNCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICovDQoNCiAgdmFyIFBvcG92ZXIgPSBmdW5jdGlvbiAoJCQkMSkgew0KICAgIC8qKg0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqIENvbnN0YW50cw0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqLw0KICAgIHZhciBOQU1FID0gJ3BvcG92ZXInOw0KICAgIHZhciBWRVJTSU9OID0gJzQuMS4zJzsNCiAgICB2YXIgREFUQV9LRVkgPSAnYnMucG9wb3Zlcic7DQogICAgdmFyIEVWRU5UX0tFWSA9ICIuIiArIERBVEFfS0VZOw0KICAgIHZhciBKUVVFUllfTk9fQ09ORkxJQ1QgPSAkJCQxLmZuW05BTUVdOw0KICAgIHZhciBDTEFTU19QUkVGSVggPSAnYnMtcG9wb3Zlcic7DQogICAgdmFyIEJTQ0xTX1BSRUZJWF9SRUdFWCA9IG5ldyBSZWdFeHAoIihefFxccykiICsgQ0xBU1NfUFJFRklYICsgIlxcUysiLCAnZycpOw0KDQogICAgdmFyIERlZmF1bHQgPSBfb2JqZWN0U3ByZWFkKHt9LCBUb29sdGlwLkRlZmF1bHQsIHsNCiAgICAgIHBsYWNlbWVudDogJ3JpZ2h0JywNCiAgICAgIHRyaWdnZXI6ICdjbGljaycsDQogICAgICBjb250ZW50OiAnJywNCiAgICAgIHRlbXBsYXRlOiAnPGRpdiBjbGFzcz0icG9wb3ZlciIgcm9sZT0idG9vbHRpcCI+JyArICc8ZGl2IGNsYXNzPSJhcnJvdyI+PC9kaXY+JyArICc8aDMgY2xhc3M9InBvcG92ZXItaGVhZGVyIj48L2gzPicgKyAnPGRpdiBjbGFzcz0icG9wb3Zlci1ib2R5Ij48L2Rpdj48L2Rpdj4nDQogICAgfSk7DQoNCiAgICB2YXIgRGVmYXVsdFR5cGUgPSBfb2JqZWN0U3ByZWFkKHt9LCBUb29sdGlwLkRlZmF1bHRUeXBlLCB7DQogICAgICBjb250ZW50OiAnKHN0cmluZ3xlbGVtZW50fGZ1bmN0aW9uKScNCiAgICB9KTsNCg0KICAgIHZhciBDbGFzc05hbWUgPSB7DQogICAgICBGQURFOiAnZmFkZScsDQogICAgICBTSE9XOiAnc2hvdycNCiAgICB9Ow0KICAgIHZhciBTZWxlY3RvciA9IHsNCiAgICAgIFRJVExFOiAnLnBvcG92ZXItaGVhZGVyJywNCiAgICAgIENPTlRFTlQ6ICcucG9wb3Zlci1ib2R5Jw0KICAgIH07DQogICAgdmFyIEV2ZW50ID0gew0KICAgICAgSElERTogImhpZGUiICsgRVZFTlRfS0VZLA0KICAgICAgSElEREVOOiAiaGlkZGVuIiArIEVWRU5UX0tFWSwNCiAgICAgIFNIT1c6ICJzaG93IiArIEVWRU5UX0tFWSwNCiAgICAgIFNIT1dOOiAic2hvd24iICsgRVZFTlRfS0VZLA0KICAgICAgSU5TRVJURUQ6ICJpbnNlcnRlZCIgKyBFVkVOVF9LRVksDQogICAgICBDTElDSzogImNsaWNrIiArIEVWRU5UX0tFWSwNCiAgICAgIEZPQ1VTSU46ICJmb2N1c2luIiArIEVWRU5UX0tFWSwNCiAgICAgIEZPQ1VTT1VUOiAiZm9jdXNvdXQiICsgRVZFTlRfS0VZLA0KICAgICAgTU9VU0VFTlRFUjogIm1vdXNlZW50ZXIiICsgRVZFTlRfS0VZLA0KICAgICAgTU9VU0VMRUFWRTogIm1vdXNlbGVhdmUiICsgRVZFTlRfS0VZDQogICAgICAvKioNCiAgICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAgICogQ2xhc3MgRGVmaW5pdGlvbg0KICAgICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICAgKi8NCg0KICAgIH07DQoNCiAgICB2YXIgUG9wb3ZlciA9DQogICAgLyojX19QVVJFX18qLw0KICAgIGZ1bmN0aW9uIChfVG9vbHRpcCkgew0KICAgICAgX2luaGVyaXRzTG9vc2UoUG9wb3ZlciwgX1Rvb2x0aXApOw0KDQogICAgICBmdW5jdGlvbiBQb3BvdmVyKCkgew0KICAgICAgICByZXR1cm4gX1Rvb2x0aXAuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCB0aGlzOw0KICAgICAgfQ0KDQogICAgICB2YXIgX3Byb3RvID0gUG9wb3Zlci5wcm90b3R5cGU7DQoNCiAgICAgIC8vIE92ZXJyaWRlcw0KICAgICAgX3Byb3RvLmlzV2l0aENvbnRlbnQgPSBmdW5jdGlvbiBpc1dpdGhDb250ZW50KCkgew0KICAgICAgICByZXR1cm4gdGhpcy5nZXRUaXRsZSgpIHx8IHRoaXMuX2dldENvbnRlbnQoKTsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5hZGRBdHRhY2htZW50Q2xhc3MgPSBmdW5jdGlvbiBhZGRBdHRhY2htZW50Q2xhc3MoYXR0YWNobWVudCkgew0KICAgICAgICAkJCQxKHRoaXMuZ2V0VGlwRWxlbWVudCgpKS5hZGRDbGFzcyhDTEFTU19QUkVGSVggKyAiLSIgKyBhdHRhY2htZW50KTsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5nZXRUaXBFbGVtZW50ID0gZnVuY3Rpb24gZ2V0VGlwRWxlbWVudCgpIHsNCiAgICAgICAgdGhpcy50aXAgPSB0aGlzLnRpcCB8fCAkJCQxKHRoaXMuY29uZmlnLnRlbXBsYXRlKVswXTsNCiAgICAgICAgcmV0dXJuIHRoaXMudGlwOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLnNldENvbnRlbnQgPSBmdW5jdGlvbiBzZXRDb250ZW50KCkgew0KICAgICAgICB2YXIgJHRpcCA9ICQkJDEodGhpcy5nZXRUaXBFbGVtZW50KCkpOyAvLyBXZSB1c2UgYXBwZW5kIGZvciBodG1sIG9iamVjdHMgdG8gbWFpbnRhaW4ganMgZXZlbnRzDQoNCiAgICAgICAgdGhpcy5zZXRFbGVtZW50Q29udGVudCgkdGlwLmZpbmQoU2VsZWN0b3IuVElUTEUpLCB0aGlzLmdldFRpdGxlKCkpOw0KDQogICAgICAgIHZhciBjb250ZW50ID0gdGhpcy5fZ2V0Q29udGVudCgpOw0KDQogICAgICAgIGlmICh0eXBlb2YgY29udGVudCA9PT0gJ2Z1bmN0aW9uJykgew0KICAgICAgICAgIGNvbnRlbnQgPSBjb250ZW50LmNhbGwodGhpcy5lbGVtZW50KTsNCiAgICAgICAgfQ0KDQogICAgICAgIHRoaXMuc2V0RWxlbWVudENvbnRlbnQoJHRpcC5maW5kKFNlbGVjdG9yLkNPTlRFTlQpLCBjb250ZW50KTsNCiAgICAgICAgJHRpcC5yZW1vdmVDbGFzcyhDbGFzc05hbWUuRkFERSArICIgIiArIENsYXNzTmFtZS5TSE9XKTsNCiAgICAgIH07IC8vIFByaXZhdGUNCg0KDQogICAgICBfcHJvdG8uX2dldENvbnRlbnQgPSBmdW5jdGlvbiBfZ2V0Q29udGVudCgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2RhdGEtY29udGVudCcpIHx8IHRoaXMuY29uZmlnLmNvbnRlbnQ7DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uX2NsZWFuVGlwQ2xhc3MgPSBmdW5jdGlvbiBfY2xlYW5UaXBDbGFzcygpIHsNCiAgICAgICAgdmFyICR0aXAgPSAkJCQxKHRoaXMuZ2V0VGlwRWxlbWVudCgpKTsNCiAgICAgICAgdmFyIHRhYkNsYXNzID0gJHRpcC5hdHRyKCdjbGFzcycpLm1hdGNoKEJTQ0xTX1BSRUZJWF9SRUdFWCk7DQoNCiAgICAgICAgaWYgKHRhYkNsYXNzICE9PSBudWxsICYmIHRhYkNsYXNzLmxlbmd0aCA+IDApIHsNCiAgICAgICAgICAkdGlwLnJlbW92ZUNsYXNzKHRhYkNsYXNzLmpvaW4oJycpKTsNCiAgICAgICAgfQ0KICAgICAgfTsgLy8gU3RhdGljDQoNCg0KICAgICAgUG9wb3Zlci5falF1ZXJ5SW50ZXJmYWNlID0gZnVuY3Rpb24gX2pRdWVyeUludGVyZmFjZShjb25maWcpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7DQogICAgICAgICAgdmFyIGRhdGEgPSAkJCQxKHRoaXMpLmRhdGEoREFUQV9LRVkpOw0KDQogICAgICAgICAgdmFyIF9jb25maWcgPSB0eXBlb2YgY29uZmlnID09PSAnb2JqZWN0JyA/IGNvbmZpZyA6IG51bGw7DQoNCiAgICAgICAgICBpZiAoIWRhdGEgJiYgL2Rlc3Ryb3l8aGlkZS8udGVzdChjb25maWcpKSB7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgfQ0KDQogICAgICAgICAgaWYgKCFkYXRhKSB7DQogICAgICAgICAgICBkYXRhID0gbmV3IFBvcG92ZXIodGhpcywgX2NvbmZpZyk7DQogICAgICAgICAgICAkJCQxKHRoaXMpLmRhdGEoREFUQV9LRVksIGRhdGEpOw0KICAgICAgICAgIH0NCg0KICAgICAgICAgIGlmICh0eXBlb2YgY29uZmlnID09PSAnc3RyaW5nJykgew0KICAgICAgICAgICAgaWYgKHR5cGVvZiBkYXRhW2NvbmZpZ10gPT09ICd1bmRlZmluZWQnKSB7DQogICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIk5vIG1ldGhvZCBuYW1lZCBcIiIgKyBjb25maWcgKyAiXCIiKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgZGF0YVtjb25maWddKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICAgIH07DQoNCiAgICAgIF9jcmVhdGVDbGFzcyhQb3BvdmVyLCBudWxsLCBbew0KICAgICAgICBrZXk6ICJWRVJTSU9OIiwNCiAgICAgICAgLy8gR2V0dGVycw0KICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsNCiAgICAgICAgICByZXR1cm4gVkVSU0lPTjsNCiAgICAgICAgfQ0KICAgICAgfSwgew0KICAgICAgICBrZXk6ICJEZWZhdWx0IiwNCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7DQogICAgICAgICAgcmV0dXJuIERlZmF1bHQ7DQogICAgICAgIH0NCiAgICAgIH0sIHsNCiAgICAgICAga2V5OiAiTkFNRSIsDQogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgew0KICAgICAgICAgIHJldHVybiBOQU1FOw0KICAgICAgICB9DQogICAgICB9LCB7DQogICAgICAgIGtleTogIkRBVEFfS0VZIiwNCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7DQogICAgICAgICAgcmV0dXJuIERBVEFfS0VZOw0KICAgICAgICB9DQogICAgICB9LCB7DQogICAgICAgIGtleTogIkV2ZW50IiwNCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7DQogICAgICAgICAgcmV0dXJuIEV2ZW50Ow0KICAgICAgICB9DQogICAgICB9LCB7DQogICAgICAgIGtleTogIkVWRU5UX0tFWSIsDQogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgew0KICAgICAgICAgIHJldHVybiBFVkVOVF9LRVk7DQogICAgICAgIH0NCiAgICAgIH0sIHsNCiAgICAgICAga2V5OiAiRGVmYXVsdFR5cGUiLA0KICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsNCiAgICAgICAgICByZXR1cm4gRGVmYXVsdFR5cGU7DQogICAgICAgIH0NCiAgICAgIH1dKTsNCg0KICAgICAgcmV0dXJuIFBvcG92ZXI7DQogICAgfShUb29sdGlwKTsNCiAgICAvKioNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKiBqUXVlcnkNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKi8NCg0KDQogICAgJCQkMS5mbltOQU1FXSA9IFBvcG92ZXIuX2pRdWVyeUludGVyZmFjZTsNCiAgICAkJCQxLmZuW05BTUVdLkNvbnN0cnVjdG9yID0gUG9wb3ZlcjsNCg0KICAgICQkJDEuZm5bTkFNRV0ubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICQkJDEuZm5bTkFNRV0gPSBKUVVFUllfTk9fQ09ORkxJQ1Q7DQogICAgICByZXR1cm4gUG9wb3Zlci5falF1ZXJ5SW50ZXJmYWNlOw0KICAgIH07DQoNCiAgICByZXR1cm4gUG9wb3ZlcjsNCiAgfSgkKTsNCg0KICAvKioNCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICogQm9vdHN0cmFwICh2NC4xLjMpOiBzY3JvbGxzcHkuanMNCiAgICogTGljZW5zZWQgdW5kZXIgTUlUIChodHRwczovL2dpdGh1Yi5jb20vdHdicy9ib290c3RyYXAvYmxvYi9tYXN0ZXIvTElDRU5TRSkNCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICovDQoNCiAgdmFyIFNjcm9sbFNweSA9IGZ1bmN0aW9uICgkJCQxKSB7DQogICAgLyoqDQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICogQ29uc3RhbnRzDQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICovDQogICAgdmFyIE5BTUUgPSAnc2Nyb2xsc3B5JzsNCiAgICB2YXIgVkVSU0lPTiA9ICc0LjEuMyc7DQogICAgdmFyIERBVEFfS0VZID0gJ2JzLnNjcm9sbHNweSc7DQogICAgdmFyIEVWRU5UX0tFWSA9ICIuIiArIERBVEFfS0VZOw0KICAgIHZhciBEQVRBX0FQSV9LRVkgPSAnLmRhdGEtYXBpJzsNCiAgICB2YXIgSlFVRVJZX05PX0NPTkZMSUNUID0gJCQkMS5mbltOQU1FXTsNCiAgICB2YXIgRGVmYXVsdCA9IHsNCiAgICAgIG9mZnNldDogMTAsDQogICAgICBtZXRob2Q6ICdhdXRvJywNCiAgICAgIHRhcmdldDogJycNCiAgICB9Ow0KICAgIHZhciBEZWZhdWx0VHlwZSA9IHsNCiAgICAgIG9mZnNldDogJ251bWJlcicsDQogICAgICBtZXRob2Q6ICdzdHJpbmcnLA0KICAgICAgdGFyZ2V0OiAnKHN0cmluZ3xlbGVtZW50KScNCiAgICB9Ow0KICAgIHZhciBFdmVudCA9IHsNCiAgICAgIEFDVElWQVRFOiAiYWN0aXZhdGUiICsgRVZFTlRfS0VZLA0KICAgICAgU0NST0xMOiAic2Nyb2xsIiArIEVWRU5UX0tFWSwNCiAgICAgIExPQURfREFUQV9BUEk6ICJsb2FkIiArIEVWRU5UX0tFWSArIERBVEFfQVBJX0tFWQ0KICAgIH07DQogICAgdmFyIENsYXNzTmFtZSA9IHsNCiAgICAgIERST1BET1dOX0lURU06ICdkcm9wZG93bi1pdGVtJywNCiAgICAgIERST1BET1dOX01FTlU6ICdkcm9wZG93bi1tZW51JywNCiAgICAgIEFDVElWRTogJ2FjdGl2ZScNCiAgICB9Ow0KICAgIHZhciBTZWxlY3RvciA9IHsNCiAgICAgIERBVEFfU1BZOiAnW2RhdGEtc3B5PSJzY3JvbGwiXScsDQogICAgICBBQ1RJVkU6ICcuYWN0aXZlJywNCiAgICAgIE5BVl9MSVNUX0dST1VQOiAnLm5hdiwgLmxpc3QtZ3JvdXAnLA0KICAgICAgTkFWX0xJTktTOiAnLm5hdi1saW5rJywNCiAgICAgIE5BVl9JVEVNUzogJy5uYXYtaXRlbScsDQogICAgICBMSVNUX0lURU1TOiAnLmxpc3QtZ3JvdXAtaXRlbScsDQogICAgICBEUk9QRE9XTjogJy5kcm9wZG93bicsDQogICAgICBEUk9QRE9XTl9JVEVNUzogJy5kcm9wZG93bi1pdGVtJywNCiAgICAgIERST1BET1dOX1RPR0dMRTogJy5kcm9wZG93bi10b2dnbGUnDQogICAgfTsNCiAgICB2YXIgT2Zmc2V0TWV0aG9kID0gew0KICAgICAgT0ZGU0VUOiAnb2Zmc2V0JywNCiAgICAgIFBPU0lUSU9OOiAncG9zaXRpb24nDQogICAgICAvKioNCiAgICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAgICogQ2xhc3MgRGVmaW5pdGlvbg0KICAgICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICAgKi8NCg0KICAgIH07DQoNCiAgICB2YXIgU2Nyb2xsU3B5ID0NCiAgICAvKiNfX1BVUkVfXyovDQogICAgZnVuY3Rpb24gKCkgew0KICAgICAgZnVuY3Rpb24gU2Nyb2xsU3B5KGVsZW1lbnQsIGNvbmZpZykgew0KICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOw0KDQogICAgICAgIHRoaXMuX2VsZW1lbnQgPSBlbGVtZW50Ow0KICAgICAgICB0aGlzLl9zY3JvbGxFbGVtZW50ID0gZWxlbWVudC50YWdOYW1lID09PSAnQk9EWScgPyB3aW5kb3cgOiBlbGVtZW50Ow0KICAgICAgICB0aGlzLl9jb25maWcgPSB0aGlzLl9nZXRDb25maWcoY29uZmlnKTsNCiAgICAgICAgdGhpcy5fc2VsZWN0b3IgPSB0aGlzLl9jb25maWcudGFyZ2V0ICsgIiAiICsgU2VsZWN0b3IuTkFWX0xJTktTICsgIiwiICsgKHRoaXMuX2NvbmZpZy50YXJnZXQgKyAiICIgKyBTZWxlY3Rvci5MSVNUX0lURU1TICsgIiwiKSArICh0aGlzLl9jb25maWcudGFyZ2V0ICsgIiAiICsgU2VsZWN0b3IuRFJPUERPV05fSVRFTVMpOw0KICAgICAgICB0aGlzLl9vZmZzZXRzID0gW107DQogICAgICAgIHRoaXMuX3RhcmdldHMgPSBbXTsNCiAgICAgICAgdGhpcy5fYWN0aXZlVGFyZ2V0ID0gbnVsbDsNCiAgICAgICAgdGhpcy5fc2Nyb2xsSGVpZ2h0ID0gMDsNCiAgICAgICAgJCQkMSh0aGlzLl9zY3JvbGxFbGVtZW50KS5vbihFdmVudC5TQ1JPTEwsIGZ1bmN0aW9uIChldmVudCkgew0KICAgICAgICAgIHJldHVybiBfdGhpcy5fcHJvY2VzcyhldmVudCk7DQogICAgICAgIH0pOw0KICAgICAgICB0aGlzLnJlZnJlc2goKTsNCg0KICAgICAgICB0aGlzLl9wcm9jZXNzKCk7DQogICAgICB9IC8vIEdldHRlcnMNCg0KDQogICAgICB2YXIgX3Byb3RvID0gU2Nyb2xsU3B5LnByb3RvdHlwZTsNCg0KICAgICAgLy8gUHVibGljDQogICAgICBfcHJvdG8ucmVmcmVzaCA9IGZ1bmN0aW9uIHJlZnJlc2goKSB7DQogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOw0KDQogICAgICAgIHZhciBhdXRvTWV0aG9kID0gdGhpcy5fc2Nyb2xsRWxlbWVudCA9PT0gdGhpcy5fc2Nyb2xsRWxlbWVudC53aW5kb3cgPyBPZmZzZXRNZXRob2QuT0ZGU0VUIDogT2Zmc2V0TWV0aG9kLlBPU0lUSU9OOw0KICAgICAgICB2YXIgb2Zmc2V0TWV0aG9kID0gdGhpcy5fY29uZmlnLm1ldGhvZCA9PT0gJ2F1dG8nID8gYXV0b01ldGhvZCA6IHRoaXMuX2NvbmZpZy5tZXRob2Q7DQogICAgICAgIHZhciBvZmZzZXRCYXNlID0gb2Zmc2V0TWV0aG9kID09PSBPZmZzZXRNZXRob2QuUE9TSVRJT04gPyB0aGlzLl9nZXRTY3JvbGxUb3AoKSA6IDA7DQogICAgICAgIHRoaXMuX29mZnNldHMgPSBbXTsNCiAgICAgICAgdGhpcy5fdGFyZ2V0cyA9IFtdOw0KICAgICAgICB0aGlzLl9zY3JvbGxIZWlnaHQgPSB0aGlzLl9nZXRTY3JvbGxIZWlnaHQoKTsNCiAgICAgICAgdmFyIHRhcmdldHMgPSBbXS5zbGljZS5jYWxsKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwodGhpcy5fc2VsZWN0b3IpKTsNCiAgICAgICAgdGFyZ2V0cy5tYXAoZnVuY3Rpb24gKGVsZW1lbnQpIHsNCiAgICAgICAgICB2YXIgdGFyZ2V0Ow0KICAgICAgICAgIHZhciB0YXJnZXRTZWxlY3RvciA9IFV0aWwuZ2V0U2VsZWN0b3JGcm9tRWxlbWVudChlbGVtZW50KTsNCg0KICAgICAgICAgIGlmICh0YXJnZXRTZWxlY3Rvcikgew0KICAgICAgICAgICAgdGFyZ2V0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcih0YXJnZXRTZWxlY3Rvcik7DQogICAgICAgICAgfQ0KDQogICAgICAgICAgaWYgKHRhcmdldCkgew0KICAgICAgICAgICAgdmFyIHRhcmdldEJDUiA9IHRhcmdldC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsNCg0KICAgICAgICAgICAgaWYgKHRhcmdldEJDUi53aWR0aCB8fCB0YXJnZXRCQ1IuaGVpZ2h0KSB7DQogICAgICAgICAgICAgIC8vIFRPRE8gKGZhdCk6IHJlbW92ZSBza2V0Y2ggcmVsaWFuY2Ugb24galF1ZXJ5IHBvc2l0aW9uL29mZnNldA0KICAgICAgICAgICAgICByZXR1cm4gWyQkJDEodGFyZ2V0KVtvZmZzZXRNZXRob2RdKCkudG9wICsgb2Zmc2V0QmFzZSwgdGFyZ2V0U2VsZWN0b3JdOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCg0KICAgICAgICAgIHJldHVybiBudWxsOw0KICAgICAgICB9KS5maWx0ZXIoZnVuY3Rpb24gKGl0ZW0pIHsNCiAgICAgICAgICByZXR1cm4gaXRlbTsNCiAgICAgICAgfSkuc29ydChmdW5jdGlvbiAoYSwgYikgew0KICAgICAgICAgIHJldHVybiBhWzBdIC0gYlswXTsNCiAgICAgICAgfSkuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgew0KICAgICAgICAgIF90aGlzMi5fb2Zmc2V0cy5wdXNoKGl0ZW1bMF0pOw0KDQogICAgICAgICAgX3RoaXMyLl90YXJnZXRzLnB1c2goaXRlbVsxXSk7DQogICAgICAgIH0pOw0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLmRpc3Bvc2UgPSBmdW5jdGlvbiBkaXNwb3NlKCkgew0KICAgICAgICAkJCQxLnJlbW92ZURhdGEodGhpcy5fZWxlbWVudCwgREFUQV9LRVkpOw0KICAgICAgICAkJCQxKHRoaXMuX3Njcm9sbEVsZW1lbnQpLm9mZihFVkVOVF9LRVkpOw0KICAgICAgICB0aGlzLl9lbGVtZW50ID0gbnVsbDsNCiAgICAgICAgdGhpcy5fc2Nyb2xsRWxlbWVudCA9IG51bGw7DQogICAgICAgIHRoaXMuX2NvbmZpZyA9IG51bGw7DQogICAgICAgIHRoaXMuX3NlbGVjdG9yID0gbnVsbDsNCiAgICAgICAgdGhpcy5fb2Zmc2V0cyA9IG51bGw7DQogICAgICAgIHRoaXMuX3RhcmdldHMgPSBudWxsOw0KICAgICAgICB0aGlzLl9hY3RpdmVUYXJnZXQgPSBudWxsOw0KICAgICAgICB0aGlzLl9zY3JvbGxIZWlnaHQgPSBudWxsOw0KICAgICAgfTsgLy8gUHJpdmF0ZQ0KDQoNCiAgICAgIF9wcm90by5fZ2V0Q29uZmlnID0gZnVuY3Rpb24gX2dldENvbmZpZyhjb25maWcpIHsNCiAgICAgICAgY29uZmlnID0gX29iamVjdFNwcmVhZCh7fSwgRGVmYXVsdCwgdHlwZW9mIGNvbmZpZyA9PT0gJ29iamVjdCcgJiYgY29uZmlnID8gY29uZmlnIDoge30pOw0KDQogICAgICAgIGlmICh0eXBlb2YgY29uZmlnLnRhcmdldCAhPT0gJ3N0cmluZycpIHsNCiAgICAgICAgICB2YXIgaWQgPSAkJCQxKGNvbmZpZy50YXJnZXQpLmF0dHIoJ2lkJyk7DQoNCiAgICAgICAgICBpZiAoIWlkKSB7DQogICAgICAgICAgICBpZCA9IFV0aWwuZ2V0VUlEKE5BTUUpOw0KICAgICAgICAgICAgJCQkMShjb25maWcudGFyZ2V0KS5hdHRyKCdpZCcsIGlkKTsNCiAgICAgICAgICB9DQoNCiAgICAgICAgICBjb25maWcudGFyZ2V0ID0gIiMiICsgaWQ7DQogICAgICAgIH0NCg0KICAgICAgICBVdGlsLnR5cGVDaGVja0NvbmZpZyhOQU1FLCBjb25maWcsIERlZmF1bHRUeXBlKTsNCiAgICAgICAgcmV0dXJuIGNvbmZpZzsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5fZ2V0U2Nyb2xsVG9wID0gZnVuY3Rpb24gX2dldFNjcm9sbFRvcCgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuX3Njcm9sbEVsZW1lbnQgPT09IHdpbmRvdyA/IHRoaXMuX3Njcm9sbEVsZW1lbnQucGFnZVlPZmZzZXQgOiB0aGlzLl9zY3JvbGxFbGVtZW50LnNjcm9sbFRvcDsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5fZ2V0U2Nyb2xsSGVpZ2h0ID0gZnVuY3Rpb24gX2dldFNjcm9sbEhlaWdodCgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuX3Njcm9sbEVsZW1lbnQuc2Nyb2xsSGVpZ2h0IHx8IE1hdGgubWF4KGRvY3VtZW50LmJvZHkuc2Nyb2xsSGVpZ2h0LCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsSGVpZ2h0KTsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5fZ2V0T2Zmc2V0SGVpZ2h0ID0gZnVuY3Rpb24gX2dldE9mZnNldEhlaWdodCgpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuX3Njcm9sbEVsZW1lbnQgPT09IHdpbmRvdyA/IHdpbmRvdy5pbm5lckhlaWdodCA6IHRoaXMuX3Njcm9sbEVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuaGVpZ2h0Ow0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9wcm9jZXNzID0gZnVuY3Rpb24gX3Byb2Nlc3MoKSB7DQogICAgICAgIHZhciBzY3JvbGxUb3AgPSB0aGlzLl9nZXRTY3JvbGxUb3AoKSArIHRoaXMuX2NvbmZpZy5vZmZzZXQ7DQoNCiAgICAgICAgdmFyIHNjcm9sbEhlaWdodCA9IHRoaXMuX2dldFNjcm9sbEhlaWdodCgpOw0KDQogICAgICAgIHZhciBtYXhTY3JvbGwgPSB0aGlzLl9jb25maWcub2Zmc2V0ICsgc2Nyb2xsSGVpZ2h0IC0gdGhpcy5fZ2V0T2Zmc2V0SGVpZ2h0KCk7DQoNCiAgICAgICAgaWYgKHRoaXMuX3Njcm9sbEhlaWdodCAhPT0gc2Nyb2xsSGVpZ2h0KSB7DQogICAgICAgICAgdGhpcy5yZWZyZXNoKCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoc2Nyb2xsVG9wID49IG1heFNjcm9sbCkgew0KICAgICAgICAgIHZhciB0YXJnZXQgPSB0aGlzLl90YXJnZXRzW3RoaXMuX3RhcmdldHMubGVuZ3RoIC0gMV07DQoNCiAgICAgICAgICBpZiAodGhpcy5fYWN0aXZlVGFyZ2V0ICE9PSB0YXJnZXQpIHsNCiAgICAgICAgICAgIHRoaXMuX2FjdGl2YXRlKHRhcmdldCk7DQogICAgICAgICAgfQ0KDQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKHRoaXMuX2FjdGl2ZVRhcmdldCAmJiBzY3JvbGxUb3AgPCB0aGlzLl9vZmZzZXRzWzBdICYmIHRoaXMuX29mZnNldHNbMF0gPiAwKSB7DQogICAgICAgICAgdGhpcy5fYWN0aXZlVGFyZ2V0ID0gbnVsbDsNCg0KICAgICAgICAgIHRoaXMuX2NsZWFyKCk7DQoNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICB2YXIgb2Zmc2V0TGVuZ3RoID0gdGhpcy5fb2Zmc2V0cy5sZW5ndGg7DQoNCiAgICAgICAgZm9yICh2YXIgaSA9IG9mZnNldExlbmd0aDsgaS0tOykgew0KICAgICAgICAgIHZhciBpc0FjdGl2ZVRhcmdldCA9IHRoaXMuX2FjdGl2ZVRhcmdldCAhPT0gdGhpcy5fdGFyZ2V0c1tpXSAmJiBzY3JvbGxUb3AgPj0gdGhpcy5fb2Zmc2V0c1tpXSAmJiAodHlwZW9mIHRoaXMuX29mZnNldHNbaSArIDFdID09PSAndW5kZWZpbmVkJyB8fCBzY3JvbGxUb3AgPCB0aGlzLl9vZmZzZXRzW2kgKyAxXSk7DQoNCiAgICAgICAgICBpZiAoaXNBY3RpdmVUYXJnZXQpIHsNCiAgICAgICAgICAgIHRoaXMuX2FjdGl2YXRlKHRoaXMuX3RhcmdldHNbaV0pOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLl9hY3RpdmF0ZSA9IGZ1bmN0aW9uIF9hY3RpdmF0ZSh0YXJnZXQpIHsNCiAgICAgICAgdGhpcy5fYWN0aXZlVGFyZ2V0ID0gdGFyZ2V0Ow0KDQogICAgICAgIHRoaXMuX2NsZWFyKCk7DQoNCiAgICAgICAgdmFyIHF1ZXJpZXMgPSB0aGlzLl9zZWxlY3Rvci5zcGxpdCgnLCcpOyAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgYXJyb3ctYm9keS1zdHlsZQ0KDQoNCiAgICAgICAgcXVlcmllcyA9IHF1ZXJpZXMubWFwKGZ1bmN0aW9uIChzZWxlY3Rvcikgew0KICAgICAgICAgIHJldHVybiBzZWxlY3RvciArICJbZGF0YS10YXJnZXQ9XCIiICsgdGFyZ2V0ICsgIlwiXSwiICsgKHNlbGVjdG9yICsgIltocmVmPVwiIiArIHRhcmdldCArICJcIl0iKTsNCiAgICAgICAgfSk7DQogICAgICAgIHZhciAkbGluayA9ICQkJDEoW10uc2xpY2UuY2FsbChkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHF1ZXJpZXMuam9pbignLCcpKSkpOw0KDQogICAgICAgIGlmICgkbGluay5oYXNDbGFzcyhDbGFzc05hbWUuRFJPUERPV05fSVRFTSkpIHsNCiAgICAgICAgICAkbGluay5jbG9zZXN0KFNlbGVjdG9yLkRST1BET1dOKS5maW5kKFNlbGVjdG9yLkRST1BET1dOX1RPR0dMRSkuYWRkQ2xhc3MoQ2xhc3NOYW1lLkFDVElWRSk7DQogICAgICAgICAgJGxpbmsuYWRkQ2xhc3MoQ2xhc3NOYW1lLkFDVElWRSk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgLy8gU2V0IHRyaWdnZXJlZCBsaW5rIGFzIGFjdGl2ZQ0KICAgICAgICAgICRsaW5rLmFkZENsYXNzKENsYXNzTmFtZS5BQ1RJVkUpOyAvLyBTZXQgdHJpZ2dlcmVkIGxpbmtzIHBhcmVudHMgYXMgYWN0aXZlDQogICAgICAgICAgLy8gV2l0aCBib3RoIDx1bD4gYW5kIDxuYXY+IG1hcmt1cCBhIHBhcmVudCBpcyB0aGUgcHJldmlvdXMgc2libGluZyBvZiBhbnkgbmF2IGFuY2VzdG9yDQoNCiAgICAgICAgICAkbGluay5wYXJlbnRzKFNlbGVjdG9yLk5BVl9MSVNUX0dST1VQKS5wcmV2KFNlbGVjdG9yLk5BVl9MSU5LUyArICIsICIgKyBTZWxlY3Rvci5MSVNUX0lURU1TKS5hZGRDbGFzcyhDbGFzc05hbWUuQUNUSVZFKTsgLy8gSGFuZGxlIHNwZWNpYWwgY2FzZSB3aGVuIC5uYXYtbGluayBpcyBpbnNpZGUgLm5hdi1pdGVtDQoNCiAgICAgICAgICAkbGluay5wYXJlbnRzKFNlbGVjdG9yLk5BVl9MSVNUX0dST1VQKS5wcmV2KFNlbGVjdG9yLk5BVl9JVEVNUykuY2hpbGRyZW4oU2VsZWN0b3IuTkFWX0xJTktTKS5hZGRDbGFzcyhDbGFzc05hbWUuQUNUSVZFKTsNCiAgICAgICAgfQ0KDQogICAgICAgICQkJDEodGhpcy5fc2Nyb2xsRWxlbWVudCkudHJpZ2dlcihFdmVudC5BQ1RJVkFURSwgew0KICAgICAgICAgIHJlbGF0ZWRUYXJnZXQ6IHRhcmdldA0KICAgICAgICB9KTsNCiAgICAgIH07DQoNCiAgICAgIF9wcm90by5fY2xlYXIgPSBmdW5jdGlvbiBfY2xlYXIoKSB7DQogICAgICAgIHZhciBub2RlcyA9IFtdLnNsaWNlLmNhbGwoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCh0aGlzLl9zZWxlY3RvcikpOw0KICAgICAgICAkJCQxKG5vZGVzKS5maWx0ZXIoU2VsZWN0b3IuQUNUSVZFKS5yZW1vdmVDbGFzcyhDbGFzc05hbWUuQUNUSVZFKTsNCiAgICAgIH07IC8vIFN0YXRpYw0KDQoNCiAgICAgIFNjcm9sbFNweS5falF1ZXJ5SW50ZXJmYWNlID0gZnVuY3Rpb24gX2pRdWVyeUludGVyZmFjZShjb25maWcpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7DQogICAgICAgICAgdmFyIGRhdGEgPSAkJCQxKHRoaXMpLmRhdGEoREFUQV9LRVkpOw0KDQogICAgICAgICAgdmFyIF9jb25maWcgPSB0eXBlb2YgY29uZmlnID09PSAnb2JqZWN0JyAmJiBjb25maWc7DQoNCiAgICAgICAgICBpZiAoIWRhdGEpIHsNCiAgICAgICAgICAgIGRhdGEgPSBuZXcgU2Nyb2xsU3B5KHRoaXMsIF9jb25maWcpOw0KICAgICAgICAgICAgJCQkMSh0aGlzKS5kYXRhKERBVEFfS0VZLCBkYXRhKTsNCiAgICAgICAgICB9DQoNCiAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gJ3N0cmluZycpIHsNCiAgICAgICAgICAgIGlmICh0eXBlb2YgZGF0YVtjb25maWddID09PSAndW5kZWZpbmVkJykgew0KICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJObyBtZXRob2QgbmFtZWQgXCIiICsgY29uZmlnICsgIlwiIik7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGRhdGFbY29uZmlnXSgpOw0KICAgICAgICAgIH0NCiAgICAgICAgfSk7DQogICAgICB9Ow0KDQogICAgICBfY3JlYXRlQ2xhc3MoU2Nyb2xsU3B5LCBudWxsLCBbew0KICAgICAgICBrZXk6ICJWRVJTSU9OIiwNCiAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7DQogICAgICAgICAgcmV0dXJuIFZFUlNJT047DQogICAgICAgIH0NCiAgICAgIH0sIHsNCiAgICAgICAga2V5OiAiRGVmYXVsdCIsDQogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgew0KICAgICAgICAgIHJldHVybiBEZWZhdWx0Ow0KICAgICAgICB9DQogICAgICB9XSk7DQoNCiAgICAgIHJldHVybiBTY3JvbGxTcHk7DQogICAgfSgpOw0KICAgIC8qKg0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqIERhdGEgQXBpIGltcGxlbWVudGF0aW9uDQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICovDQoNCg0KICAgICQkJDEod2luZG93KS5vbihFdmVudC5MT0FEX0RBVEFfQVBJLCBmdW5jdGlvbiAoKSB7DQogICAgICB2YXIgc2Nyb2xsU3B5cyA9IFtdLnNsaWNlLmNhbGwoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChTZWxlY3Rvci5EQVRBX1NQWSkpOw0KICAgICAgdmFyIHNjcm9sbFNweXNMZW5ndGggPSBzY3JvbGxTcHlzLmxlbmd0aDsNCg0KICAgICAgZm9yICh2YXIgaSA9IHNjcm9sbFNweXNMZW5ndGg7IGktLTspIHsNCiAgICAgICAgdmFyICRzcHkgPSAkJCQxKHNjcm9sbFNweXNbaV0pOw0KDQogICAgICAgIFNjcm9sbFNweS5falF1ZXJ5SW50ZXJmYWNlLmNhbGwoJHNweSwgJHNweS5kYXRhKCkpOw0KICAgICAgfQ0KICAgIH0pOw0KICAgIC8qKg0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqIGpRdWVyeQ0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqLw0KDQogICAgJCQkMS5mbltOQU1FXSA9IFNjcm9sbFNweS5falF1ZXJ5SW50ZXJmYWNlOw0KICAgICQkJDEuZm5bTkFNRV0uQ29uc3RydWN0b3IgPSBTY3JvbGxTcHk7DQoNCiAgICAkJCQxLmZuW05BTUVdLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiAoKSB7DQogICAgICAkJCQxLmZuW05BTUVdID0gSlFVRVJZX05PX0NPTkZMSUNUOw0KICAgICAgcmV0dXJuIFNjcm9sbFNweS5falF1ZXJ5SW50ZXJmYWNlOw0KICAgIH07DQoNCiAgICByZXR1cm4gU2Nyb2xsU3B5Ow0KICB9KCQpOw0KDQogIC8qKg0KICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgKiBCb290c3RyYXAgKHY0LjEuMyk6IHRhYi5qcw0KICAgKiBMaWNlbnNlZCB1bmRlciBNSVQgKGh0dHBzOi8vZ2l0aHViLmNvbS90d2JzL2Jvb3RzdHJhcC9ibG9iL21hc3Rlci9MSUNFTlNFKQ0KICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgKi8NCg0KICB2YXIgVGFiID0gZnVuY3Rpb24gKCQkJDEpIHsNCiAgICAvKioNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKiBDb25zdGFudHMNCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICAgKi8NCiAgICB2YXIgTkFNRSA9ICd0YWInOw0KICAgIHZhciBWRVJTSU9OID0gJzQuMS4zJzsNCiAgICB2YXIgREFUQV9LRVkgPSAnYnMudGFiJzsNCiAgICB2YXIgRVZFTlRfS0VZID0gIi4iICsgREFUQV9LRVk7DQogICAgdmFyIERBVEFfQVBJX0tFWSA9ICcuZGF0YS1hcGknOw0KICAgIHZhciBKUVVFUllfTk9fQ09ORkxJQ1QgPSAkJCQxLmZuW05BTUVdOw0KICAgIHZhciBFdmVudCA9IHsNCiAgICAgIEhJREU6ICJoaWRlIiArIEVWRU5UX0tFWSwNCiAgICAgIEhJRERFTjogImhpZGRlbiIgKyBFVkVOVF9LRVksDQogICAgICBTSE9XOiAic2hvdyIgKyBFVkVOVF9LRVksDQogICAgICBTSE9XTjogInNob3duIiArIEVWRU5UX0tFWSwNCiAgICAgIENMSUNLX0RBVEFfQVBJOiAiY2xpY2siICsgRVZFTlRfS0VZICsgREFUQV9BUElfS0VZDQogICAgfTsNCiAgICB2YXIgQ2xhc3NOYW1lID0gew0KICAgICAgRFJPUERPV05fTUVOVTogJ2Ryb3Bkb3duLW1lbnUnLA0KICAgICAgQUNUSVZFOiAnYWN0aXZlJywNCiAgICAgIERJU0FCTEVEOiAnZGlzYWJsZWQnLA0KICAgICAgRkFERTogJ2ZhZGUnLA0KICAgICAgU0hPVzogJ3Nob3cnDQogICAgfTsNCiAgICB2YXIgU2VsZWN0b3IgPSB7DQogICAgICBEUk9QRE9XTjogJy5kcm9wZG93bicsDQogICAgICBOQVZfTElTVF9HUk9VUDogJy5uYXYsIC5saXN0LWdyb3VwJywNCiAgICAgIEFDVElWRTogJy5hY3RpdmUnLA0KICAgICAgQUNUSVZFX1VMOiAnPiBsaSA+IC5hY3RpdmUnLA0KICAgICAgREFUQV9UT0dHTEU6ICdbZGF0YS10b2dnbGU9InRhYiJdLCBbZGF0YS10b2dnbGU9InBpbGwiXSwgW2RhdGEtdG9nZ2xlPSJsaXN0Il0nLA0KICAgICAgRFJPUERPV05fVE9HR0xFOiAnLmRyb3Bkb3duLXRvZ2dsZScsDQogICAgICBEUk9QRE9XTl9BQ1RJVkVfQ0hJTEQ6ICc+IC5kcm9wZG93bi1tZW51IC5hY3RpdmUnDQogICAgICAvKioNCiAgICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAgICogQ2xhc3MgRGVmaW5pdGlvbg0KICAgICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICAgKi8NCg0KICAgIH07DQoNCiAgICB2YXIgVGFiID0NCiAgICAvKiNfX1BVUkVfXyovDQogICAgZnVuY3Rpb24gKCkgew0KICAgICAgZnVuY3Rpb24gVGFiKGVsZW1lbnQpIHsNCiAgICAgICAgdGhpcy5fZWxlbWVudCA9IGVsZW1lbnQ7DQogICAgICB9IC8vIEdldHRlcnMNCg0KDQogICAgICB2YXIgX3Byb3RvID0gVGFiLnByb3RvdHlwZTsNCg0KICAgICAgLy8gUHVibGljDQogICAgICBfcHJvdG8uc2hvdyA9IGZ1bmN0aW9uIHNob3coKSB7DQogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7DQoNCiAgICAgICAgaWYgKHRoaXMuX2VsZW1lbnQucGFyZW50Tm9kZSAmJiB0aGlzLl9lbGVtZW50LnBhcmVudE5vZGUubm9kZVR5cGUgPT09IE5vZGUuRUxFTUVOVF9OT0RFICYmICQkJDEodGhpcy5fZWxlbWVudCkuaGFzQ2xhc3MoQ2xhc3NOYW1lLkFDVElWRSkgfHwgJCQkMSh0aGlzLl9lbGVtZW50KS5oYXNDbGFzcyhDbGFzc05hbWUuRElTQUJMRUQpKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgdmFyIHRhcmdldDsNCiAgICAgICAgdmFyIHByZXZpb3VzOw0KICAgICAgICB2YXIgbGlzdEVsZW1lbnQgPSAkJCQxKHRoaXMuX2VsZW1lbnQpLmNsb3Nlc3QoU2VsZWN0b3IuTkFWX0xJU1RfR1JPVVApWzBdOw0KICAgICAgICB2YXIgc2VsZWN0b3IgPSBVdGlsLmdldFNlbGVjdG9yRnJvbUVsZW1lbnQodGhpcy5fZWxlbWVudCk7DQoNCiAgICAgICAgaWYgKGxpc3RFbGVtZW50KSB7DQogICAgICAgICAgdmFyIGl0ZW1TZWxlY3RvciA9IGxpc3RFbGVtZW50Lm5vZGVOYW1lID09PSAnVUwnID8gU2VsZWN0b3IuQUNUSVZFX1VMIDogU2VsZWN0b3IuQUNUSVZFOw0KICAgICAgICAgIHByZXZpb3VzID0gJCQkMS5tYWtlQXJyYXkoJCQkMShsaXN0RWxlbWVudCkuZmluZChpdGVtU2VsZWN0b3IpKTsNCiAgICAgICAgICBwcmV2aW91cyA9IHByZXZpb3VzW3ByZXZpb3VzLmxlbmd0aCAtIDFdOw0KICAgICAgICB9DQoNCiAgICAgICAgdmFyIGhpZGVFdmVudCA9ICQkJDEuRXZlbnQoRXZlbnQuSElERSwgew0KICAgICAgICAgIHJlbGF0ZWRUYXJnZXQ6IHRoaXMuX2VsZW1lbnQNCiAgICAgICAgfSk7DQogICAgICAgIHZhciBzaG93RXZlbnQgPSAkJCQxLkV2ZW50KEV2ZW50LlNIT1csIHsNCiAgICAgICAgICByZWxhdGVkVGFyZ2V0OiBwcmV2aW91cw0KICAgICAgICB9KTsNCg0KICAgICAgICBpZiAocHJldmlvdXMpIHsNCiAgICAgICAgICAkJCQxKHByZXZpb3VzKS50cmlnZ2VyKGhpZGVFdmVudCk7DQogICAgICAgIH0NCg0KICAgICAgICAkJCQxKHRoaXMuX2VsZW1lbnQpLnRyaWdnZXIoc2hvd0V2ZW50KTsNCg0KICAgICAgICBpZiAoc2hvd0V2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8IGhpZGVFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChzZWxlY3Rvcikgew0KICAgICAgICAgIHRhcmdldCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpOw0KICAgICAgICB9DQoNCiAgICAgICAgdGhpcy5fYWN0aXZhdGUodGhpcy5fZWxlbWVudCwgbGlzdEVsZW1lbnQpOw0KDQogICAgICAgIHZhciBjb21wbGV0ZSA9IGZ1bmN0aW9uIGNvbXBsZXRlKCkgew0KICAgICAgICAgIHZhciBoaWRkZW5FdmVudCA9ICQkJDEuRXZlbnQoRXZlbnQuSElEREVOLCB7DQogICAgICAgICAgICByZWxhdGVkVGFyZ2V0OiBfdGhpcy5fZWxlbWVudA0KICAgICAgICAgIH0pOw0KICAgICAgICAgIHZhciBzaG93bkV2ZW50ID0gJCQkMS5FdmVudChFdmVudC5TSE9XTiwgew0KICAgICAgICAgICAgcmVsYXRlZFRhcmdldDogcHJldmlvdXMNCiAgICAgICAgICB9KTsNCiAgICAgICAgICAkJCQxKHByZXZpb3VzKS50cmlnZ2VyKGhpZGRlbkV2ZW50KTsNCiAgICAgICAgICAkJCQxKF90aGlzLl9lbGVtZW50KS50cmlnZ2VyKHNob3duRXZlbnQpOw0KICAgICAgICB9Ow0KDQogICAgICAgIGlmICh0YXJnZXQpIHsNCiAgICAgICAgICB0aGlzLl9hY3RpdmF0ZSh0YXJnZXQsIHRhcmdldC5wYXJlbnROb2RlLCBjb21wbGV0ZSk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgY29tcGxldGUoKTsNCiAgICAgICAgfQ0KICAgICAgfTsNCg0KICAgICAgX3Byb3RvLmRpc3Bvc2UgPSBmdW5jdGlvbiBkaXNwb3NlKCkgew0KICAgICAgICAkJCQxLnJlbW92ZURhdGEodGhpcy5fZWxlbWVudCwgREFUQV9LRVkpOw0KICAgICAgICB0aGlzLl9lbGVtZW50ID0gbnVsbDsNCiAgICAgIH07IC8vIFByaXZhdGUNCg0KDQogICAgICBfcHJvdG8uX2FjdGl2YXRlID0gZnVuY3Rpb24gX2FjdGl2YXRlKGVsZW1lbnQsIGNvbnRhaW5lciwgY2FsbGJhY2spIHsNCiAgICAgICAgdmFyIF90aGlzMiA9IHRoaXM7DQoNCiAgICAgICAgdmFyIGFjdGl2ZUVsZW1lbnRzOw0KDQogICAgICAgIGlmIChjb250YWluZXIubm9kZU5hbWUgPT09ICdVTCcpIHsNCiAgICAgICAgICBhY3RpdmVFbGVtZW50cyA9ICQkJDEoY29udGFpbmVyKS5maW5kKFNlbGVjdG9yLkFDVElWRV9VTCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgYWN0aXZlRWxlbWVudHMgPSAkJCQxKGNvbnRhaW5lcikuY2hpbGRyZW4oU2VsZWN0b3IuQUNUSVZFKTsNCiAgICAgICAgfQ0KDQogICAgICAgIHZhciBhY3RpdmUgPSBhY3RpdmVFbGVtZW50c1swXTsNCiAgICAgICAgdmFyIGlzVHJhbnNpdGlvbmluZyA9IGNhbGxiYWNrICYmIGFjdGl2ZSAmJiAkJCQxKGFjdGl2ZSkuaGFzQ2xhc3MoQ2xhc3NOYW1lLkZBREUpOw0KDQogICAgICAgIHZhciBjb21wbGV0ZSA9IGZ1bmN0aW9uIGNvbXBsZXRlKCkgew0KICAgICAgICAgIHJldHVybiBfdGhpczIuX3RyYW5zaXRpb25Db21wbGV0ZShlbGVtZW50LCBhY3RpdmUsIGNhbGxiYWNrKTsNCiAgICAgICAgfTsNCg0KICAgICAgICBpZiAoYWN0aXZlICYmIGlzVHJhbnNpdGlvbmluZykgew0KICAgICAgICAgIHZhciB0cmFuc2l0aW9uRHVyYXRpb24gPSBVdGlsLmdldFRyYW5zaXRpb25EdXJhdGlvbkZyb21FbGVtZW50KGFjdGl2ZSk7DQogICAgICAgICAgJCQkMShhY3RpdmUpLm9uZShVdGlsLlRSQU5TSVRJT05fRU5ELCBjb21wbGV0ZSkuZW11bGF0ZVRyYW5zaXRpb25FbmQodHJhbnNpdGlvbkR1cmF0aW9uKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBjb21wbGV0ZSgpOw0KICAgICAgICB9DQogICAgICB9Ow0KDQogICAgICBfcHJvdG8uX3RyYW5zaXRpb25Db21wbGV0ZSA9IGZ1bmN0aW9uIF90cmFuc2l0aW9uQ29tcGxldGUoZWxlbWVudCwgYWN0aXZlLCBjYWxsYmFjaykgew0KICAgICAgICBpZiAoYWN0aXZlKSB7DQogICAgICAgICAgJCQkMShhY3RpdmUpLnJlbW92ZUNsYXNzKENsYXNzTmFtZS5TSE9XICsgIiAiICsgQ2xhc3NOYW1lLkFDVElWRSk7DQogICAgICAgICAgdmFyIGRyb3Bkb3duQ2hpbGQgPSAkJCQxKGFjdGl2ZS5wYXJlbnROb2RlKS5maW5kKFNlbGVjdG9yLkRST1BET1dOX0FDVElWRV9DSElMRClbMF07DQoNCiAgICAgICAgICBpZiAoZHJvcGRvd25DaGlsZCkgew0KICAgICAgICAgICAgJCQkMShkcm9wZG93bkNoaWxkKS5yZW1vdmVDbGFzcyhDbGFzc05hbWUuQUNUSVZFKTsNCiAgICAgICAgICB9DQoNCiAgICAgICAgICBpZiAoYWN0aXZlLmdldEF0dHJpYnV0ZSgncm9sZScpID09PSAndGFiJykgew0KICAgICAgICAgICAgYWN0aXZlLnNldEF0dHJpYnV0ZSgnYXJpYS1zZWxlY3RlZCcsIGZhbHNlKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICAkJCQxKGVsZW1lbnQpLmFkZENsYXNzKENsYXNzTmFtZS5BQ1RJVkUpOw0KDQogICAgICAgIGlmIChlbGVtZW50LmdldEF0dHJpYnV0ZSgncm9sZScpID09PSAndGFiJykgew0KICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdhcmlhLXNlbGVjdGVkJywgdHJ1ZSk7DQogICAgICAgIH0NCg0KICAgICAgICBVdGlsLnJlZmxvdyhlbGVtZW50KTsNCiAgICAgICAgJCQkMShlbGVtZW50KS5hZGRDbGFzcyhDbGFzc05hbWUuU0hPVyk7DQoNCiAgICAgICAgaWYgKGVsZW1lbnQucGFyZW50Tm9kZSAmJiAkJCQxKGVsZW1lbnQucGFyZW50Tm9kZSkuaGFzQ2xhc3MoQ2xhc3NOYW1lLkRST1BET1dOX01FTlUpKSB7DQogICAgICAgICAgdmFyIGRyb3Bkb3duRWxlbWVudCA9ICQkJDEoZWxlbWVudCkuY2xvc2VzdChTZWxlY3Rvci5EUk9QRE9XTilbMF07DQoNCiAgICAgICAgICBpZiAoZHJvcGRvd25FbGVtZW50KSB7DQogICAgICAgICAgICB2YXIgZHJvcGRvd25Ub2dnbGVMaXN0ID0gW10uc2xpY2UuY2FsbChkcm9wZG93bkVsZW1lbnQucXVlcnlTZWxlY3RvckFsbChTZWxlY3Rvci5EUk9QRE9XTl9UT0dHTEUpKTsNCiAgICAgICAgICAgICQkJDEoZHJvcGRvd25Ub2dnbGVMaXN0KS5hZGRDbGFzcyhDbGFzc05hbWUuQUNUSVZFKTsNCiAgICAgICAgICB9DQoNCiAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgnYXJpYS1leHBhbmRlZCcsIHRydWUpOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKGNhbGxiYWNrKSB7DQogICAgICAgICAgY2FsbGJhY2soKTsNCiAgICAgICAgfQ0KICAgICAgfTsgLy8gU3RhdGljDQoNCg0KICAgICAgVGFiLl9qUXVlcnlJbnRlcmZhY2UgPSBmdW5jdGlvbiBfalF1ZXJ5SW50ZXJmYWNlKGNvbmZpZykgew0KICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICB2YXIgJHRoaXMgPSAkJCQxKHRoaXMpOw0KICAgICAgICAgIHZhciBkYXRhID0gJHRoaXMuZGF0YShEQVRBX0tFWSk7DQoNCiAgICAgICAgICBpZiAoIWRhdGEpIHsNCiAgICAgICAgICAgIGRhdGEgPSBuZXcgVGFiKHRoaXMpOw0KICAgICAgICAgICAgJHRoaXMuZGF0YShEQVRBX0tFWSwgZGF0YSk7DQogICAgICAgICAgfQ0KDQogICAgICAgICAgaWYgKHR5cGVvZiBjb25maWcgPT09ICdzdHJpbmcnKSB7DQogICAgICAgICAgICBpZiAodHlwZW9mIGRhdGFbY29uZmlnXSA9PT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiTm8gbWV0aG9kIG5hbWVkIFwiIiArIGNvbmZpZyArICJcIiIpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBkYXRhW2NvbmZpZ10oKTsNCiAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgICAgfTsNCg0KICAgICAgX2NyZWF0ZUNsYXNzKFRhYiwgbnVsbCwgW3sNCiAgICAgICAga2V5OiAiVkVSU0lPTiIsDQogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgew0KICAgICAgICAgIHJldHVybiBWRVJTSU9OOw0KICAgICAgICB9DQogICAgICB9XSk7DQoNCiAgICAgIHJldHVybiBUYWI7DQogICAgfSgpOw0KICAgIC8qKg0KICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KICAgICAqIERhdGEgQXBpIGltcGxlbWVudGF0aW9uDQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICovDQoNCg0KICAgICQkJDEoZG9jdW1lbnQpLm9uKEV2ZW50LkNMSUNLX0RBVEFfQVBJLCBTZWxlY3Rvci5EQVRBX1RPR0dMRSwgZnVuY3Rpb24gKGV2ZW50KSB7DQogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KDQogICAgICBUYWIuX2pRdWVyeUludGVyZmFjZS5jYWxsKCQkJDEodGhpcyksICdzaG93Jyk7DQogICAgfSk7DQogICAgLyoqDQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICogalF1ZXJ5DQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAgICovDQoNCiAgICAkJCQxLmZuW05BTUVdID0gVGFiLl9qUXVlcnlJbnRlcmZhY2U7DQogICAgJCQkMS5mbltOQU1FXS5Db25zdHJ1Y3RvciA9IFRhYjsNCg0KICAgICQkJDEuZm5bTkFNRV0ubm9Db25mbGljdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICQkJDEuZm5bTkFNRV0gPSBKUVVFUllfTk9fQ09ORkxJQ1Q7DQogICAgICByZXR1cm4gVGFiLl9qUXVlcnlJbnRlcmZhY2U7DQogICAgfTsNCg0KICAgIHJldHVybiBUYWI7DQogIH0oJCk7DQoNCiAgLyoqDQogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQogICAqIEJvb3RzdHJhcCAodjQuMS4zKTogaW5kZXguanMNCiAgICogTGljZW5zZWQgdW5kZXIgTUlUIChodHRwczovL2dpdGh1Yi5jb20vdHdicy9ib290c3RyYXAvYmxvYi9tYXN0ZXIvTElDRU5TRSkNCiAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCiAgICovDQoNCiAgKGZ1bmN0aW9uICgkJCQxKSB7DQogICAgaWYgKHR5cGVvZiAkJCQxID09PSAndW5kZWZpbmVkJykgew0KICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQm9vdHN0cmFwXCdzIEphdmFTY3JpcHQgcmVxdWlyZXMgalF1ZXJ5LiBqUXVlcnkgbXVzdCBiZSBpbmNsdWRlZCBiZWZvcmUgQm9vdHN0cmFwXCdzIEphdmFTY3JpcHQuJyk7DQogICAgfQ0KDQogICAgdmFyIHZlcnNpb24gPSAkJCQxLmZuLmpxdWVyeS5zcGxpdCgnICcpWzBdLnNwbGl0KCcuJyk7DQogICAgdmFyIG1pbk1ham9yID0gMTsNCiAgICB2YXIgbHRNYWpvciA9IDI7DQogICAgdmFyIG1pbk1pbm9yID0gOTsNCiAgICB2YXIgbWluUGF0Y2ggPSAxOw0KICAgIHZhciBtYXhNYWpvciA9IDQ7DQoNCiAgICBpZiAodmVyc2lvblswXSA8IGx0TWFqb3IgJiYgdmVyc2lvblsxXSA8IG1pbk1pbm9yIHx8IHZlcnNpb25bMF0gPT09IG1pbk1ham9yICYmIHZlcnNpb25bMV0gPT09IG1pbk1pbm9yICYmIHZlcnNpb25bMl0gPCBtaW5QYXRjaCB8fCB2ZXJzaW9uWzBdID49IG1heE1ham9yKSB7DQogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Jvb3RzdHJhcFwncyBKYXZhU2NyaXB0IHJlcXVpcmVzIGF0IGxlYXN0IGpRdWVyeSB2MS45LjEgYnV0IGxlc3MgdGhhbiB2NC4wLjAnKTsNCiAgICB9DQogIH0pKCQpOw0KDQogIGV4cG9ydHMuVXRpbCA9IFV0aWw7DQogIGV4cG9ydHMuQWxlcnQgPSBBbGVydDsNCiAgZXhwb3J0cy5CdXR0b24gPSBCdXR0b247DQogIGV4cG9ydHMuQ2Fyb3VzZWwgPSBDYXJvdXNlbDsNCiAgZXhwb3J0cy5Db2xsYXBzZSA9IENvbGxhcHNlOw0KICBleHBvcnRzLkRyb3Bkb3duID0gRHJvcGRvd247DQogIGV4cG9ydHMuTW9kYWwgPSBNb2RhbDsNCiAgZXhwb3J0cy5Qb3BvdmVyID0gUG9wb3ZlcjsNCiAgZXhwb3J0cy5TY3JvbGxzcHkgPSBTY3JvbGxTcHk7DQogIGV4cG9ydHMuVGFiID0gVGFiOw0KICBleHBvcnRzLlRvb2x0aXAgPSBUb29sdGlwOw0KDQogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsgdmFsdWU6IHRydWUgfSk7DQoNCn0pKSk7DQovLyMgc291cmNlTWFwcGluZ1VSTD1ib290c3RyYXAuanMubWFwDQo=";
            var bytes = Convert.FromBase64String(s);
            return File(bytes, "text/javascript");
        }
    }
}